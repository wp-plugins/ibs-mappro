function KML(){this.options={name:null,desc:null,url:null,position:null,draggable:!1,visible:!1,strokeColor:"#0000ff",strokeWeight:3,strokeOpacity:.5,path:[]};this.file=this.kml=null}
(function(b){KML.prototype.writer=function(b){function k(a){for(var b=0;b<c.length;b++)if(a.color===c[b].color&&a.width===c[b].width)return"#"+c[b].id;a.id="LineStyle-"+padLeftStr(c.length+1,3,"0");c.push(a);return"#"+a.id}function g(a){for(var b=0;b<f.length;b++)if(a.icon===f[b].icon)return"#"+f[b].id;a.id="IconStyle-"+padLeftStr(f.length+1,3,"0");f.push(a);return"#"+a.id}var c=[],f=[],l=b.listSegments(),m=b.listPlacemarks(),e;for(e in b.segments){var h=b.segments[e],n=colorKML(h.options.strokeOpacity,
h.options.strokeColor);h.options.style=k({color:n,width:h.options.strokeWeight.toString()})}for(var a in b.placemarks)h=b.placemarks[a],h.options.style=g({icon:h.marker.icon.url});a=new XMLWriter("UTF-8","1.0");a.writeStartDocument();a.writeStartElement("kml");a.writeAttributeString("xmlns","http://www.opengis.net/kml/2.2");a.writeStartElement("Document");a.writeStartElement("name");a.writeCDATA(b.options.name);a.writeEndElement();a.writeElementString("open","1");a.writeStartElement("description");
a.writeCDATA(b.options.desc);a.writeEndElement();for(e=0;e<f.length;e++)a.writeStartElement("Style"),a.writeAttributeString("id",f[e].id),a.writeStartElement("IconStyle"),a.writeStartElement("Icon"),a.writeElementString("href",f[e].icon),a.writeEndElement(),a.writeEndElement(),a.writeEndElement();for(e=0;e<c.length;e++)a.writeStartElement("Style"),a.writeAttributeString("id",c[e].id),a.writeStartElement("LineStyle"),a.writeElementString("color",c[e].color),a.writeElementString("width",c[e].width),
a.writeEndElement(),a.writeStartElement("PolyStyle"),a.writeElementString("color",c[e].color),a.writeEndElement(),a.writeEndElement();a.writeStartElement("Folder");a.writeElementString("name","Placemarks");a.writeElementString("description","placemarks");for(e=0;e<m.length;e++){var h=b.placemarks[m[e]],n=h.options.position.lat().toString(),q=h.options.position.lng().toString();a.writeStartElement("Placemark");a.writeStartElement("name");a.writeCDATA(h.options.name);a.writeEndElement();a.writeStartElement("description");
a.writeCDATA(h.options.desc);a.writeEndElement();a.writeElementString("styleUrl",h.options.style);a.writeStartElement("Point");a.writeElementString("coordinates",q+","+n+",0");a.writeEndElement();a.writeEndElement()}a.writeEndElement();a.writeStartElement("Folder");a.writeElementString("name","segments");a.writeElementString("description","segment lines");for(e=0;e<l.length;e++){var h=b.segments[l[e]],p="";h.line.getPath().forEach(function(a){p+=a.lng().toString()+","+a.lat().toString()+",0.00000 \n"});
a.writeStartElement("Placemark");a.writeStartElement("name");a.writeCDATA(h.options.name);a.writeEndElement();a.writeStartElement("description");a.writeCDATA(h.options.desc);a.writeEndElement();a.writeElementString("styleUrl",h.options.style);a.writeStartElement("LineString");a.writeElementString("altitudeMode","clampToGround");a.writeElementString("coordinates",p);a.writeEndElement();a.writeEndElement()}a.writeEndElement();a.writeEndElement();a.writeEndElement();a.writeEndDocument();return a.flush()};
KML.prototype.getLineStyle=function(d){var k=b(d).find("color").text();d=b(d).find("width").text();var g=k.substr(0,2),c=k.substr(2,2),f=k.substr(4,2),k=k.substr(6,2);this.options.strokeColor="#"+k+f+c;this.options.strokeOpacity=parseInt(g,16)/256;this.options.strokeWeight=parseInt(d)};KML.prototype.getStyle=function(d){b(d).find("styleUrl").each(b.proxy(function(d,g){var c=b(g).text().substr(1);b(this.kml).find("Style[id="+c+"]").each(b.proxy(function(c,d){b(d).find("LineStyle").each(b.proxy(function(b,
c){this.getLineStyle(c)},this));b(d).find("IconStyle").each(b.proxy(function(c,d){this.options.url=b(d).find("href:first").text()},this))},this))},this));b(d).children("Style").each(b.proxy(function(d,g){b(g).children("LineStyle").each(b.proxy(function(b,d){this.getLineStyle(d)},this));b(g).children("IconStyle").each(b.proxy(function(c,d){this.options.url=b(d).find("href:first").text()},this))},this))};KML.prototype.getLineString=function(d){b(d).children("LineString").each(b.proxy(function(d,g){this.options.path=
[];for(var c=b(g).children("coordinates").text(),c=c.replace(/\n/g," "),c=b.trim(c);0<c.indexOf("  ");)c=c.replace(/  /g," ");for(var c=c.split(" "),f=0;f<c.length;f++){var l=c[f].split(","),m=parseFloat(l[0]),l=parseFloat(l[1]);this.options.path.push(new google.maps.LatLng(l,m))}0<this.options.path.length&&this.file._addSegment(this.options)},this))};KML.prototype.getPoint=function(d){b(d).children("Point").each(b.proxy(function(d,g){var c=b(g).children("coordinates").text(),c=b.trim(c),f=c.split(","),
c=parseFloat(f[0]),f=parseFloat(f[1]);this.options.position=new google.maps.LatLng(f,c);this.options.name&&this.file._addPlacemark(this.options)},this))};KML.prototype.getDocument=function(d){"Track Points"!==getCDATA(b(d).contents("name").text())&&(this.file.options.name=getCDATA(b(d).contents("name").text()),this.file.options.desc=getCDATA(b(d).contents("description").text()),b(d).children("Placemark").each(b.proxy(function(d,g){this.options.name=getCDATA(b(g).children("name").text());this.options.desc=
getCDATA(b(g).children("description").text());this.getStyle(g);this.getLineString(g);this.getPoint(g)},this)),b(d).children("Folder").each(b.proxy(function(b,d){this.getDocument(d)},this)))};KML.prototype.reader=function(d,k){this.file=k;b(d).children("kml").each(b.proxy(function(d,c){this.kml=c;b(this.kml).children("Document").each(b.proxy(function(b,c){this.getDocument(c)},this));b(this.kml).children("Folder").each(b.proxy(function(b,c){this.getDocument(c)},this))},this))};KML.prototype.kmlWindow=
function(b){window.open("","KML Export "+(new Date).getTime(),"width=800,height=1000").document.write('<textarea id="kml" style="width: 100%; height: 100%">'+b+"</textarea>")}})(jQuery);
