function GPX(){this.init()}
(function(d){GPX.prototype.init=function(){var k=[{x:0,y:0,z:0,label:"Black"},{x:140,y:0,z:26,label:"DarkRed"},{x:37,y:65,z:23,label:"DarkGreen"},{x:255,y:243,z:128,label:"DarkYellow"},{x:21,y:27,z:84,label:"DarkBlue"},{x:227,y:49,z:157,label:"DarkMagenta"},{x:207,y:236,z:236,label:"DarkCyan"},{x:188,y:198,z:204,label:"LightGray"},{x:80,y:74,z:75,label:"DarkGray"},{x:255,y:0,z:0,label:"Red"},{x:0,y:128,z:0,label:"Green"},{x:255,y:255,z:0,label:"Yellow"},{x:0,y:0,z:255,label:"Blue"},{x:255,y:0,z:255,
label:"Magenta"},{x:0,y:255,z:255,label:"Cyan"},{x:255,y:255,z:255,label:"White"}];gpxColor=function(c){c=d("<div>").css("color",c).css("color");var g=c.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);c=g?"#"+hex(g[1])+hex(g[2])+hex(g[3]):c;c=c.replace("#","");c=parseInt(c,16);var g={x:Math.floor(c/65536%256),y:Math.floor(c/256%256),z:Math.floor(c%256)},e=Infinity;c=-1;for(var f=0,b=0;b<k.length;++b){var a=k[b],h=g,f=Math.abs(a.x-h.x),l=Math.abs(a.y-h.y),a=Math.abs(a.z-h.z),f=Math.sqrt(f*f+l*l+a*a);f<e&&
(e=f,c=b)}if(0>c||c>k.length-1)c=0;g=k[c];g="#"+padLeftStr((65536*g.x+256*g.y+g.z).toString(16),6,"0");return{name:k[c].label,value:g}}};GPX.prototype.writer=function(d){var c=d.listPlacemarks(),g=d.listSegments(),e=new google.maps.LatLngBounds;d.getBounds(e);var f=e.getNorthEast(),b=e.getSouthWest(),e=(new Date).toISOString(),a=new XMLWriter("UTF-8","1.0");a.writeStartDocument();a.writeStartElement("gpx");a.writeAttributeString("xmlns","http://www.topografix.com/GPX/1/1");a.writeAttributeString("creator",
"Indian Bend Solutions LLC");a.writeAttributeString("version","1.0");a.writeAttributeString("xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance");a.writeAttributeString("xsi:schemaLocation","http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd");a.writeStartElement("metadata");a.writeStartElement("link");a.writeAttributeString("href","http://www.garmin.com");a.writeElementString("text","Garmin International");a.writeEndElement();a.writeElementString("time",e);a.writeStartElement("bounds");
a.writeAttributeString("maxlat",b.lat().toString());a.writeAttributeString("maxlon",b.lng().toString());a.writeAttributeString("minlat",f.lat().toString());a.writeAttributeString("minlon",f.lng().toString());a.writeEndElement();a.writeEndElement();if(d.options.gpx_waypoints)for(f=0;f<c.length;f++)b=d.placemarks[c[f]],"Waypoint"===b.options.symbol&&(a.writeStartElement("wpt"),a.writeAttributeString("lat",b.options.position.lat().toString()),a.writeAttributeString("lon",b.options.position.lng().toString()),
a.writeElementString("time",e),a.writeStartElement("name"),a.writeCDATA(b.options.name),a.writeEndElement(),a.writeStartElement("cmt"),a.writeCDATA(b.options.desc),a.writeEndElement(),a.writeStartElement("desc"),a.writeCDATA(b.options.desc),a.writeEndElement(),a.writeElementString("sym",b.options.symbol),a.writeStartElement("extensions"),a.writeStartElement("gpxx:WaypointExtension"),a.writeAttributeString("xmlns:gpxx","http://www.garmin.com/xmlschemas/GpxExtensions/v3"),a.writeElementString("gpxx:DisplayMode",
"SymbolAndName"),a.writeEndElement(),a.writeEndElement(),a.writeEndElement());if(d.options.gpx_placemarks)for(f=0;f<c.length;f++)b=d.placemarks[c[f]],"Waypoint"!==b.options.symbol&&(a.writeStartElement("wpt"),a.writeAttributeString("lat",b.options.position.lat().toString()),a.writeAttributeString("lon",b.options.position.lng().toString()),a.writeElementString("time",e),a.writeStartElement("name"),a.writeCDATA(b.options.name),a.writeEndElement(),a.writeStartElement("cmt"),a.writeCDATA(b.options.desc),
a.writeEndElement(),a.writeStartElement("desc"),a.writeCDATA(b.options.desc),a.writeEndElement(),a.writeElementString("sym",b.options.symbol),a.writeStartElement("extensions"),a.writeStartElement("gpxx:WaypointExtension"),a.writeAttributeString("xmlns:gpxx","http://www.garmin.com/xmlschemas/GpxExtensions/v3"),a.writeElementString("gpxx:DisplayMode","SymbolAndName"),a.writeEndElement(),a.writeEndElement(),a.writeEndElement());if(d.options.gpx_routes)for(f=0;f<g.length;f++){b=d.segments[g[f]];a.writeStartElement("rte");
a.writeStartElement("name");a.writeCDATA(b.options.name);a.writeEndElement();a.writeStartElement("desc");a.writeCDATA(b.options.desc);a.writeEndElement();a.writeStartElement("extensions");a.writeStartElement("gpxx:RouteExtension");a.writeAttributeString("xmlns:gpxx","http://www.garmin.com/xmlschemas/GpxExtensions/v3");a.writeElementString("gpxx:IsAutoNamed","false");a.writeElementString("gpxx:DisplayColor",gpxColor(b.options.strokeColor).name);a.writeEndElement();a.writeEndElement();c=b.line.getPath().getArray();
e=b.findWaypoints();(0===e.length||0!==e[0].index)&&0<c.length&&(b.waypoint(0),e=b.findWaypoints());for(var h=0;h<e.length;h++){b=d.placemarks[e[h].pid];a.writeStartElement("rtept");a.writeAttributeString("lat",e[h].latlng.lat().toString());a.writeAttributeString("lon",e[h].latlng.lng().toString());a.writeStartElement("name");a.writeCDATA(b.options.name);a.writeEndElement();a.writeStartElement("cmt");a.writeCDATA(b.options.desc);a.writeEndElement();a.writeStartElement("desc");a.writeCDATA(b.options.desc);
a.writeEndElement();a.writeElementString("sym","Waypoint");a.writeStartElement("extensions");a.writeStartElement("gpxx:RoutePointExtension");a.writeAttributeString("xmlns:gpxx","http://www.garmin.com/xmlschemas/GpxExtensions/v3");a.writeElementString("gpxx:Subclass","000000000000FFFFFFFFFFFFFFFFFFFFFFFF");for(var b=h<e.length-1?e[h+1].index:c.length-1,l=e[h].index+1;l<b;l++)a.writeStartElement("gpxx:rpt"),a.writeAttributeString("lat",c[l].lat().toString()),a.writeAttributeString("lon",c[l].lng().toString()),
a.writeEndElement();a.writeEndElement();a.writeEndElement();a.writeEndElement()}a.writeEndElement()}if(d.options.gpx_waypoints){a.writeStartElement("trk");for(var m in d.segments)b=d.segments[m],a.writeStartElement("trkseg"),a.writeStartElement("extensions"),a.writeStartElement("gpxx:TrackExtension"),a.writeAttributeString("xmlns:gpxx","http://www.garmin.com/xmlschemas/GpxExtensions/v3"),a.writeElementString("gpxx:DisplayColor",gpxColor(b.options.strokeColor).name),a.writeEndElement(),a.writeEndElement(),
a.writeStartElement("name"),a.writeCDATA(b.options.name),a.writeEndElement(),a.writeStartElement("desc"),a.writeCDATA(b.options.desc),a.writeEndElement(),b.line.getPath().forEach(function(b){a.writeStartElement("trkpt");a.writeAttributeString("lat",b.lat().toString());a.writeAttributeString("lon",b.lng().toString());a.writeEndElement()}),a.writeEndElement();a.writeEndElement()}a.writeEndElement();a.writeEndDocument();return a.flush()};GPX.prototype.reader=function(k,c){d(k).children("gpx").each(d.proxy(function(g,
e){c.options.desc=d(e).attr("creator");d(e).children("wpt").each(d.proxy(function(e,b){var a={url:"",symbol:null,name:null,desc:null,position:null,daraggable:!1,visible:!1};a.name=getCDATA(d(b).find("name").text());a.cmt=getCDATA(d(b).find("cmt").text());a.desc=getCDATA(d(b).find("desc").text());a.symbol=d(b).find("sym").text();a.position=new google.maps.LatLng(parseFloat(d(b).attr("lat")),parseFloat(d(b).attr("lon")));c._addPlacemark(a)},this));d(e).children("rte").each(function(e,b){var a={path:[],
strokeColor:"#0000ff",strokeOpacity:.7,strokeWeight:5,name:"",desc:""};a.name=getCDATA(d(b).find("name:first").text());a.cmt=getCDATA(d(b).find("cmt:first").text());a.desc=getCDATA(d(b).find("desc:first").text());d(b).children("extensions").each(function(b,c){d(c).children().each(function(b,c){"gpxx:RouteExtension"===c.nodeName&&d(c).children().each(function(b,c){"gpxx:DisplayColor"===c.nodeName&&(a.strokeColor=d(c).text())})})});d(b).children("rtept").each(function(b,c){var e=new google.maps.LatLng(parseFloat(d(c).attr("lat")),
parseFloat(d(c).attr("lon")));a.path.push(e);d(c).children("extensions").each(function(b,c){d(c).children().each(function(b,c){"gpxx:RoutePointExtension"===c.nodeName&&d(c).children().each(function(b,c){"gpxx:rpt"===c.nodeName&&a.path.push(new google.maps.LatLng(parseFloat(d(c).attr("lat")),parseFloat(d(c).attr("lon"))))})})})});1<a.path.length&&c._addSegment(a)});d(e).children("trk").each(function(e,b){d(b).children("trkseg").each(function(a,b){var e={path:[],strokeColor:"#0000ff",strokeOpacity:.7,
strokeWeight:5,name:"track"+a,desc:""},f=d(b).find("name:first").text();e.name="undefined"===typeof f||""===f?"track-"+(a+1):f;e.cmt=getCDATA(d(b).find("cmt:first").text());e.desc=getCDATA(d(b).find("desc:first").text());d(b).children("extensions").each(function(a,b){d(b).children().each(function(a,b){"gpxx:TrackExtension"===b.nodeName&&d(b).children().each(function(a,b){"gpxx:DisplayColor"===b.nodeName&&(e.strokeColor=d(b).text())})})});d(b).children("trkpt").each(function(a,b){var c=new google.maps.LatLng(parseFloat(d(b).attr("lat")),
parseFloat(d(b).attr("lon")));e.path.push(c)});c._addSegment(e)})})},this))}})(jQuery);
