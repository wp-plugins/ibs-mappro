(function(c){Map.prototype.setHandlers=function(){c.widget("ui.dialog",c.ui.dialog,{_allowInteraction:function(a){return!!c(a.target).closest(".cke_dialog").length||this._super(a)}});c(window).resize(c.proxy(function(a){this.sizeHtml()},this));window.onbeforeunload=c.proxy(function(a){if(a=this.isDirty())return a},this);this.html["ibs-header"].on("click",".ibs-reset",{map:this},function(a){a.data.map.reset()});this.html["dd-display"].on("click",".control-distance-flag",{map:this},function(a){a.data.map.options.distance=
a.data.map.html["dd-display"].find(".control-distance-flag").is(":checked")});this.html["dd-display"].on("click",".control-bike-layer",{map:this},function(a){a.data.map.setBikeLayer(a.data.map.html["dd-display"].find(".control-bike-layer").is(":checked"))});this.html["dd-display"].on("click",".control-placemarks",{map:this},function(a){a.data.map.file.placemarkVisible(a.data.map.html["dd-display"].find(".control-placemarks").is(":checked"))});this.html["dd-display"].on("click",".control-waypoints",
{map:this},function(a){a.data.map.file.waypointVisible(a.data.map.html["dd-display"].find(".control-waypoints").is(":checked"))});this.html["dd-map"].on("click",".map-action-browse",{map:this},function(a){a.data.map.browseDialog()});this.html["dd-map"].on("click",".map-action-web",{map:this},function(a){a.data.map.webDialog()});this.html["dd-map"].on("click",".map-action-show",{map:this},function(a){a.data.map.file.showXml()});this.html["dd-map"].on("click",".map-action-upload",{map:this},function(a){a.data.map.uploadDialog()});
this.html["dd-map"].on("click",".map-action-download",{map:this},function(a){a.data.map.file.saveAs(!0)});this.html["dd-map"].on("click",".map-action-save",{map:this},function(a){a.data.map.file.saveDialog()});this.html["dd-map"].on("click",".map-action-focus",{map:this},function(a){a.data.map.file.focus()});this.html.list.on("click",".list-action-edit",{map:this},function(a){a.data.map.file.fileDialog()});this.html["dd-map"].on("click",".map-action-edit",{map:this},function(a){"edit"===a.data.map.options.mode?
a.data.map.file.fileDialog():a.data.map.file.show()});this.html["dd-map"].on("click",".map-action-flip",{map:this},function(a){a.data.map.file.flip()});this.html["dd-map"].on("click",".map-action-sort",{map:this},function(a){a.data.map.file.pendSort()});this.html["dd-map"].on("click",".map-action-clear",{map:this},function(a){a.data.map.clear()});this.html["ibs-header"].on("click",".ibs-find",{map:this},function(a){a.data.map.findDialog()});this.html.list.on("click",".list-action-route",{map:this},
function(a){a.data.map.file.pendSegment()});this.html.list.on("click",".list-action-placemark",{map:this},function(a){a.data.map.file.pendPlacemark()});if("edit"===this.options.mode){var d=function(a){var b=a.data.map.html.list.find(".segment-item-name.selected");return 0<b.length?(b=c(b[0]).attr("rel"),{map:a.data.map,segment:a.data.map.file.segments[b]}):null};this.html["dd-route"].on("click",".route-action-append",{map:this},function(a){(a=d(a))&&a.map.file.append(a.segment)});this.html["dd-route"].on("click",
".route-action-focus",{map:this},function(a){(a=d(a))&&a.segment.focus()});this.html["dd-route"].on("click",".route-action-extend",{map:this},function(a){(a=d(a))&&a.segment.extend()});this.html["dd-route"].on("click",".route-action-edit",{map:this},function(a){(a=d(a))&&a.segment.segmentDialog()});this.html["dd-route"].on("click",".route-action-ledit",{map:this},function(a){(a=d(a))&&a.segment.lineEdit()});this.html["dd-route"].on("click",".route-action-flip",{map:this},function(a){(a=d(a))&&a.segment.flip()});
this.html["dd-route"].on("click",".route-action-rebuild",{map:this},function(a){(a=d(a))&&a.segment.rebuild()});this.html["dd-route"].on("click",".route-action-remove",{map:this},function(a){(a=d(a))&&a.segment.remove()});this.html["dd-route"].on("click",".route-action-thin",{map:this},function(a){(a=d(a))&&a.segment.thin()});this.html["dd-route"].on("click",".route-action-undo",{map:this},function(a){(a=d(a))&&a.segment.undo()});this.html["dd-route"].on("click",".route-action-cue",{map:this},function(a){(a=
d(a))&&a.segment.cuesheetDirections()});this.html["dd-route"].on("click",".route-action-profile",{map:this},function(a){(a=d(a))&&a.map.elevation(a.segment)});this.html["dd-options"].on("click",".control-followroad",{map:this},function(a){var b=a.data.map.html["dd-options"].find(".control-followroad").is(":checked");a.data.map.options.followroad=b});this.html["dd-options"].on("click",".control-avoidhighways",{map:this},function(a){a.data.map.options.avoidhighways=a.data.map.html["dd-options"].find(".control-avoidhighways").is(":checked")});
this.html["dd-options"].on("change","input[name=travelmode]",{map:this},function(a){a.data.map.options.travelmode=a.data.map.html["dd-options"].find("input[name=travelmode]:checked").val()});this.html["placemark-dialog"].on("click",".placemark-select-item",{map:this},function(a){a.data.map.html["placemark-dialog"].find(".placemark-selected-icon").attr("src",c(this).find(".icon-option-value").val())})}this.html.list.on("click",".list-action-import",{map:this},function(a){a.data.map.html.list.find(".import-list-div").toggleClass("hide")});
this.html["find-dialog"].on("keypress",".find-words",{map:this},function(a){13===(a.keyCode?a.keyCode:a.which)&&(a.preventDefault(),a=a.data.map.html["find-dialog"],a.dialog("option","buttons").Find.apply(a))});this.html.page.on("click",".info-footer a",{map:this},function(a){a=a.data.map;var b=c(this).attr("rel"),e=c(this).attr("action"),d=a.file,b="S"==b.substr(0,1)?d.segments[b]:d.placemarks[b];a.infowindow.close();switch(e){case "elevation":b.options.map.elevation(b);break;case "show":b.show();
break;case "edit":b.edit();break;case "remove":b.remove()}});this.html.list.on("click","img.segment-elevation",{map:this},function(a){var b=a.data.map.file.segments[c(this).attr("rel")];b&&(a.preventDefault(),a.stopPropagation(),a.data.map.elevation(b))});this.html.list.on("click","img.segment-focus",{map:this},function(a){var b=a.data.map.file.segments[c(this).attr("rel")];b&&(a.preventDefault(),a.stopPropagation(),b.focus())});this.html.list.on("click","img.segment-cuesheet",{map:this},function(a){var b=
a.data.map.file.segments[c(this).attr("rel")];b&&(a.preventDefault(),a.stopPropagation(),b.cuesheetDirections())});this.html.list.on("click",".placemark-item-image",{map:this},function(a){a.data.map.file.placemarkFilter(this)});this.html.list.on("click",".placemark-item-name",{map:this},function(a){var b=a.data.map.file.placemarks[c(this).attr("rel")];b&&(c(a.data.map.placemarkInfo).addClass("hide"),a.data.map.html["placemark-cm-info"].addClass("hide"),a.data.map.infowindow.close(),a.data.map.file.selectPlacemark(this,
a),b.open())});this.html.list.on("mouseover",".placemark-item-name",{map:this},function(a){var b=c(this).attr("rel");if(b=a.data.map.file.placemarks[b]){b.marker.setVisible(!0);var e=a.data.map.html["placemark-cm-info"];c(e).find(".placemark-cm-desc").text(c("<div>").html(b.options.desc).text());c(e).find(".placemark-cm-name").text(b.options.name);a.data.map.setMenuXY(c(e),b.marker.getPosition());c(e).removeClass("hide")}});this.html.list.on("mouseout",".placemark-item-name",{map:this},function(a){var b=
a.data.map.file.placemarks[c(this).attr("rel")];if(b){var e=a.data.map.file.visiblePlacemark||c(this).hasClass("selected")?!0:!1,e=a.data.map.html["dd-display"].find(".control-placemarks").is(":checked")?!0:e;b.marker.setVisible(e);c(a.data.map.file.options.map.placemarkInfo).addClass("hide");a.data.map.html["placemark-cm-info"].addClass("hide")}});this.html.list.on("click","a.segment-item-name",{map:this},function(a){a.stopPropagation();var b=a.data.map.file.segments[c(this).attr("rel")];b&&(c(a.data.map.placemarkInfo).addClass("hide"),
a.data.map.html["placemark-cm-info"].addClass("hide"),a.data.map.infowindow.close(),a.data.map.file.selectSegment(this,a),c(this).hasClass("selected")?b.open():a.data.map.infowindow.close())});this.html.list.on("mouseover","a.segment-item-name",{map:this},function(a){a=a.data.map;var b=c(this).attr("rel");if(b=a.file.segments[b]){var e=a.html["placemark-cm-info"];e.find(".placemark-cm-desc").html("");e.find(".placemark-cm-name").html(b.options.name);a.setMenuXY(e,b.marker.getPosition());e.removeClass("hide");
google.maps.event.trigger(b.marker,"mouseover")}});this.html.list.on("mouseout","a.segment-item-name",{map:this},function(a){a=a.data.map;var b=c(this).attr("rel");if(b=a.file.segments[b])a.html["ibs-container"].find(".placemark-cm-info").addClass("hide"),google.maps.event.trigger(b.marker,"mouseout")});c(this.html.list).mousedown(function(a){a.stopPropagation()});this.html["segment-cm-edit"].on("click",".cm-edit-action",{map:this},function(a){var b=c(this).data().segment;a.data.map.html["segment-cm-edit"].addClass("hide");
switch(c(this).attr("rel")){case "clear":b&&b.stopEditing();break;case "delete":a=parseInt(c(this).data("index"));b&&b.removePoint(a);break;case "split":b&&(a=parseInt(c(this).data("index")),b.split(a))}});this.html["segment-cm-line"].on("click",".cm-line-action",{map:this},function(a){var b=c(this).data().segment;a.data.map.html["segment-cm-line"].addClass("hide");switch(c(this).attr("rel")){case "line-edit":b.lineEdit();break;case "waypoint":b&&(a=parseInt(c(this).data("point")),b.waypoint(a));
break;case "split":b&&(a=parseInt(c(this).data("point")),b.split(a))}});this.html["segment-dialog"].find(".opacity-val").spinner({spin:c.proxy(function(a,b){var c=b.value;this.html["segment-dialog"].find(".colorpicker-trigger").css("opacity",c)},this)});this.html["segment-dialog"].find(".width-val").spinner({spin:c.proxy(function(a,b){var c=b.value,d=parseInt((30-c)/2);this.html["segment-dialog"].find(".colorpicker-trigger").css("height",c+"px");this.html["segment-dialog"].find(".colorpicker-trigger").css("margin-top",
d+"px")},this)});this.html["segment-dialog"].on("change",".segment-color-select",{map:this},function(a){c(a.data.map.html["segment-dialog"].find(".segment-color")).css("background-color",c(a.data.map.mids("segment-color-select")).val());c(a.data.map.html["segment-dialog"].find(".segment-color")).css("color","#FFFFFF");c(a.data.map.html["segment-dialog"].find(".segment-color")).val(c(a.data.map.html["segment-dialog"].find(".segment-color-select")).val())});this.html["file-dialog"].find(".opacity-val").spinner({spin:c.proxy(function(a,
b){var c=b.value;this.html["file-dialog"].find(".colorpicker-trigger").css("opacity",c)},this)});this.html["file-dialog"].find(".width-val").spinner({spin:c.proxy(function(a,b){var c=b.value,d=parseInt((30-c)/2);this.html["file-dialog"].find(".colorpicker-trigger").css("height",c+"px");this.html["file-dialog"].find(".colorpicker-trigger").css("margin-top",d+"px")},this)});this.html["file-dialog"].on("change",".file-color-select",{map:this},function(a){a.data.map.html["file-dialog"].find(".file-color").css("background-color",
a.data.map.html["file-dialog"].find(".file-color-select").val());a.data.map.html["file-dialog"].find(".file-color").css("color","#FFFFFF");a.data.map.html["file-dialog"].find(".file-color").val(a.data.map.html["file-dialog"].find(".file-color-select").val())});this.html["file-dialog"].on("keypress",".file-settings-name",{map:this},function(a){13===(a.keyCode?a.keyCode:a.which)&&(a.preventDefault(),a=a.data.map.html["file-dialog"],a.dialog("option","buttons").Update.apply(a))});this.html["file-dialog"].on("change",
".file-name",{map:this},function(a){a.data.map.html["file-dialog"].find("input[name=file_settings_ext]:radio").trigger("change")});this.html["file-dialog"].on("change","input[name=file_ext]:radio",{map:this},function(a){var b=a.data.map.html["file-dialog"].find("input[name=file_ext]:checked").val(),c=a.data.map.html["file-dialog"].find(".file-name").val();3>c.length&&(c+="*");c=getFilename(c)+"."+b;a.data.map.html["file-dialog"].find(".file-name").val(c)});this.html["file-dialog"].on("click",".reset-lines",
{map:this},function(a){var b=a.data.map;a=b.file;var b=b.html["file-dialog"].find(".colorpicker-trigger"),b={strokeColor:rgb2hex(c(b).css("background-color")),strokeOpacity:parseFloat(c(b).css("opacity")).toFixed(3),strokeWeight:parseInt(c(b).css("height").replace(/px/,""))},d;for(d in a.segments)a.segments[d].setOptions(b),a.segments[d].line.setOptions(b),a.setDirty(!0)});this.html["save-dialog"].on("keypress",".save-name",{map:this},function(a){13===(a.keyCode?a.keyCode:a.which)&&(a.preventDefault(),
a=a.data.html["save-dialog"],a.dialog("option","buttons").Save.apply(a))});this.html["save-dialog"].on("change",".save-name",{map:this},function(a){a.data.map.html["save-dialog"].find('input[name="file_ext"]:radio').trigger("change")});this.html["save-dialog"].on("change",".save-dir",{map:this},function(a){var b=a.data.map.html["save-dialog"].find(".save-dir").val(),b=(b+"/").replace("//","/");a.data.map.html["save-dialog"].find(".save-dir").val(b)});this.html["save-dialog"].on("change",'input[name="file_ext"]:radio',
{map:this},function(a){var b=a.data.map.html["save-dialog"].find('input[name="file_ext"]:checked').val(),c=a.data.map.html["save-dialog"].find(".save-name").val();3>c.length&&(c+="*");c=getFilename(c)+"."+b;a.data.map.html["save-dialog"].find(".save-name").val(c)});this.uploader.on("submit","",{},c.proxy(function(){this.uploadCount++},this));this.uploader.on("complete","",{map:this},function(a,b,c,d){a=a.data.map;a.uploadCount--;0===a.uploadCount&&a.html["upload-dialog"].dialog("close");b=getExtension(c).toLowerCase();
if("kml"===b||"kmz"===b||"gpx"===b)b=a.html["upload-dialog"].find(".upload-target-directory").val(),b=ibs_mappro.maps_url+b,a.file.importFileimport(b+c)});this.html.data.on("click",".chart-close",{map:this},function(a){a.data.map.elevationSegment=null;a.data.map.sizeHtml()});this.html["file-dialog"].find(".reset-lines").button({text:!0,label:"Set Lines",icons:{primary:"ui-icon-arrowreturnthick-1-e"}});this.html["upload-dialog"].on("change",".upload-target-directory",{map:this},function(a){a=a.data.map;
var b=a.html["upload-dialog"].find(".upload-target-directory").val(),b=(b+"/").replace("//","/");a.html["upload-dialog"].find(".upload-target-directory").val(b.replace(ibs_mappro.maps_path,""));a.uploader.fineUploader("setParams",{dir:b})});var f="100%"===this.options.height?c(window).height():this.options.height,g="100%"===this.options.width?c(window).width():this.options.width;this.html["ibs-container"].width(g);this.html["ibs-container"].height(f);this.html["ibs-container"].on("resizestop","",
{map:this},function(a){a.data.map.sizeHtml()});this.html.list.on("resizestop","",{map:this},function(a){a.data.map.sizeHtml()});this.html["ibs-header"].on("click",".ibs-size",{map:this},function(a){a.data.map.resetSize()});this.resetSize()};Map.prototype.resetSize=function(){var d="100%"===this.options.height?c(window).height():this.options.height,f="100%"===this.options.width?c(window).width():this.options.width;this.html["ibs-container"].css({top:this.options.top,left:this.options.left});this.html["ibs-container"].width(f);
this.html["ibs-container"].height(d);this.sizeHtml()};Map.prototype.sizeHtml=function(){this.elevationSegment?this.html.data.height(200):this.html.data.height(0);var d=c(window).height()<this.html["ibs-container"].height()?c(window).height():this.html["ibs-container"].height(),f=c(window).width()<this.html["ibs-container"].width()?c(window).width():this.html["ibs-container"].width(),d=d-this.options.top,f=f-this.options.left;this.html["ibs-container"].width(f);this.html["ibs-container"].height(d);
var g=this.html["ibs-container"].height(),d=this.html["ibs-header"].find("div").height(),f=this.html["ibs-footer"].height(),g=g-d-f-4;c(this.html["ibs-main"]).css("height",g-10+"px");d=c(this.html["ibs-container"]).width();f="edit"!==this.options.mode?0:c(this.html.list).width();f=d-f-5;this.html.app.width(f);d=c(this.html.data).height();this.html.map.width(f);this.html.map.height(g-d);this.html["data-chart"].height(this.html.data.height()-c(this.html.data).find("span:first").height());this.html["data-chart"].width(this.html.data.width());
this.googlemap&&google.maps.event.trigger(this.googlemap,"resize")}})(jQuery);
