function Map(e){this.init(e)}
(function(e){Map.prototype.init=function(c){this.options={address:"",div:"body",top:0,left:0,height:"100%",width:"100%",url:"",mid:"M1001",metric:!1,filename:"",location:new google.maps.LatLng(37.09024,-95.712891),strokeColor:"#000fff",strokeWeight:5,strokeOpacity:.3,distance:!1,followroad:!0,travelmode:"DRIVING",avoidhighways:!0,user_type:"guest",user_name:"unknown",pid:"",gpx_routes:!1,gpx_tracks:!0,gpx_waypoints:!0,gpx_placemarks:!0,mode:"edit"};for(var a in c)this.options[a]=c[a];this.siteRoot=
function(){return ibs_mappro.root};this.siteUrl=function(){return ibs_mappro.site};this.html=[];this.garmin_symbols=null;this.files={};this.fileId=1E3;this.googlemap=null;"undefined"===typeof window.maps&&(window.maps={});this.options.mid="M1"+padLeftStr(Object.keys(window.maps).length+1,3,"0");window.maps[this.options.mid]=this;this.click=function(b){var a=d.sid,c=d.pid;d={pid:null,sid:null};this.setCursor("pointer");a&&(a=this.file.segments[a],a.pend="extend",a.click(b));c&&this.file.placemarks[c].click(b);
this.file.click(b)};var d={pid:null,sid:null};this.setClick=function(b){this.file.pendReset();if(b)return d=b,this.setCursor("crosshair"),!0;d={pid:null,sid:null};this.setCursor("pointer");return!1};this.getClick=function(){return d};this.setCursor=function(b){this.googlemap.setOptions({draggableCursor:b})};this.fitBounds=function(){var b=new google.maps.LatLngBounds;this.file.getBounds(b);this.googlemap.fitBounds(b);this.file.refresh()};this.setBikeLayer=function(b){b?this.bicycleLayer.setMap(this.googlemap):
this.bicycleLayer.setMap(null)};this.setMenuXY=function(b,d){var a=this.html["map-div"].width(),c=this.html["map-div"].height(),e=b.width(),k=b.height(),f=this.getCanvasXY(d),h=f.x,f=f.y;b.css({left:a-h<e?h-e:h,top:c-f<k?f-k:f,position:"absolute"})};this.getCanvasXY=function(b){var d=Math.pow(2,this.googlemap.getZoom()),a=new google.maps.LatLng(this.googlemap.getBounds().getNorthEast().lat(),this.googlemap.getBounds().getSouthWest().lng()),a=this.googlemap.getProjection().fromLatLngToPoint(a);b=this.googlemap.getProjection().fromLatLngToPoint(b);
return new google.maps.Point(Math.floor((b.x-a.x)*d),Math.floor((b.y-a.y)*d))};this.measure1=function(){return this.options.metric?"(m)":"(f)"};this.measure2=function(){return this.options.metric?" km":" mi"};this.convertMeters1=function(b){return this.options.metric?b.toFixed(2):(3.2808399*b).toFixed(2)};this.convertMeters2=function(b){return this.options.metric?(b/1E3).toFixed(2):(b/1609.344).toFixed(2)};this.isGuest=function(){return"guest"===this.options.user_type||"edit"!==this.options.mode};
this.isAdmin=function(){return"admin"===this.options.user_type&&"edit"===this.options.mode};this.getUser=function(){return this.options.user_type};this.getPath=function(){var b=this.isAdmin()?"":"share/";return this.options.maps_path+b};this.getUserFolder=function(){return"unknown"!==this.options.user_name&&""!==this.options.user_name&&/^[a-z0-9_-]{3,16}$/.test(this.options.user_name)?this.options.user_name+"/":""};this.getCkeditorConfig=function(){return{toolbarStartupExpanded:!0,extraPlugins:"print,table",
disableNativeSpellChecker:!1,browserContextMenuOnCtrl:!0,removePlugins:"scayt",height:200,contentsCss:this.siteUrl()+"/css/map.css",resize_enabled:!0,toolbar:["Source Undo Redo - SelectAll RemoveFormat".split(" "),["Bold","Italic","Underline","Strike"],["Link","Unlink","Image"],["TextColor","BGColor","Print","Table"]]}};this.kml=new KML;this.gpx=new GPX;this.setIcons();this.setHtml();this.setMap();this.setFile();isUrl(this.options.url)?this.file.importFile(this.options.url):""!==this.options.address&&
this.geocoder.geocode({address:this.options.address},e.proxy(function(b,d){if(d===google.maps.GeocoderStatus.OK){var a=b[0].geometry.location.lat(),c=b[0].geometry.location.lng(),c=parseFloat(c),a=parseFloat(a);"number"===typeof a&&"number"===typeof c&&(a=new google.maps.LatLng(a,c),this.googlemap.setCenter(a))}},this))};Map.prototype.setFile=function(){this.file=new File({map:this,url:"",strokeColor:this.options.strokeColor,strokeWeight:this.options.strokeWeight,strokeOpacity:this.options.strokeOpacity,
filename:this.options.filename,gpx_routes:this.options.gpx_routes,gpx_tracks:this.options.gpx_tracks,gpx_waypoints:this.options.gpx_waypoints,gpx_placemarks:this.options.gpx_placemarks})};Map.prototype.removeFile=function(){this.setClick();delete this.file;this.html.list.find(".placemark-list").empty();this.html.list.find(".segment-list").empty();this.html.list.find(".import-list").empty();this.setFile()};Map.prototype.clear=function(c){this.file.remove()};Map.prototype.isDirty=function(){return this.file.dirty?
"Changes have not been saved.":null};Map.prototype.findLocation=function(){var c=this.html["find-dialog"].find(".find-words").val();""!==c&&this.geocoder.geocode({address:c},e.proxy(function(a,d){if(d===google.maps.GeocoderStatus.OK){this.html["find-dialog"].find(".find-list").html("");for(var b in a){var c=a[b].geometry.location.lat(),g=a[b].geometry.location.lng();this.html["find-dialog"].find(".find-list").append(e("<li>").append(e("<a>").addClass("find-item").attr({href:"#",lat:c,lng:g}).html(a[b].formatted_address)))}this.googlemap.setCenter(a[0].geometry.location);
this.searchmarker.setPosition(a[0].geometry.location);this.searchmarker.setTitle(a[0].formatted_address);this.searchmarker.setVisible(!0);this.html["find-dialog"].find(".find-item").on("click",null,{map:this},function(a){var b=parseFloat(e(this).attr("lat")),d=parseFloat(e(this).attr("lng")),b=new google.maps.LatLng(b,d);a.data.map.searchmarker.setPosition(b);a.data.map.searchmarker.setTitle(e(this).text());a.data.map.searchmarker.setVisible(!0);a.data.map.googlemap.setCenter(b)});this.html["find-dialog"].on("mouseover",
".find-item",{map:this},function(a){var b=parseFloat(e(this).attr("lat")),d=parseFloat(e(this).attr("lng")),b=new google.maps.LatLng(b,d);a.data.map.searchmarker.setPosition(b);a.data.map.searchmarker.setTitle(e(this).text());a.data.map.searchmarker.setVisible(!0)})}else this.alert(d)},this))};Map.prototype.setMap=function(){if(null===this.googlemap){var c=[],a;for(a in google.maps.MapTypeId)c.push(google.maps.MapTypeId[a]);c.push("OSM");c.push("OSMCYCLE");c.push("OSMPUBLIC");c.push("OSMLANDSCAPE");
c.push("OSMOUTDOORS");this.googlemap=new google.maps.Map(this.html["map-div"][0],{backgroundColor:null,center:this.options.location,disableDefaultUI:!1,disableDoubleClickZoom:!1,draggable:!0,draggingCursor:"auto",heading:0,keyboardShortcuts:!0,mapMaker:!1,mapTypeControl:!0,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{mapTypeIds:c,position:google.maps.ControlPosition.TOP_RIGHT,style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},maxZoom:null,noClear:!1,overviewMapControl:!0,overviewMapControlOptions:{opened:!1},
panControl:!1,panControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},rotateControl:!1,rotateControlOptions:{position:google.maps.ControlPosition.BOTTOM_RIGHT},scaleControl:!0,scaleControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER,style:"DEFAULT"},scrollwheel:!0,streetViewControl:"edit"===this.options.mode?!0:!1,streetViewControlOptions:{position:google.maps.ControlPosition.TOP_LEFT},styles:[{featureType:"poi.business",stylers:[{visibility:"on"}]}],tilt:0,zoom:7,zoomControl:"edit"===
this.options.mode?!0:!1,zoomControlOptions:{position:google.maps.ControlPosition.TOP_LEFT,style:google.maps.ZoomControlStyle.SMALL}});this.googlemap.mapTypes.set("OSM",new google.maps.ImageMapType({getTileUrl:function(a,b){return"http://tile.openstreetmap.org/"+b+"/"+a.x+"/"+a.y+".png"},tileSize:new google.maps.Size(256,256),name:"OSM-Street",maxZoom:18}));this.googlemap.mapTypes.set("OSMCYCLE",new google.maps.ImageMapType({getTileUrl:function(a,b){return"http://tile.thunderforest.com/cycle/"+b+"/"+
a.x+"/"+a.y+".png"},tileSize:new google.maps.Size(256,256),name:"OSM-Cycle",maxZoom:18}));this.googlemap.mapTypes.set("OSMPUBLIC",new google.maps.ImageMapType({getTileUrl:function(a,b){return"http://tile.thunderforest.com/transport/"+b+"/"+a.x+"/"+a.y+".png"},tileSize:new google.maps.Size(256,256),name:"OSM-Public",maxZoom:18}));this.googlemap.mapTypes.set("OSMPUBLIC",new google.maps.ImageMapType({getTileUrl:function(a,b){return"http://tile.thunderforest.com/transport/"+b+"/"+a.x+"/"+a.y+".png"},
tileSize:new google.maps.Size(256,256),name:"OSM-Public",maxZoom:18}));this.googlemap.mapTypes.set("OSMLANDSCAPE",new google.maps.ImageMapType({getTileUrl:function(a,b){return"http://tile.thunderforest.com/landscape/"+b+"/"+a.x+"/"+a.y+".png"},tileSize:new google.maps.Size(256,256),name:"OSM-Landscape",maxZoom:18}));this.googlemap.mapTypes.set("OSMOUTDOORS",new google.maps.ImageMapType({getTileUrl:function(a,b){return"http://tile.thunderforest.com/outdoors/"+b+"/"+a.x+"/"+a.y+".png"},tileSize:new google.maps.Size(256,
256),name:"OSM-Outdoors",maxZoom:18}));this.bicycleLayer=new google.maps.BicyclingLayer(this.googlemap);this.bicycleLayer.setMap(null);this.directionsService=new google.maps.DirectionsService;this.geocoder=new google.maps.Geocoder;this.infowindow=new google.maps.InfoWindow({content:""});this.searchmarker=new google.maps.Marker({position:this.options.location,map:this.googlemap,visible:!1,title:"search marker",icon:this.imageRedMarker});google.maps.event.addListener(this.searchmarker,"click",function(a){this.setVisible(!1)});
google.maps.event.addListener(this.googlemap,"click",e.proxy(function(a){this.click(a)},this));google.maps.event.addListener(this.googlemap,"rightclick",e.proxy(function(a){this.setClick()},this));google.maps.event.addListener(this.googlemap,"mousemove",e.proxy(function(a){this.showPend(a.latLng)},this));return this.googlemap}};Map.prototype.showPend=function(c){var a=this.html.map.find(".pend-info");a.addClass("hide");var d=this.getClick(),b=this.file.pend;d.sid&&(b=this.file.segments[d.sid].pend);
this.html["ibs-footer"].find(".ibs-message").text("right click cancels action");switch(b){case "placemark":a.text("Set marker");this.html.list.find(".placemark-list-name").removeClass("img-marker").addClass("img-marker-hot");break;case "segment":a.text("Start route");this.html.list.find(".segment-list-name").removeClass("img-line").addClass("img-line-hot");break;case "sort":a.text("Set sort origin");break;case "extend":a.text("Extend route");break;default:this.html.list.find(".placemark-list-name").removeClass("img-marker-hot").addClass("img-marker");
this.html.list.find(".segment-list-name").removeClass("img-line-hot").addClass("img-line");this.html["ibs-footer"].find(".ibs-message").text("");return}this.setMenuXY(a,c);c=parseInt(a.css("top").replace(/px/,""));a.css("top",c-50+"px");a.removeClass("hide")};Map.prototype.reset=function(){this.setClick();spin(!1);for(var c in this.file.segments)this.file.segments[c].stopEditing(),this.file.segments[c].cuesheetKill();this.elevationSegment=null;this.sizeHtml()};Map.prototype.stats=function(c,a,d,b){var l=
padLeftStr(b.toString(),3," ")+" placemarks.",g=padLeftStr(d.toString(),3," ")+" segments.";e(c).html("").append(e("<div>").addClass("stats").append(e("<img>").attr("src",this.siteUrl()+"image/gears.png")).append(e("<span>").html(this.convertMeters2(a)+this.measure2()))).append(e("<div>").addClass("stats").addClass(d?"":"hide").append(e("<img>").attr("src",this.siteUrl()+"image/line.png")).append(e("<span>").html(g))).append(e("<div>").addClass("stats").addClass(b?"":"hide").append(e("<img>").attr("src",
this.siteUrl()+"image/marker.png")).append(e("<span>").html(l)))};Map.prototype.alert=function(c){c=jQuery("<div>").attr({id:"alert-dialog",title:"Alert"}).css({"background-color":"Tomato",color:"white"}).append(jQuery("<p>").append(jQuery("<img>").attr("src",this.siteUrl()+"image/alert-white.png").css({"float":"left","margin-right":"5px"})).append(jQuery("<span>").html(c)));jQuery(c).dialog({autoOpen:!0,modal:!0,buttons:{Ok:function(){jQuery(this).dialog("close")}},close:function(){jQuery(this).dialog("destroy")}})};
Map.prototype.confirm=function(c,a){var d=jQuery("<div>").attr({id:"alert-dialog",title:"Confirm"}).css({"background-color":"Tomato",color:"white"}).append(jQuery("<p>").append(jQuery("<img>").attr("src",this.siteUrl()+"image/alert-white.png").css({"float":"left","margin-right":"5px"})).append(jQuery("<span>").html(c)));jQuery(d).dialog({autoOpen:!0,modal:!0,buttons:{Ok:function(){jQuery(this).dialog("close");a(!0)},Cancel:function(){jQuery(this).dialog("close");a(!1)}},close:function(){jQuery(this).dialog("destroy")}})};
Map.prototype.prompt=function(c,a){var d=jQuery("<div>").attr({id:"alert-dialog",title:"Alert"}).css({"background-color":"AliceBlue",color:"blue"}).append(jQuery("<p>").append(jQuery("<img>").attr("src",this.siteUrl()+"image/question.png").css({"float":"left","margin-right":"5px"})).append(jQuery("<span>").css({"float":"left","margin-right":"5px"}).html(c)).append(jQuery("<input>").attr({id:"answer",type:"text",size:"30",value:""})));jQuery(d).dialog({autoOpen:!0,modal:!0,buttons:{Ok:function(){jQuery(this).dialog("close");
"function"===typeof a&&a(jQuery(d).find("#answer").val())},Cancel:function(){jQuery(this).dialog("close");"function"===typeof a&&a(null)}},close:function(){jQuery(this).dialog("destroy")}})};Map.prototype.notice=function(c){var a=jQuery("<div>").attr({id:"notice-dialog",title:"Notice"}).css({"background-color":"AliceBlue",color:"blue"}).append(jQuery("<p>").append(jQuery("<img>").attr("src",this.siteUrl()+"image/notice.png").css({"float":"left","margin-right":"5px"})).append(jQuery("<span>").html(c)));
jQuery(a).dialog({autoOpen:!0,modal:!1,show:{effect:"blind",duration:1E3},hide:{effect:"blind",duration:1E3},open:function(){var c=setInterval(function(){jQuery(a).dialog("close");clearInterval(c)},2500)},close:function(){jQuery(this).dialog("destroy")}})}})(jQuery);
