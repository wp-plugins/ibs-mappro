function File(d){this.init(d)}
(function(d){File.prototype.init=function(a){this.options={filename:"(un-named).kml",name:null,desc:null,map:null,strokeColor:null,strokeWeight:null,strokeOpacity:null,gpx_routes:!1,gpx_tracks:!0,gpx_waypoints:!0,gpx_placemarks:!0,import_dir:null,import_files:[]};for(var b in a)this.options[b]=a[b];this.visiblePlacemark=!1;this.dir=this.options.map.getUser()+"/";this.filename=this.options.filename;this.options.name=this.filename;this.options.desc=this.filename;this.fileList=this.options.map.html.list;
this.options.map.html.list.find(".list-filename").text(this.filename);this.placemarkList=this.options.map.html.list.find(".placemark-list");this.segmentList=this.options.map.html.list.find(".segment-list");this.segmentList.sortable();this.segmentList.disableSelection();this.placemarkList.sortable();this.placemarkList.disableSelection();this.segments={};this.placemarks={};this.placemarkId=this.segmentId=1E3;this.removeFile=!1;this.pend=null;this.setDirty=function(a){(this.dirty=a)?this.fileList.find(".file-list-name").addClass("dirty"):
this.fileList.find(".file-list-name").removeClass("dirty")}};File.prototype.importFile=function(a){spin(!0);this.options.import_files=a.split(";");a=purl(this.options.import_files[0]);this.options.import_dir=a.data.attr.base+a.data.attr.directory;this.options.import_files[0]=a.data.attr.file;this._importFile()};File.prototype._importFile=function(){if(this.options.import_files.length){var a=this.options.import_dir+this.options.import_files.pop();d.post(ibs_mappro.ajax,{action:"ibs_mappro_CORS",path:a,
cache:!1},d.proxy(function(b,c){try{if("success"===c){try{var e=d.parseXML(b)}catch(f){alert(f)}0<d(e).find("kml").length?this.options.map.kml.reader(e,this):0<d(e).find("gpx").length?this.options.map.gpx.reader(e,this):alert("invalid file contents")}else alert("server load failed.")}catch(g){alert("process map failed.")}e=getFilename(a)+"."+getExtension(a);this.filename===this.options.map.options.filename&&(this.filename=e,this.options.map.html.list.find(".list-filename").text(e));this.options.map.html.list.find(".import-list").append(d("<li>").text(e));
this.postLoad();this._importFile();spin(!1)},this))}};File.prototype.checkMapname=function(a,b){if("string"===typeof a&&3<a.length){var c=getExtension(a),e=getFilename(a);if(/^[\w\s-()]{3,50}$/.test(e)){if("kml"!==c||"kmz"!==c||"gpx"!==c)c=b;return e+"."+c}}return!1};File.prototype.listSegments=function(){var a=[],b=this.segmentList.find("li a.segment-item-name");d(b).each(function(b,e){a.push(d(e).attr("rel"))});return a};File.prototype.listPlacemarks=function(){var a=[],b=this.placemarkList.find("li a.placemark-item-name");
d(b).each(function(b,e){a.push(d(e).attr("rel"))});return a};File.prototype.sortSegments=function(a){var b=a.latLng;a=[];for(var c in this.segments){var e={distance:distanceFrom(b,this.segments[c].marker.getPosition()),sid:c};a.push(e)}a.sort(function(a,b){return a.distance<b.distance?-1:a.distance>b.distance?1:0});c=null;for(var f in a)c&&(c="."+c,d("."+a[f].sid).insertAfter(c)),c=a[f].sid};File.prototype.sortPlacemarks=function(a){var b=a.latLng;a=[];for(var c in this.placemarks){var e={distance:distanceFrom(b,
this.placemarks[c].marker.getPosition()),pid:c};a.push(e)}a.sort(function(a,b){return a.distance<b.distance?-1:a.distance>b.distance?1:0});c=null;for(var f in a)c&&(c="."+c,d("."+a[f].pid).insertAfter(c)),c=a[f].pid};File.prototype._orderPlacemark=function(a){var b=null,c=null,e;for(e in this.placemarks)if(e!==a){var f=distanceFrom(this.placemarks[a].marker.getPosition(),this.placemarks[e].marker.getPosition());if(!b||f<b)b=f,c=e}c&&(b="#"+c,d("#"+a).insertAfter(b))};File.prototype._undoSegment=function(a){a.path=
[];for(var b=0;b<a.latlngs.length;b++)a.path.push(new google.maps.LatLng(a.latlngs[b].lat,a.latlngs[b].lng));delete a.latlng;this.segments[a.sid]=new Segment(a)};File.prototype._undoPlacemark=function(a){this.placemarks[a.pid]||(this.placemarks[a.pid]=new Placemark(a))};File.prototype.undo=function(a){spin(!0);try{for(var b=0;b<a.length;b++)a[b].pid?this._undoPlacemark(a[b]):a[b].sid&&this._undoSegment(a[b]),this.postLoad(!0),this.setDirty(!0)}catch(c){spin(!1)}spin(!1)};File.prototype.postLoad=function(){this.dirty=
!1;this.options.map.setClick(null);this.focus();this.updatePid()};File.prototype.getPids=function(a,b){this.options.map.geocoder.geocode({address:a[b][1]},d.proxy(function(c,e){if(e===google.maps.GeocoderStatus.OK){var d=c[0].geometry.location.lat(),g=c[0].geometry.location.lng(),g=parseFloat(g),d=parseFloat(d);"number"===typeof d&&"number"===typeof g&&(d=new google.maps.LatLng(d,g),g=a[b][0],this.placemarks[g].options.position=d,this.placemarks[g].options.desc=c[0].formatted_address,this.placemarks[g].marker.setPosition(d),
this.placemarks[g].marker.setVisible(!0));b++;if(b<a.length)this.getPids(a,b,h);else{var h=new google.maps.LatLngBounds;this.getBounds(h);this.options.map.googlemap.fitBounds(h)}}},this))};File.prototype.updatePid=function(){if(""!==this.options.map.options.pid){var a=[];d.post(ibs_mappro.ajax,{action:"ibs_mappro_pid",pid:this.options.map.options.pid},d.proxy(function(b,c){if("success"===c){for(var d in b)for(var f in this.placemarks)this.placemarks[f].options.name===d&&a.push([f,b[d]]);0<a.length&&
this.getPids(a,0)}},this),"json")}};File.prototype._add=function(a){a.mid=this.options.mid;a.map=this.options.map;a.file=this};File.prototype._addSegment=function(a){for(var b in this.segments)if(this.segments[b].options.name===a.name){this.segments[b].line.setPath(a.path);return}this.segmentId++;this._add(a);a.sid="S"+this.segmentId.toString();this.segments[a.sid]=new Segment(a);return a.sid};File.prototype.addSegment=function(a){this.segments[this._addSegment(a)].extend();this.setDirty(!0)};File.prototype._addPlacemark=
function(a){this.placemarkId++;this._add(a);a.pid="P"+this.placemarkId.toString();""===a.name&&(a.name=a.pid);this.placemarks[a.pid]=new Placemark(a);"Waypoint"===this.placemarks[a.pid].options.symbol?this.placemarks[a.pid].marker.setVisible(this.options.map.html["dd-display"].find(".control-waypoints").is(":checked")):this.placemarks[a.pid].marker.setVisible(this.options.map.html["dd-display"].find(".control-placemarks").is(":checked"));return a.pid};File.prototype.addPlacemark=function(a){a=this._addPlacemark(a);
this.placemarks[a].marker.setVisible(!0);this.setDirty(!0);this._orderPlacemark(a);return a};File.prototype.click=function(a){if(this.pend){switch(this.pend){case "sort":this.sortPlacemarks(a);this.sortSegments(a);break;case "placemark":this.addPlacemark({position:a.latLng});this.pendReset();break;case "segment":this.addSegment({path:[a.latLng],strokeColor:this.options.strokeColor,strokeWeight:this.options.strokeWeight,strokeOpacity:this.options.strokeOpacity})}this.pend=null}};File.prototype.pendReset=
function(){this.options.map.html.map.find(".pend-info").addClass("hide");for(var a in this.segments)""===this.segments[a].pend;this.pend=null};File.prototype.pendSegment=function(){"segment"===this.pend?(this.options.map.setClick(),this.options.map.html.map.find(".pend-info").addClass("hide")):(this.options.map.setClick({sid:null,pid:null}),this.pend="segment",this.options.map.showPend(this.options.map.googlemap.getCenter()))};File.prototype.pendSort=function(){this.options.map.setClick({sid:null,
pid:null});this.pend="sort";this.options.map.showPend(this.map.googlemap.getCenter())};File.prototype.pendPlacemark=function(){"placemark"===this.pend?this.options.map.setClick():(this.options.map.setClick({sid:null,pid:null}),this.pend="placemark",this.options.map.showPend(this.options.map.googlemap.getCenter()))};File.prototype.placemarkVisible=function(a){for(var b in this.placemarks){var c=this.placemarks[b];"Waypoint"===c.options.symbol?c.marker.setVisible(this.options.map.html["dd-display"].find(".control-waypoints").is(":checked")):
c.marker.setVisible(a)}};File.prototype.waypointVisible=function(a){for(var b in this.placemarks){var c=this.placemarks[b];"Waypoint"===c.options.symbol&&c.marker.setVisible(a)}};File.prototype.placemarkFilter=function(a){a=d(a).attr("src");for(var b in this.placemarks){var c=this.placemarks[b].marker.getVisible();this.placemarks[b].marker.setVisible(this.placemarks[b].marker.icon.url===a&&!c)}};File.prototype.flip=function(){for(var a in this.segments)this.segments[a].flip()};File.prototype.distance=
function(){var a=0,b;for(b in this.segments)a+=this.segments[b].distance();return a};File.prototype.removePlacemark=function(a){this.removeFile||(delete this.placemarks[a],this.placemarkList.find("."+a).remove(),this.setDirty(!0))};File.prototype.removePlacemarks=function(){for(var a in this.placemarks)this.placemarks[a].remove()};File.prototype.removeSegment=function(a){this.removeFile||(delete this.segments[a],this.setDirty(!0),this.options.map.reset())};File.prototype.removeSegments=function(){for(var a in this.segments)this.segments[a].remove()};
File.prototype.remove=function(){this.removeFile=!0;this.removePlacemarks();this.removeSegments();this.options.map.removeFile()};File.prototype.getBounds=function(a){for(var b in this.segments)this.segments[b].getBounds(a);for(var c in this.placemarks)a.extend(this.placemarks[c].marker.getPosition())};File.prototype.refresh=function(){for(var a in this.segments)this.segments[a].refresh()};File.prototype.isPlacemark=function(a){for(var b in this.placemarks)if(this.placemarks[b].options.position.equals(a))return b;
return!1};File.prototype.append=function(a){var b=null,c=a.line.getPath(),d=c.getAt(c.getLength()-1),f=0,g;for(g in this.segments)if(g!==a.sid){var h=this.segments[g].line.getPath().getAt(0),h=distanceFrom(d,h);if(null===b||f>h)b=this.segments[g],f=h}if(b){for(;0<c.getLength();)d=c.pop(),b.line.getPath().insertAt(0,d);a.remove();b.refresh()}};File.prototype.focus=function(){if(0<Object.keys(this.segments).length){var a=new google.maps.LatLngBounds;this.getBounds(a);this.options.map.googlemap.fitBounds(a)}};
File.prototype.getXml=function(){return"gpx"===getExtension(this.filename)?this.options.map.gpx.writer(this):this.options.map.kml.writer(this)};File.prototype.showXml=function(){this.options.map.kml.kmlWindow(this.getXml());window.open("","XML Export "+(new Date).getTime(),"width=800,height=1000").document.write('<textarea id="xml" style="width: 100%; height: 100%">'+this.getXml()+"</textarea>")};File.prototype.saveAs=function(a){"undefined"===typeof a&&(a=!1);var b=this.getXml();b?d.post(ibs_mappro.ajax,
{action:"ibs_mappro_savexml",data:encodeURIComponent(b),filename:this.dir+this.filename},d.proxy(function(b,e){spin(!1);if("success"===e)if(this.setDirty(!1),a){var f=decodeURIComponent(b),f=this.options.map.siteUrl()+"lib/download.php?file="+f;d.fileDownload(f,{successCallback:d.proxy(function(a){this.options.map.notice("Save "+this.filename+" completed.")},this),failCallback:d.proxy(function(a,b){this.options.map.alert("File download failed. "+this.filename)},this)})}else this.options.map.notice("Save "+
this.filename+" completed.");else this.options.map.alert("Save "+this.filename+" failed.")},this)):this.options.map.alert("Error creating XML document.")};File.prototype.selectPlacemark=function(a,b){var c=d(a).hasClass("selected");this.placemarkList.find(".placemark-item-name").removeClass("selected");!1===c&&(d(a).addClass("selected"),d(a).parent().ScrollTo({onlyIfOutside:!0}))};File.prototype.selectSegmentCheck=function(){if(0<this.segmentList.find(".segment-item-name.selected").length)return this.options.map.html["ibs-header"].find(".ibs-route").dropdown("enable"),
this.options.map.html["ibs-header"].find(".ibs-route").button("option","disabled",!1),!0;this.options.map.html["ibs-header"].find(".ibs-route").dropdown("hide");this.options.map.html["ibs-header"].find(".ibs-route").dropdown("disable");$this.options.map.html["ibs-header"].find(".ibs-route").button("option","disabled",!0);return!1};File.prototype.selectSegment=function(a){var b=d(a).hasClass("selected");this.segmentList.find(".segment-item-name").removeClass("selected");this.segmentList.find(".ct-list-div").addClass("hide");
!1===b?(d(a).addClass("selected"),d(a).parent().find(".ct-list-div").removeClass("hide"),this.options.map.html["ibs-header"].find(".ibs-route").dropdown("enable"),this.options.map.html["ibs-header"].find(".ibs-route").button("option","disabled",!1),d(a).parent().ScrollTo({onlyIfOutside:!0})):(this.options.map.html["ibs-header"].find(".ibs-route").dropdown("hide"),this.options.map.html["ibs-header"].find(".ibs-route").dropdown("disable"),this.options.map.html["ibs-header"].find(".ibs-route").button("option",
"disabled",!0))}})(jQuery);
