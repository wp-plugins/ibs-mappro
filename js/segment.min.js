function Segment(f){this.init(f)}
(function(f){Segment.prototype.init=function(a){this.options={map:null,sid:"S1001",path:[],strokeColor:"#000fff",strokeOpacity:.35,strokeWeight:5,name:null,desc:null};for(var b in a)this.options[b]=a[b];null===this.options.name&&(this.options.name=this.options.sid);null===this.options.desc&&(this.options.desc=this.options.sid);this.setMethods();this.segmentList=this.options.map.file.segmentList;this.segmentItem='.segment-item-name[rel="'+this.options.sid+'"]';this.setSegmentItem();this.selected=!1;
this.line=new google.maps.Polyline(this.lineOptions());this.line.setMap(this.options.map.googlemap);this.line.segment=this;this.undoStack=[];this.points=[];this.markerManager=null;this.editing=!1;this.isActive=!0;this.marker=new google.maps.Marker({position:this.options.path[0],map:this.options.map.googlemap,title:this.options.name,icon:this.options.map.imageLineNormal,segment:this});this.distanceMarker=new google.maps.Marker({position:this.options.path[0],map:this.options.map.googlemap,visible:!1,
icon:this.options.map.imageDistancePointer});google.maps.event.addListener(this.marker,"click",f.proxy(function(a){this.isActive&&f(this.segmentItem).trigger("click")},this));this.directionsService=this.directionsRenderer=null;this.refresh();google.maps.event.addListener(this.line,"mouseover",f.proxy(function(a){var b=this.options.map.html["distance-info"];if(!this.editing&&this.isActive&&this.options.map.options.distance&&b.hasClass("hide")){var g=this.nearestPoint(a.latLng),h=this.options.map.convertMeters2(g.distance)+
this.options.map.measure2();this.distanceMarker.setPosition(g.latLng);this.distanceMarker.index=g.index;this.distanceMarker.setVisible(!0);this.distanceMarker.setTitle("");b.text(h);this.options.map.setMenuXY(b,a.latLng);a=parseInt(b.css("top").replace(/px/,""));b.css("top",a-35+"px");b.removeClass("hide")}},this));google.maps.event.addListener(this.line,"mouseout",f.proxy(function(a){var b=this.options.map.html["distance-info"];if(this.isActive)var g=setInterval(f.proxy(function(){clearInterval(g);
b.addClass("hide");this.distanceMarker.setVisible(!1)},this),1E3)},this));google.maps.event.addListener(this.marker,"mouseover",f.proxy(function(a){this.isActive&&this.line.setOptions({strokeWeight:this.options.strokeWeight+4})},this));google.maps.event.addListener(this.marker,"mouseout",f.proxy(function(a){this.isActive&&this.line.setOptions({strokeWeight:this.options.strokeWeight})},this));google.maps.event.addListener(this.marker,"rightclick",f.proxy(function(a){this.isActive&&this.options.map.setClick()},
this));google.maps.event.addListener(this.line,"click",f.proxy(function(a){this.isActive&&(a=this.nearestPoint(a.latLng),this.distanceMarker.setPosition(a.latLng),"edit"==this.options.map.options.mode?this.contextMenuLine(a):f(this.segmentItem).trigger("click"))},this))};Segment.prototype.setOptions=function(a){for(var b in a)this.options[b]=a[b]};Segment.prototype.setMethods=function(){this.pend=null;this.click=function(a){switch(this.pend){case "extend":this.addPoint(a.latLng),!1===f(this.segmentItem).hasClass("selected")&&
this.options.file.selectSegment(f(this.segmentItem)[0]),this.options.map.setClick({sid:this.options.sid})}};this.extend=function(){this.options.map.setClick({sid:this.options.sid,pid:null});this.pend="extend"};this.lineOptions=function(){return{path:this.options.path,strokeWeight:this.options.strokeWeight,strokeColor:this.options.strokeColor,strokeOpacity:this.options.strokeOpacity}}};Segment.prototype.setSegmentItem=function(){var a=this.options.sid;this.segmentList.append(f("<li>").attr({id:this.options.sid}).addClass("segment-item").append(f("<div>").addClass("ct-list-div hide").append(f("<a>").attr({href:"#",
title:"focus segment"}).append(f("<img>").addClass("segment-focus").attr({rel:a,src:this.options.map.siteUrl()+"image/zoom.png"}))).append(f("<a>").attr({href:"#",title:"elevation profile"}).append(f("<img>").addClass("segment-elevation").attr({rel:a,src:this.options.map.siteUrl()+"image/chart.png"}))).append(f("<span>").append(f("<a>").attr({href:"#",title:"generate cue sheet"}).append(f("<img>").addClass("segment-cuesheet").attr({rel:a,src:this.options.map.siteUrl()+"image/cue.png"}).data({segment:this}))))).append(f("<a>").addClass("segment-item-name").attr({rel:a,
href:"#",title:""}).text(this.options.name)))};Segment.prototype.copy=function(){var a={},b;for(b in this.options)"path"!==b&&(a[b]=this.options[b]);a.latlngs=[];this.line.getPath().forEach(function(b){a.latlngs.push({lat:b.lat(0),lng:b.lng()})});a.sid=this.options.sid;return a};Segment.prototype.distanceTo=function(a){var b=0;a=a.getPosition();var c=this.points[0].getPosition();if(c.equals(a))return 0;for(var d=1;d<this.points.length;d++){var g=this.points[d].getPosition(),b=b+distanceFrom(c,g),
c=g;if(a.equals(g))break}return b};Segment.prototype.nearestPoint=function(a){var b=0,c=null,d=null,g=0,h=0,e=this.line.getPath();e.forEach(f.proxy(function(e,h){b=distanceFrom(e,a);if(null===c||b<c)d=e,g=h,c=b},this));for(var l=null,k=null,m=0;m<e.getLength();m++)if(k=e.getAt(m),0<m&&(h+=distanceFrom(l,k)),l=k,k.equals(d)){h+=c;break}return{latLng:d,index:g,distance:h}};Segment.prototype.distance=function(){return pathLength(this.line.getPath())};Segment.prototype.refresh=function(){var a=this.line.getPath().getAt(this.line.getPath().length-
1);this.marker.setPosition(a)};Segment.prototype.remove=function(){this.stopEditing();this.line.setMap(null);this.marker.setMap(null);this.distanceMarker.setMap(null);this.removeWaypoints();this.options.map.html.list.find('.segment-item[rel="'+this.options.sid+'"]').remove();this.options.map.file.removeSegment(this.options.sid)};Segment.prototype._midPoint=function(a,b){return new google.maps.LatLng(b.lat()-.5*(b.lat()-a.lat()),b.lng()-.5*(b.lng()-a.lng()))};Segment.prototype.midPoint=function(a,
b){var c=this.line.getPath(),d=c.getAt(a.index-1),c=c.getAt(a.index),d=this._midPoint(d,c),d=new google.maps.Marker({position:d,map:this.options.map.googlemap,icon:this.options.map.imageNormalMidpoint,draggable:!0,segment:this,index:b,point:a});google.maps.event.addListener(d,"mouseover",function(){this.setIcon(this.segment.options.map.imageNormal);var a=this.segment.distanceTo(this.point)-distanceFrom(this.getPosition(),this.point.getPosition());this.title=this.segment.options.map.convertMeters2(Math.round(100*
a)/100)+this.segment.options.map.measure2()});google.maps.event.addListener(d,"mouseout",function(){this.setIcon(this.segment.options.map.imageNormalMidpoint)});google.maps.event.addListener(d,"dragend",function(){var a=this.getPosition(),b=this.point.index;this.segment.line.getPath().insertAt(b,a);var c=this.segment.point(a,b);this.segment.points.splice(b,0,c);for(var d in this.segment.points)this.segment.points[d].index=parseInt(d);b=this.point.getPosition();this.setPosition(this.segment._midPoint(a,
b))});return d};Segment.prototype.point=function(a,b){var c=new google.maps.Marker({position:a,map:this.options.map.googlemap,icon:this.options.map.imageNormal,draggable:!0,index:b,segment:this,midpoint:null});c.midpoint=0<b?this.midPoint(c,b):null;google.maps.event.addListener(c,"mouseover",function(a){this.setIcon(this.segment.options.map.imageHover);a=this.segment.distanceTo(this);this.setTitle(this.segment.options.map.convertMeters2(Math.round(100*a)/100)+this.segment.options.map.measure2())});
google.maps.event.addListener(c,"mouseout",function(){this.setIcon(this.segment.options.map.imageNormal)});google.maps.event.addListener(c,"drag",function(){this.segment.line.getPath().setAt(this.index,this.getPosition());this.segment.refresh()});google.maps.event.addListener(c,"dragend",function(){var a=this.segment.line.getPath();a.setAt(this.index,this.getPosition());var b=null===this.midpoint||0===this.index?this.segment.points[1]:this;if(2<=this.segment.points.length){var c=a.getAt(b.index-1),
e=a.getAt(b.index);b.midpoint.setPosition(midPoint(c,e));c=parseInt(b.index)+1;c<this.segment.points.length&&(b=this.segment.points[c],c=a.getAt(b.index-1),e=a.getAt(b.index),b.midpoint.setPosition(midPoint(c,e)))}this.segment.refresh()});google.maps.event.addListener(c,"click",function(a){this.segment.contextMenuLineEdit(this.index)});return c};Segment.prototype.followRoad=function(a){var b=this,c={avoidHighways:this.options.map.options.avoidhighways,origin:this.line.getPath().getAt(this.line.getPath().getLength()-
1),destination:a,travelMode:google.maps.DirectionsTravelMode[this.options.map.options.travelmode]};this.options.map.directionsService.route(c,function(c,g){if(g===google.maps.DirectionsStatus.OK)for(var h in c.routes)for(a in c.routes[h].overview_path)b.line.getPath().push(c.routes[h].overview_path[a]);b.refresh()})};Segment.prototype.addPoint=function(a){this.save();this.stopEditing();this.options.map.options.followroad?this.followRoad(a):this.line.getPath().push(a);this.refresh();this.options.file.setDirty(!0)};
Segment.prototype.rebuild=function(){var a=this.line.getPath();this.save();var b=a.getLength(),c=a.getAt(0),a=a.getAt(b-1);this.stopEditing();this.line.setPath([c]);this.addPoint(a);this.undoStack.pop();this.options.map.infowindow.close()};Segment.prototype.waypoint=function(a){var b=this.line.getPath();0<=a&&b.getLength()&&(options={waypoint:!0,position:b.getAt(a),draggable:!1,symbol:"Waypoint",url:"",visible:!0,pid:null},this.options.map.file.addPlacemark(options))};Segment.prototype.split=function(a){var b=
{path:[],strokeColor:this.line.strokeColor,strokeOpacity:this.line.strokeOpacity,strokeWeight:this.line.strokeWeight,name:this.options.name+".",desc:this.options.desc},c=this.line.getPath();if(0<a&&1<c.getLength()){for(this.stopEditing();a<=c.getLength()-1;)b.path.push(c.getAt(a)),c.removeAt(a);this.options.file.addSegment(b);this.refresh();this.options.file.setDirty(!0);this.options.map.setClick(null)}};Segment.prototype.thin=function(){var a=this.line.getPath();this.save();var b=[],c=null;a.forEach(f.proxy(function(a,
g){c?300<distanceFrom(c,a)&&(b.push(a),c=a):c=a},this));a=a.getLength();a-=b.length;this.line.setPath(b);this.options.map.notice("dropped "+a+" points.");this.options.map.file.setDirty(!0)};Segment.prototype.save=function(){var a=[];this.line.getPath().forEach(function(b,c){a.push(b)});this.undoStack.push(a)};Segment.prototype.undo=function(){if(this.undoStack.length){this.stopEditing();var a=this.undoStack.pop();this.line.setPath(a);this.refresh()}};Segment.prototype.flip=function(){var a=this.line.getPath();
this.save();for(var b=[],c=a.getLength();0<c;c--)b.push(a.pop());this.line.setPath(b);this.refresh()};Segment.prototype.getBounds=function(a){this.line.getPath().forEach(function(b,c){a.extend(b)})};Segment.prototype.focus=function(){var a=new google.maps.LatLngBounds;this.getBounds(a);this.options.map.googlemap.fitBounds(a)};Segment.prototype.manageMarkers=function(){this.markerManager&&this.markerManager.clearMarkers();this.marker_cluster=[];for(var a in this.points)this.marker_cluster.push(this.points[a]),
this.points[a].midpoint&&this.marker_cluster.push(this.points[a].midpoint);this.markerManager=new MarkerClusterer(this.options.map.googlemap,this.marker_cluster,{gridSize:50})};Segment.prototype.stopEditing=function(){this.markerManager&&this.markerManager.clearMarkers();for(var a in this.points)this.points[a].setMap(null),null!==this.points[a].midpoint&&this.points[a].midpoint.setMap(null);this.points.length=0;this.editing=!1};Segment.prototype.lineEdit=function(){var a=this;if(this.editing)this.stopEditing();
else{if(0===this.points.length)this.line.getPath().forEach(function(b,d){var g=a.point(b,d);a.points.push(g)}),this.manageMarkers();else for(var b in this.points)this.points[b].setVisible(!0),null!==this.points[b].midpoint&&this.points[b].midpoint.setVisible(!0);this.editing=!0}};Segment.prototype.open=function(){this.options.map.file.openInfo(this)};Segment.prototype.contextMenuLine=function(a){var b=this.options.map.html["segment-cm-line"];b.find(".cm-line-action").data({segment:this,point:a.index});
this.options.map.setMenuXY(b,a.latLng);b.removeClass("hide")};Segment.prototype.contextMenuLineEdit=function(a){var b=this.options.map.html["segment-cm-edit"];b.find(".cm-edit-action").data({segment:this,index:a});this.options.map.setMenuXY(b,this.line.getPath().getAt(a));b.removeClass("hide")};Segment.prototype.contextMenuMarker=function(a){var b=this.options.map.html["segment-cm-marker"];b.find(".cm-marker-action").data({segment:this});this.options.map.setMenuXY(b,a);b.removeClass("hide")};Segment.prototype.removePoint=
function(a){if(this.points.length){var b=this.points[a],c=this.line.getPath();if(1<c.getLength()){this.save();b.setMap(null);null!==b.midpoint&&b.midpoint.setMap(null);c.removeAt(a);this.points.splice(a,1);for(var d in this.points)this.points[d].index=parseInt(d);a<this.points.length&&0<a&&(b=this.points[a-1].getPosition(),c=this.points[a].getPosition(),this.points[a].midmarker.setPosition(midPoint(b,c)));this.refresh();this.parent.setDirty(!0)}}};Segment.prototype.getDirRequestOptions=function(a){var b=
{avoidHighways:!1,avoidTolls:!0,destination:null,durationInTraffic:!1,optimizeWaypoints:!0,origin:null,provideRouteAlternatives:!1,region:null,transitOptions:{},travelMode:"BICYCLING",unitSystem:null,waypoints:null},c;for(c in a)b[c]=a[c];return b};Segment.prototype.getDirRenderOptions=function(a){var b={draggable:!0,map:null,markerOptions:{},polylineOptions:{strokeColor:"#ff0000",strokeWeight:3,strokeOpacity:1},preserveViewport:!1,suppressBicyclingLayer:!1,suppressInfoWindows:!0,suppressMarkers:!1,
suppressPolylines:!1},c;for(c in a)b[c]=a[c];return b};Segment.prototype.cuesheetKill=function(){this.options.map.html.list.find("img.segment-cuesheet").attr({src:this.options.map.siteUrl()+"image/cue.png"}).css({visibility:"visible"});try{this.options.map.html["cuesheet-dialog"].dialog("close")}catch(a){}this.directionsRenderer&&this.directionsRenderer.getMap()&&this.directionsRenderer.setMap(null)};Segment.prototype.metersToStr=function(a,b){return 10>a?{d:b?a.toFixed(2):(3.2808399*a).toFixed(2),
m:b?"m":"ft"}:{d:b?(a/1E3).toFixed(2):(a/1609.344).toFixed(2),m:b?"km":"mi"}};Segment.prototype.cueLine=function(a){var b=this.metersToStr(a.step,a.metric),c=this.metersToStr(a.distance,a.metric),d=a.instructions.split("<div");1<d.length&&(d[1]=removeHtmlStr("<div"+d[1]),d[0]+=" - "+d[1],a.instructions=d[0]);b='<tr><td style="text-align:right; padding-right:5px;">&nbsp;'+b.d+'&nbsp;</td><td style="text-align:center;">&nbsp;'+b.m+'&nbsp;</td><td style="text-align:right; padding-right:5px;">&nbsp;'+
c.d+'&nbsp;</td><td style="text-align:center;">&nbsp;'+c.m+"&nbsp;</td><td>&nbsp;%1&nbsp;</td></tr>";switch(a.type){case "header":return"<p>"+a.instructions+"</p>";case "start":return"<table><tr><th>&nbsp;Step&nbsp;</th><th></th><th>&nbsp;Trip&nbsp;</th><th></th><th>Instructions</th></tr>"+b.replace(/%1/,a.instructions);case "step":return b.replace(/%1/,a.instructions);case "end":return b.replace(/%1/,a.instructions)+"</table>";case "waypoint":return"<table><tr><th>&nbsp;Step&nbsp;</th><th></th><th>&nbsp;Trip&nbsp;</th><th></th><th>Instructions</th></tr>"+
b.replace(/%1/,a.instructions)+"</table>"}};Segment.prototype.cuesheetOut=function(){var a="",b=0,c=this.directionsRenderer.getDirections().routes[0],d=null,g=null,h=0,e={metric:this.options.map.options.metric,header:this.options.map.options.cuesheet_header,type:"header",index:0,distance:0,step:0,instructions:""};e.instructions=c.copyrights;a=this.cueLine(e);for(d=0;d<c.warnings.length;d++)e.instructions=c.warnings[d],a+=this.cueLine(e);for(var f=0;f<c.legs.length;f++){d=c.legs[f];e.type="start";
e.distance=0;e.step=0;e.instructions=d.start_address;a+=this.cueLine(e);e.type="step";for(var k=0;k<d.steps.length;k++)g=d.steps[k],e.index=k+1,e.distance=b,e.step=h,e.instructions=g.instructions,a+=this.cueLine(e),g.distance&&(h=g.distance.value,b+=g.distance.value);e.type="end";e.distance=b;e.step=h;e.instructions=d.end_address;a+=this.cueLine(e)}try{this.options.map.html["cuesheet-dialog"].dialog("isOpen")}catch(m){this.cuesheetDialog()}this.options.map.html["cuesheet-dialog"].find(".cuesheet").val(a)};
Segment.prototype.cuesheetDirections=function(){var a=this;if(this.directionsRenderer&&this.directionsRenderer.getMap())this.cuesheetKill();else{this.directionsService||(this.directionsService=new google.maps.DirectionsService);this.directionsRenderer||(this.directionsRenderer=new google.maps.DirectionsRenderer(this.getDirRenderOptions({})),google.maps.event.addListener(this.directionsRenderer,"directions_changed",function(){a.cuesheetOut()}));var b=[],c=this.line.getPath(),d=c.getAt(0),c=c.getAt(c.getLength()-
1);options={waypoints:0<b.length?b:null,destination:c,origin:d};this.directionsService.route(this.getDirRequestOptions(options),function(b,c){c===google.maps.DirectionsStatus.OK?(a.directionsRenderer.setMap(a.options.map.googlemap),a.directionsRenderer.setDirections(b)):a.options.map.alert(c)})}};Segment.prototype.findWaypoints=function(){var a=[],b;for(b in this.options.file.placemarks){var c=this.options.file.placemarks[b];if("Waypoint"===c.options.symbol)for(var c=c.options.position,d=this.line.getPath().getArray(),
g=0;g<d.length;g++)if(c.equals(d[g])){a.push({pid:b,latlng:c,index:g});break}}a.sort(function(a,b){return a.index-b.index});return a};Segment.prototype.copyWaypoints=function(a){for(var b=this.findWaypoints(),c=0;c<b.length;c++)a.push(this.options.file.placemarks[b[c].pid].copy())};Segment.prototype.removeWaypoints=function(){for(var a=this.findWaypoints(),b=0;b<a.length;b++)this.options.file.placemarks[a[b].pid].remove()};Segment.prototype.cueUpdateWaypoints=function(a){for(var b={url:"",symbol:"Waypoint",
name:null,desc:null,position:null,visible:!0},c=0,d=null,g=0,f=0;f<a.legs.length;f++){d=a.legs[f];b.position=this.nearestPoint(d.start_location).latLng;b.desc="Start - "+d.start_address;b.name=this.options.sid+" 1000";this.options.file.addPlacemark(b);for(var e={type:"waypoint"},l=0;l<d.steps.length;l++){var k=d.steps[l];e.distance=c;e.step=g;e.instructions=k.instructions;b.desc=this.cueLine(e);b.position=this.nearestPoint(k.start_location).latLng;b.name=this.options.sid+" "+(l+1001);this.options.file.addPlacemark(b);
k.distance&&(g=k.distance.value,c+=k.distance.value)}e.distance=c;e.step=g;e.instructions=d.end_address;b.desc=this.cueLine(e);b.position=this.nearestPoint(d.end_location).latLng;b.name=this.options.sid+" "+(l+1002);this.options.file.addPlacemark(b)}};Segment.prototype.cueUpdatePath=function(){if(this.directionsRenderer&&this.directionsRenderer.getMap()){this.removeWaypoints();var a=this.directionsRenderer.getDirections().routes[0];this.line.setPath(a.overview_path);this.cueUpdateWaypoints(a);this.options.desc=
this.options.map.html["cuesheet-dialog"].find(".cuesheet").val();this.options.file.setDirty(!0);this.refresh()}this.options.desc=this.options.map.html["cuesheet-dialog"].find(".cuesheet").val()};Segment.prototype.cuesheetWaypoints=function(){var a=this.findWaypoints(),b;b="<table><tr><th>&nbsp;Step&nbsp;</th><th></th><th>&nbsp;Trip&nbsp;</th><th></th><th>Instructions</th></tr>";for(var c=0;c<a.length;c++){var d=this.options.file.placemarks[a[c].pid].options.desc,g=d.split("</tr>");if(1<g.length){var f=
g[1].indexOf("<tr>");-1<f?(d=d.indexOf("</table>")-1,d=g[1].substr(f,d-f),b+=d+"</tr>"):b+=d}else b+=d}b+="</table>";this.options.map.html["cuesheet-dialog"].find(".cuesheet").val(b);try{this.options.map.html["cuesheet-dialog"].dialog("isOpen")}catch(e){this.cuesheetDialog()}};Segment.prototype.edit=function(){this.segmentDialog()}})(jQuery);
