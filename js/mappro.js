
jQuery(document).ready(function($){function reorderIcons(){$('.current-icon-name').each(function(index,item){var attr='ibs_mappro_icons[index][name]'.replace(/index/,index);$(item).attr('name',attr);});$('.current-icon-url').each(function(index,item){var attr='ibs_mappro_icons[index][url]'.replace(/index/,index);$(item).attr('name',attr);});}
$('#icon-library-select').on('change','',{map:this},function(event){var lib=$('#icon-library-select').val();$('.map-icon').each(function(index,item){if($(item).data("qtip")){$(item).qtip("destroy",true);$(item).removeData("hasqtip");$(item).removeAttr("data-hasqtip");}});$.get(ibs_mappro.ajax,{'action':'ibs_mappro_icons','lib':lib},function(data,status){$('#icon-library-list').empty();for(var i in data){$('#icon-library-list').append('<img class="map-icon" src="'+data[i]+'" title="'+getFilename(data[i])+'" width="32" height="32" />');}
$('.map-icon').qtip();$('.map-icon').draggable({revert:true,activeClass:"ui-state-highlight"});},'json');});$('#current-icon-list').sortable({stop:function(event,ui){reorderIcons();}});$('#garmin-library-select').on('change','',{map:this},function(event){var lib=$('#garmin-library-select').val();$.get(ibs_mappro.ajax,{'action':'ibs_mappro_icons','lib':lib},function(data,status){$('#garmin-library-list').empty();for(var i in data){$('#garmin-library-list').append('<img class="map-icon" src="'+data[i]+'" title="'+getFilename(data[i])+'" width="32" height="32" />');}
$('.map-icon').draggable({revert:true,activeClass:"ui-state-highlight"});},'json');});$('.garmin-icon-name').droppable({accept:'.map-icon',addClasses:false,hoverClass:"ui-state-hover",drop:function(event,ui){var url=ui.draggable.attr('src');var parent=$(this).parents('li')[0];$(parent).find('.garmin-icon-url').val(url);var bg="background:url(%url) left top no-repeat; vertical-align:middle;".replace(/%url/,ui.draggable.attr('src'))
$(parent).attr('style',bg);}});$('.current-icon-name').droppable({accept:'.map-icon',addClasses:false,hoverClass:"ui-state-hover",drop:function(event,ui){var url=ui.draggable.attr('src');$(this).val(getFilename(url));var parent=$(this).parents('li')[0];$(parent).find('.current-icon-url').val(url);var bg="background:url(%url) left top no-repeat; vertical-align:middle;".replace(/%url/,ui.draggable.attr('src'))
$(parent).attr('style',bg);}});$('#icon-add-input').droppable({accept:'.map-icon',addClasses:false,hoverClass:"ui-state-hover",drop:function(event,ui){var url=ui.draggable.attr('src');var name=getFilename(url);var item=$('<input>').addClass('current-icon-name').attr({'type':'text','value':name,'name':'ibs_mappro_icons[0][name]'});var bg="background:url(%url) left top no-repeat; vertical-align:middle;".replace(/%url/,url)
$('#current-icon-list').prepend($('<li>').addClass('current-icon-item').attr({'style':bg}).append($('<div>').append(item).append($('<a>').addClass('icon-delete').text(' ').attr({'href':'#','title':'delete'}))).append($('<input>').addClass('current-icon-url').attr({'type':'hidden','value':url,'name':'ibs_mappro_icons[0][url]'})));reorderIcons()
$(item).droppable({accept:'.map-icon',addClasses:false,hoverClass:"ui-state-hover",drop:function(event,ui){var url=ui.draggable.attr('src');$(this).val(getFilename(url));var bg="background:url(%url) left top no-repeat; vertical-align:middle;".replace(/%url/,ui.draggable.attr('src'))
var parent=$(this).parents('li')[0];$(parent).find('.current-icon-url').val(url);$(parent).attr('style',bg);}});}});$('#current-icon-list').on('click','.icon-delete',{},function(event){$(this).parents('li').eq(0).remove();reorderIcons();});$('#ibs-icon-upload').append($('<div id="upload-dialog" >').addClass('hide dialog-map').attr('title','Upload Icons').append($('<div id="upload-browser" >')).append($('<div>').append($('<span>').append($('<div>').addClass('section-header').html('Target')).append($('<div>').addClass('kmlkmzgpx').append($('<input id="upload-target-directory" >').attr({type:"text",size:"75",value:"/"}))))).append($('<div>').append($('<span>').append($('<div>').addClass('section-header').css({'font-size':'.9em','padding-left':'5px'}).html('status')).append($('<div >').addClass('map-upload-div file-list-div').css('height','100px').append($('<ul id="upload-list" >').addClass(' file-list')))).append($('<div>').css('display','none').append($('<div id="upload-button" >').html('Browse')))));var uploader=$('#upload-button').fineUploader({listElement:$('#upload-list'),request:{endpoint:ibs_mappro.site+'js/jquery.fineuploader/server/endpoint.php',params:{'dir':ibs_mappro.maps_path+'upload/'}},debug:false});uploader.on('complete','',{},function(event,id,fileName,responseJSON){var map=event.data.map;var lib=$('#upload-target-directory').val().replace('/','');var has=false;$('.icon-lib').each(function(index,item){if($(item).val()===lib){has=true;}});if(false===has){$('#icon-library-select').prepend($('<option>').attr({'value':lib}).addClass('icon-lib').text(lib).trigger('change'));}
$('#icon-library-select').val(lib);$('#icon-library-select').trigger('change');});$('#upload-target-directory').on('change','',{},function(event){var root=ibs_mappro.icons_path;var newdir=$('#upload-target-directory').val().replace(root,'');if(newdir.indexOf(root)===-1){newdir=root+newdir;}
if(newdir===root){newdir=root+'new/';}
newdir=newdir+"/";newdir=newdir.replace('//','/');var dir_file=newdir.replace(root,'');$('#upload-target-directory').val(dir_file).focus();uploader.fineUploader('setParams',{'dir':newdir});});$('#ibs-upload-action').on('click','',{},function(event){var dialog=$('#upload-dialog');dialog.dialog({autoOpen:true,width:'auto',modal:true,buttons:{'Select Files':$.proxy(function(){var a=$('#upload-button');var b=a.find('input[qq-button-id]');var c=a.find('input');c.trigger('click');},this),Clear:function(){$('#upload-list').empty();},Close:function(){$(this).dialog('close');}},close:function(){$(this).dialog('destroy');},open:function(){var initdir=ibs_mappro.icons_path+'new/';$('#upload-target-directory').val('new/');uploader.fineUploader('setParams',{'dir':initdir});$('#upload-browser').fileTree({root:ibs_mappro.icons_path,script:ibs_mappro.ajax+'?action=ibs_mappro_folders&type=dir',folderEvent:'click',expandSpeed:1000,collapseSpeed:1000,multiFolder:false},function(file){alert(file);},function(dir){$('#upload-target-directory').val(dir);$('#upload-target-directory').trigger('change');});}});});$('#ibs-icon-clean').append($('<div id="clean-dialog" >').addClass('hide dialog-map').attr('title','Manage Icon Folders').append($('<div id="clean-browser" >')).append($('<div>').append($('<span>').append($('<div>').addClass('section-header').html('Target')).append($('<div>').addClass('kmlkmzgpx').append($('<input id="clean-target-directory" >').attr({type:"text",size:"75",value:"/",disabled:true}))))));$('#ibs-clean-action').on('click','',{},function(event){$('#clean-target-directory').val('')
$('#clean-dialog').dialog({autoOpen:true,width:'auto',modal:true,buttons:{'Remove Files':function(){var files='';$('#clean-browser').find('LI A.selected').each(function(index){files+=$(this).attr('rel')+';';});if(files.length>0){$.get(ibs_mappro.ajax,{'action':'ibs_mappro_remove','type':'files','dir':ibs_mappro.icons_path+$('#clean-target-directory').val(),'files':files},function(data,status){$('#clean-browser').find('LI A.selected').remove();},'TEXT');}},'Remove Folder':function(){$.get(ibs_mappro.ajax,{action:'ibs_mappro_remove',type:'directory','dir':ibs_mappro.icons_path+$('#clean-target-directory').val()},function(data,status){$('#clean-browser').find('LI.expanded').remove();var lib=$('#clean-target-directory').val().replace('/','');$('.icon-lib').each(function(index,item){if($(item).val()===lib){$(item).remove();}});},'TEXT');},Close:function(){$(this).dialog('close');}},close:function(){$(this).dialog('destroy');},open:function(){$('#clean-browser').fileTree({root:ibs_mappro.icons_path,script:ibs_mappro.ajax+'?action=ibs_mappro_folders&type=all',folderEvent:'click',expandSpeed:0,collapseSpeed:0,multiFolder:false},function(file){if(event.shiftKey){var first=false;var found=false;var rel=$(this).attr('rel');$(this).parent().parent().find('A').each(function(n){if(!found||!first){if($(this).attr('rel')===rel){found=true;}else{if($(this).hasClass('selected')&&!first){first=true;}}
if(first||found){$(this).addClass('selected');}}else{$(this).removeClass('selected');}});}else{if(event.ctrlKey){$(this).toggleClass('selected');}else{var has=$(this).hasClass('selected');$(this).parent().parent().find('A').removeClass('selected');if(false===has){$(this).addClass('selected');}}}},function(dir){$('#clean-target-directory').val(dir.replace(ibs_mappro.icons_path,''));});}});});$('#ibs-map-clean').append($('<div id="map-dialog" >').addClass('hide dialog-map').attr('title','Manage Map Folders').append($('<div id="map-browser" >')).append($('<div>').append($('<span>').append($('<div>').addClass('section-header').html('Target')).append($('<div>').addClass('kmlkmzgpx').append($('<input id="map-target-directory" >').attr({type:"text",size:"75",value:"/",disabled:true}))))));$('#ibs-map-manage').on('click','',{},function(event){$('#map-target-directory').val('')
$('#map-dialog').dialog({autoOpen:true,width:'auto',modal:true,buttons:{'Remove Files':function(){var files='';$('#map-browser').find('LI A.selected').each(function(index){files+=$(this).attr('rel')+';';});if(files.length>0){$.get(ibs_mappro.ajax,{'action':'ibs_mappro_remove','type':'files','dir':ibs_mappro.maps_path+$('#map-target-directory').val(),'files':files},function(data,status){$('#map-browser').find('LI A.selected').remove();},'TEXT');}},'Remove Folder':function(){$.get(ibs_mappro.ajax,{action:'ibs_mappro_remove',type:'directory','dir':ibs_mappro.maps_path+$('#map-target-directory').val()},function(data,status){$('#map-browser').find('LI.expanded').remove();var lib=$('#map-target-directory').val().replace('/','');},'TEXT');},Close:function(){$(this).dialog('close');}},close:function(){$(this).dialog('destroy');},open:function(){$('#map-browser').fileTree({root:ibs_mappro.maps_path,script:ibs_mappro.ajax+'?action=ibs_mappro_folders&type=all',folderEvent:'click',expandSpeed:0,collapseSpeed:0,multiFolder:false},function(file){if(event.shiftKey){var first=false;var found=false;var rel=$(this).attr('rel');$(this).parent().parent().find('A').each(function(n){if(!found||!first){if($(this).attr('rel')===rel){found=true;}else{if($(this).hasClass('selected')&&!first){first=true;}}
if(first||found){$(this).addClass('selected');}}else{$(this).removeClass('selected');}});}else{if(event.ctrlKey){$(this).toggleClass('selected');}else{var has=$(this).hasClass('selected');$(this).parent().parent().find('A').removeClass('selected');if(false===has){$(this).addClass('selected');}}}},function(dir){$('#map-target-directory').val(dir.replace(ibs_mappro.maps_path,''));});}});});$('#shortcode-browser').fileTree({root:ibs_mappro.maps_path,script:ibs_mappro.ajax+'?action=ibs_mappro_folders&type=map',folderEvent:'click',expandSpeed:0,collapseSpeed:0,multiFolder:false},function(file){file=file.replace(ibs_mappro.maps_path,ibs_mappro.maps_url);$('#shortcode-url').val(file);$('#shortcode-url').trigger('change');},function(dir){});$('#shortcode-options').on('change','.shortcode-input',{},function(event){var result='[ibs-mappro ';$('#shortcode-options').find('select').each(function(index,item){if($(item).val()!==''){result+=$(item).attr('name')+'="'+$(item).val()+'" ';}});$('#shortcode-options').find('input').each(function(index,item){if($(item).val()!==''){result+=$(item).attr('name')+'="'+$(item).val()+'" ';}});$('#shortcode').val(result+']');});});
(function($)
{Map.prototype.setLineAttr=function(selectId){return $('<span>').addClass('view-hide').append($('<div>').addClass('section-header').html('Line Attributes')).append($('<div>').addClass('line-attr').append($('<span>').addClass('line-attr-span').html('Opacity')).append($('<input>').attr({'type':'text','value':'.5','max':'1.0','min':'0.1','step':'0.1'}).addClass('opacity-val')).append($('<span>').addClass('line-attr-span').html('Width')).append($('<input>').attr({'type':'text','value':'2','max':'15','min':'1','step':'1'}).addClass('width-val')).append($('<select>').addClass(selectId)));};Map.prototype.setFileExtension=function(){return $('<span>').addClass('view-hide').append($('<span>').append($('<div>').addClass('section-header').html('File type')).append($('<div>').addClass('kmlkmzgpx').append($('<span>').html('*.kml').append($('<input>').addClass('file-kml').attr({'type':'radio','value':'kml','name':'file_ext'}))).append($('<span>').html('*.kmz').append($('<input>').addClass('file-kmz').attr({'type':'radio','value':'kmz','name':'file_ext'}))).append($('<span>').html('*.gpx').append($('<input>').addClass('file-gpx').attr({'type':'radio','value':'gpx','name':"file_ext"}))))).append($('<span>').addClass('file-ext-span').append($('<div>').addClass('section-header').text('GPX content settings')).append($('<div>').addClass('box-div').append($('<span>').text('Tracks').append($('<input>').addClass('gpx_tracks').attr({type:"checkbox",title:"output tracks "}))).append($('<span>').text('Routes').append($('<input>').addClass('gpx_routes').attr({type:"checkbox",title:"output routes "}))).append($('<span>').text('Waypoints').append($('<input>').addClass('gpx_waypoints').attr({type:"checkbox",title:"output waypoints"}))).append($('<span>').text('Placemarks').append($('<input>').addClass('gpx_waypoints').attr({type:"checkbox",title:"output placemarks"})))))};Map.prototype.setDialogs=function(){this.html['dialogs']=this.html['ibs-container'].append($('<div>'));this.html['dialogs'].append($('<div>').addClass('placemark-dialog hide dialog-map').attr({'title':'Placemark'}).append($('<div>').addClass('info-div edit-hdr-div').append(($('<span>').append($('<div>').addClass('section-header').html('Name'))).append($('<div>').addClass('kmlkmzgpx').append(($('<input>').addClass('placemark-dialog-name view-disable').attr({'type':'text','size':32,'value':''}))))).append($('<span>').append($('<span>').addClass('kmlkmzgpx').append($('<div class="placemark-selected-div">').append($('<img>').addClass('placemark-selected-icon').attr({'src':'','height':'32','width':'32','title':'current icon'}).css('vertical-align','middle')).append($('<span style="font-weight:bold; margin-left:10px">').text('Current Icon'))).append($('<div>').addClass('placemark-select-div view-hide ').append($('<ul>').addClass('placemark-dialog-select')))))).append($('<div>').addClass('edit-ck-div').append($('<textarea>').addClass('placemark-dialog-desc view-hide').attr({'rows':5,'cols':32}))).append($('<input>').addClass('placemark-dialog-pid').attr({'type':'hidden','value':''})));this.html['placemark-dialog']=this.html['dialogs'].find('.placemark-dialog');this.html['dialogs'].append($('<div>').addClass('waypoint-dialog hide').attr({'title':'Waypoint'}).append($('<div>').addClass('box-div').append($('<input>').addClass('waypoint-dialog-name view-disable').attr({'type':'text','size':'32','value':''}))).append($('<div>').addClass('edit-ck-div').append($('<textarea>').addClass('waypoint-dialog-desc view-hide').css({'margin-top':'25px'}).attr({'rows':'5','cols':'32'}))).append($('<input>').addClass('placemark-dialog-pid').attr({'type':'hidden','value':''})));this.html['waypoint-dialog']=this.html['dialogs'].find('.waypoint-dialog');this.html['dialogs'].append($('<div>').addClass('placemark-show hide dialog-map').attr('title','Segment').append($('<div>').addClass('info-div edit-hdr-div').append($('<span>').append($('<div>').addClass('section-header').html('Name')).append($('<div>').addClass('kmlkmzgpx').append($('<input>').addClass('placemark-dialog-name').attr({'type':'text','value':''}))))).append($('<div>').addClass('edit-ck-div').append($('<div>').addClass('placemark-dialog-desc'))).append($('<input>').addClass('placemark-dialog-pid').attr({'type':'hidden','value':'0'})));this.html['placemark-show']=this.html['dialogs'].find('.placemark-show');this.html['dialogs'].append($('<div>').addClass('segment-dialog hide dialog-map').attr('title','Segment').append($('<div>').addClass('info-div edit-hdr-div').append($('<span>').append($('<div>').addClass('section-header').html('Name')).append($('<div>').addClass('kmlkmzgpx').append($('<input>').addClass('segment-dialog-name view-disable').attr({'type':'text','value':''})))).append(this.setLineAttr('segment-dialog-color-select')).append($('<span>').append($('<div>').addClass('section-header').html('Statistics')).append($('<span>').addClass('segment-dialog-stats')))).append($('<div>').addClass('edit-ck-div').append($('<textarea>').addClass('segment-dialog-desc view-hide').attr({'rows':'2','cols':'50'}))).append($('<input>').addClass('segment-dialog-sid').attr({'type':'hidden','value':'0'})));this.html['segment-dialog']=this.html['dialogs'].find('.segment-dialog');this.html['dialogs'].append($('<div>').addClass('segment-show hide dialog-map').attr('title','Segment').append($('<div>').addClass('info-div edit-hdr-div').append($('<span>').append($('<div>').addClass('section-header').html('Name')).append($('<div>').addClass('kmlkmzgpx').append($('<input>').addClass('segment-dialog-name view-disable').attr({'type':'text','value':''})))).append($('<span>').append($('<div>').addClass('section-header').html('Statistics')).append($('<span>').addClass('segment-dialog-stats')))).append($('<div>').addClass('edit-ck-div').append($('<div>').addClass('segment-dialog-desc view-hide'))).append($('<input>').addClass('segment-dialog-sid').attr({'type':'hidden','value':'0'})));this.html['segment-show']=this.html['dialogs'].find('.segment-show');this.html['dialogs'].append($('<div>').addClass('find-dialog hide dialog-map').attr({'title':'Find Address'}).append($('<div>').addClass('ibs-find-box file-list-box').append($('<input>').addClass('find-words').attr({'type':'text','name':'words','size':'50','value':''}))).append($('<div>').addClass('find-div file-list-div').append($('<ul>').addClass('find-list file-list'))));this.html['find-dialog']=this.html['dialogs'].find('.find-dialog');this.html['dialogs'].append($('<div>').addClass('save-dialog hide dialog-map').attr({'title':'Save File'}).addClass('').append($('<div>').addClass('file-save-box').addClass('edit-hdr-div').append($('<span>').addClass('mapfolder-span').append($('<div>').addClass('section-header').html(' Map Folders ')).append($('<div>').addClass('mapfolder-div')).append($('<div>').addClass('mapfolder-browser JQueryFTD'))).append($('<span>').append($('<div>').addClass('section-header').html('Save As')).append($('<div>').addClass('kmlkmzgpx').append($('<span>').html('Folder').append($('<input>').addClass('save-dir').attr({'type':'text','size':'20','value':''}))).append($('<span>').html('Name').append($('<input>').addClass('save-name').attr({'type':'text','size':'20','value':''}))).append($('<span>').html('Download').addClass('hide').append($('<input>').addClass('save-download').attr({'type':"checkbox"}))))).append(this.setFileExtension())).append($('<div>').addClass('edit-ck-div').css('width','100%').append($('<textarea>').addClass('save-desc').attr({'rows':'10','cols':'50'}))));this.html['save-dialog']=this.html['dialogs'].find('.save-dialog');this.html['dialogs'].append($('<div>').addClass('file-dialog hide dialog-map').attr({'title':'Map settings'}).append($('<div>').addClass('info-div file-box edit-hdr-div').append($('<span>').append($('<div>').addClass('section-header').html('File Name')).append($('<div>').addClass('kmlkmzgpx').append($('<input>').addClass('file-name view-disable').css('margin','5px').attr({'type':'text','size':'30','value':''}))).append(this.setFileExtension())).append($('<span>').append($('<div>').addClass('section-header').html('Statistics')).append($('<ul>').addClass('file-list ct-help-list'))).append(this.setLineAttr('file-dialog-color-select'))).append($('<div>').addClass('edit-ck-div').css('width','100%').append($('<textarea>').addClass('file-desc view-hide').attr({'rows':'3','cols':'50'}))));this.html['file-dialog']=this.html['dialogs'].find('.file-dialog');this.html['file-dialog'].find('.line-attr').append($('<div>').css('float','right').append($('<button>').addClass('reset-lines').attr({'title':'reset all lines to these attributes'}).text('Reset lines').css({'margin-left':'15px'})));this.html['dialogs'].append($('<div>').addClass('file-show hide dialog-map').attr({'title':'Map settings'}).append($('<div>').addClass('info-div file-box edit-hdr-div').append($('<span>').append($('<div>').addClass('section-header').html('File Name')).append($('<div>').addClass('kmlkmzgpx').append($('<input>').addClass('file-name').css('margin','5px').attr({'type':'text','size':'30','value':''})))).append($('<span>').append($('<div>').addClass('section-header').html('Statistics')).append($('<ul>').addClass('file-list ct-help-list')))).append($('<div>').addClass('edit-ck-div').css('width','100%').append($('<div>').addClass('file-desc view-hide').attr({'rows':'3','cols':'50'}))));this.html['file-show']=this.html['dialogs'].find('.file-show');this.html['dialogs'].append($('<div>').addClass('cuesheet-dialog hide dialog-map').attr({'title':'Cuesheet'}).append($('<textarea>').addClass('cuesheet').attr({'rows':'50','cols':'70'})));this.html['cuesheet-dialog']=this.html['dialogs'].find('.cuesheet-dialog');this.html['dialogs'].append($('<div>').addClass('browse-dialog hide dialog-map').attr('title','Browse maps').append($('<div>').append($('<span>').append($('<div>').addClass('section-header').html('Map Folders')).append($('<div>').addClass('map-browser-div').append($('<div>').addClass('map-browser JQueryFTD'))))));this.html['browse-dialog']=this.html['dialogs'].find('.browse-dialog');this.html['dialogs'].append($('<div>').addClass('upload-dialog hide dialog-map').attr('title','Upload maps').append($('<div>').addClass('upload-browser admin')).append($('<div>').addClass('admin').append($('<span>').append($('<div>').addClass('section-header').html('Target')).append($('<div>').addClass('kmlkmzgpx').append($('<input>').attr({type:"text",size:"75",value:"/"}).addClass("upload-target-directory"))))).append($('<div>').append($('<span>').append($('<div>').addClass('section-header').css({'font-size':'.9em','padding-left':'5px'}).html('status')).append($('<div>').addClass('map-upload-div file-list-div').css('height','100px').append($('<ul>').addClass('upload-list file-list')))).append($('<div>').css('display','none').append($('<div>').addClass('upload-button').html('Browse')))));this.html['upload-dialog']=this.html['dialogs'].find('.upload-dialog');this.html['dialogs'].append($('<div>').addClass('web-dialog hide dialog-map').attr('title','Open map').append($('<div>').append($('<span>').append($('<div>').addClass('section-header').html('Map URL to load')).append($('<div>').addClass('kmlkmzgpx').append($('<input>').addClass('map-web-url').attr({'type':'text','title':'enter url to load from the web','size':'50'}))))))
this.html['web-dialog']=this.html['dialogs'].find('.web-dialog');this.html['map'].append($('<div>').addClass('segment-cm-line context-menu hide').append($('<ul>').addClass('cm-list').append($('<li>').append($('<a>').addClass('cm-line-action').attr({'href':'#','rel':'split','title':'split line here'}).html('Split'))).append($('<li>').addClass('img_placemark').append($('<a>').addClass('cm-line-action').attr({'href':'#','rel':'waypoint','title':'add waypoint'}).html('Waypoint'))).append($('<li>').addClass('img_line-edit').append($('<a>').addClass('cm-line-action').attr({'href':'#',rel:'line-edit',title:'segment line editing'}).html('Line-edit'))).append($('<li>').append($('<a>').addClass('cm-line-action').attr({'href':'#','rel':'close'}).html('Close')))));this.html['segment-cm-line']=this.html['map'].find('.segment-cm-line');this.html['map'].append($('<div>').addClass('segment-cm-edit context-menu hide').append($('<ul>').addClass('cm-list').append($('<li>').append($('<a>').addClass('cm-edit-action').attr({'href':'#','rel':'clear'}).html('Clear'))).append($('<li>').append($('<a>').addClass('cm-edit-action').attr({'href':'#','rel':'delete'}).html('Delete point'))).append($('<li>').append($('<a>').addClass('cm-edit-action').attr({'href':'#','rel':'split'}).html('Split'))).append($('<li>').append($('<hr/>'))).append($('<li>').append($('<a>').addClass('cm-edit-action').attr({'href':'#','rel':'close'}).html('Close')))));this.html['segment-cm-edit']=this.html['map'].find('.segment-cm-edit');this.html['map'].append($('<div style="width:200px;">').addClass('placemark-cm-info context-menu hide').append($('<div>').addClass('placemark-cm-name')).append($('<div>').addClass('placemark-cm-desc')));this.html['placemark-cm-info']=this.html['map'].find('.placemark-cm-info');this.html['map'].append($('<div>').addClass('distance-info hide'));this.html['distance-info']=this.html['map'].find('.distance-info');};Map.prototype.findDialog=function(){var dialog=this.html['find-dialog'];dialog.dialog({autoOpen:true,modal:false,width:'auto',buttons:{Find:$.proxy(function(){this.findLocation();},this),Close:function(){$(this).dialog('close');}},close:$.proxy(function(){dialog.dialog('destroy');},this)});};Map.prototype.browseDialog=function(){var dialog=this.html['browse-dialog'];dialog.dialog({autoOpen:true,width:600,modal:true,buttons:{Close:function(){$(this).dialog('close');}},close:function(){$(this).dialog('destroy');},open:$.proxy(function(){var dir=this.isGuest()?ibs_mappro.maps_path+"share/":ibs_mappro.maps_path;dialog.find('.map-browser').fileTree({root:dir,script:ibs_mappro.ajax+'?action=ibs_mappro_folders&type=map',folderEvent:'click',expandSpeed:0,collapseSpeed:0,multiFolder:false},$.proxy(function(file){var map=file.replace(ibs_mappro.maps_path,ibs_mappro.maps_url);this.file.importFile(map);dialog.dialog('close');},this),function(dir){});},this)});};Map.prototype.uploadDialog=function(){var dialog=this.html['upload-dialog'];dialog.dialog({autoOpen:true,width:'auto',modal:true,buttons:{'Select Files':$.proxy(function(){var a=this.html['upload-dialog'].find('.upload-button');var b=a.find('input[qq-button-id]');var c=a.find('input')
c.trigger('click');},this),Clear:function(){dialog.find('.upload-list').empty();},Close:function(){$(this).dialog('close');}},close:function(){$(this).dialog('destroy');},open:$.proxy(function(){var initdir=ibs_mappro.maps_path+'upload/';dialog.find('.upload-target-directory').val('upload/');this.uploader.fineUploader('setParams',{'dir':initdir});if(this.isAdmin()){dialog.find('.admin').removeClass('hide');dialog.find('.upload-browser').fileTree({root:ibs_mappro.maps_path,script:ibs_mappro.ajax+'?action=ibs_mappro_folders&type=dir',folderEvent:'click',expandSpeed:1000,collapseSpeed:1000,multiFolder:false},function(file){alert(file);},$.proxy(function(dir){dialog.find('.upload-target-directory').val(dir);dialog.find('.upload-target-directory').trigger('change');},this));}else{dialog.find('.admin').addClass('hide');var a=dialog.find('.upload-button');var b=a.find('input[qq-button-id]');var c=a.find('input')
c.trigger('click');}},this)});};Map.prototype.webDialog=function(){var dialog=this.html['web-dialog'];dialog.dialog({autoOpen:true,width:'auto',modal:true,buttons:{Open:$.proxy(function(){var url=this.html['web-dialog'].find('.map-web-url').val();if(url&&isUrl(url)){dialog.dialog('close');this.file.importFile(url);}else{this.alert('invalid URL.');}},this),Close:function(){$(this).dialog('close');}},close:function(){$(this).dialog('destroy');},open:$.proxy(function(){},this)});};File.prototype.getOptions=function(dialog){switch(getExtension(this.filename)){case'kmz':dialog.find('.file-kmz').attr('checked',true);break;case'gpx':dialog.find('.file-gpx').attr('checked',true);break;default:dialog.find('.file-kml').attr('checked',true);}
dialog.find('.gpx_routes').attr('checked',this.options.gpx_routes);dialog.find('.gpx_tracks').attr('checked',this.options.gpx_tracks);dialog.find('.gpx_waypoints').attr('checked',this.options.gpx_waypoints);dialog.find('.gpx_placemarks').attr('checked',this.options.gpx_placemarks);}
File.prototype.setOptions=function(dialog){this.options.gpx_routes=dialog.find('.gpx_routes').is(':checked');this.options.gpx_tracks=dialog.find('.gpx_tracks').is(':checked');this.options.gpx_waypoints=dialog.find('.gpx_waypoints').is(':checked');this.options.gpx_placemarks=dialog.find('.gpx_placemarks').is(':checked');}
File.prototype.saveDialog=function(){var map=this.options.map;var dialog=map.html['save-dialog'];var config=map.getCkeditorConfig();this.getOptions(dialog);dialog.find('.save-name').val(this.filename);dialog.find('.save-dir').val(map.getUserFolder());dialog.find('.save-desc').val(this.desc);dialog.dialog({autoOpen:true,modal:true,width:'auto',buttons:{Save:$.proxy(function(){if(this.checkMapname(dialog.find('.save-name').val())){this.options.desc=dialog.find('.save-desc').val();this.dir=dialog.find('.save-dir').val();this.dir=map.isGuest()?'share/'+this.dir:this.dir
this.filename=dialog.find('.save-name').val();if(false===getExtension(this.filename)){}
map.html['list'].find('a.file-list-name').text(this.filename);this.setOptions(dialog);dialog.dialog('close');this.saveAs(false);}else{alert('invalid filename.\n Only "A-Z a-z 0-9 _ - space" characters are allowed\n 3 - 50 characters long.');}},this),Cancel:function(){$(this).dialog('close');}},open:function(){dialog.find('.mapfolder-browser').fileTree({root:ibs_mappro.maps_path,script:ibs_mappro.ajax+'?action=ibs_mappro_folders&type=dir',folderEvent:'click',expandSpeed:0,collapseSpeed:0,multiFolder:false},function(file){alert(file);},function(dir){var arr=dir.split('/maps/');dialog.find('.save-dir').val(arr[1]);dialog.find('.save-dir').trigger('change');});dialog.find('.save-desc').ckeditor(config);dialog.find('.save-desc').ckeditor().resize('100%','100%',false);},close:function(){dialog.find('.save-desc').ckeditorGet().destroy();$(this).dialog('destroy');},resize:function(ev){dialog.find('.save-desc').ckeditor().resize('100%','100%',false);}});};File.prototype.fileDialog=function(){var dialog=this.options.map.html['file-dialog'];this.getOptions(dialog);this.options.map.stats(dialog.find('.file-list'),this.distance(),Object.keys(this.segments).length,Object.keys(this.placemarks).length);dialog.find('.file-name').val(this.filename);dialog.find('.file-desc').val(this.desc);dialog.find('.colorpicker-trigger').css('background-color',this.options.strokeColor);dialog.find('.colorpicker-trigger').css('opacity',parseFloat(this.options.strokeOpacity).toFixed(1));dialog.find('.colorpicker-trigger').css('height',this.options.strokeWeight+'px');var pad=parseInt((30-this.options.strokeWeight)/2);dialog.find('.colorpicker-trigger').css('margin-top',pad+'px');dialog.find('.opacity-val').val(parseFloat(this.options.strokeOpacity).toFixed(1));dialog.find('.width-val').val(parseInt(this.options.strokeWeight));var config=this.options.map.getCkeditorConfig()
setCurrentColor(dialog);dialog.dialog({autoOpen:true,modal:true,width:'auto',buttons:{Update:$.proxy(function(){if(this.checkMapname(dialog.find('.file-name').val())){var obj=dialog.find('.colorpicker-trigger');var color=rgb2hex($(obj).css('background-color'));var opacity=parseFloat($(obj).css('opacity')).toFixed(3);var width=parseInt($(obj).css('height').replace(/px/,''));this.setOptions(dialog)
this.options.strokeColor=color;this.options.strokeOpacity=opacity;this.options.strokeWeight=width;this.setDirty(this.dirty||dialog.find('.file-name').val()!==this.filename||dialog.find('.file-desc').val()!==this.desc);this.filename=dialog.find('.file-name').val();this.desc=dialog.find('.file-desc').val();this.options.map.html['list'].find('.list-filename').text(this.filename);dialog.dialog('close');}
else{alert('invalid kml, kmz, gpx filename.');}},this),Close:function(){$(this).dialog('close');}},open:function(){dialog.find('.file-desc').ckeditor(config);dialog.find('.file-desc').ckeditor().resize('100%','100%',false);},close:function(){dialog.find('.file-desc').ckeditorGet().destroy();$(this).dialog('destroy');},resize:function(ev){dialog.find('.file-desc').ckeditor().resize('100%','100%',false);}});};File.prototype.show=function(){var dialog=this.options.map.html['file-show'];this.getOptions(dialog);this.options.map.stats(dialog.find('.file-list'),this.distance(),Object.keys(this.segments).length,Object.keys(this.placemarks).length);dialog.find('.file-name').val(this.filename).attr({'disabled':true});dialog.find('.file-desc').html(this.desc);dialog.dialog({autoOpen:true,modal:true,width:'auto',buttons:{Close:function(){$(this).dialog('close');}},close:function(){$(this).dialog('destroy');}});};Segment.prototype.segmentDialog=function(){var dialog=this.options.map.html['segment-dialog'];var config=this.options.map.getCkeditorConfig();var list=dialog.find('.segment-dialog-color-select option');var strokeColor=this.options.strokeColor.toLowerCase();$.each(list,function(index,item){if(item.value.toLowerCase()===strokeColor){$(item).attr('selected',true);}else{$(item).removeAttr('selected');}});dialog.find('.segment-dialog-fid').val(this.options.fid);dialog.find('.segment-dialog-sid').val(this.options.sid);dialog.find('.segment-dialog-desc').val(this.options.desc);dialog.find('.segment-dialog-name').val(this.options.name);dialog.find('.colorpicker-trigger').css('background-color',this.options.strokeColor);dialog.find('.colorpicker-trigger').css('opacity',parseFloat(this.options.strokeOpacity).toFixed(1));dialog.find('.colorpicker-trigger').css('height',this.options.strokeWeight+'px');var pad=parseInt((30-this.options.strokeWeight)/2);dialog.find('.colorpicker-trigger').css('margin-top',pad+'px');dialog.find('.opacity-val').val(parseFloat(this.options.strokeOpacity).toFixed(1));dialog.find('.width-val').val(this.options.strokeWeight);dialog.find('.segment-dialog-stats').html(' miles='+this.options.map.convertMeters2(this.distance()).toString()+' points: '+this.line.getPath().getLength());setCurrentColor(dialog);dialog.dialog({autoOpen:true,width:600,modal:true,buttons:{Update:$.proxy(function(){var obj=dialog.find('.colorpicker-trigger');this.options.strokeColor=rgb2hex($(obj).css('background-color'));this.options.strokeOpacity=parseFloat($(obj).css('opacity')).toFixed(3);this.options.strokeWeight=parseInt($(obj).css('height').replace(/px/,''));this.options.name=dialog.find('.segment-dialog-name').val();this.options.desc=dialog.find('.segment-dialog-desc').val();this.line.setOptions({strokeColor:this.options.strokeColor,strokeOpacity:this.options.strokeOpacity,strokeWeight:this.options.strokeWeight});this.options.file.setDirty(true);$(this.segmentList).find(this.segmentItem).html(this.options.name);dialog.dialog('close');},this),Close:function(){$(this).dialog('close');}},open:function(){dialog.find('.segment-dialog-desc').ckeditor(config);dialog.find('.segment-dialog-desc').ckeditor().resize('100%','100%',false);},close:function(){dialog.find('.segment-dialog-desc').ckeditorGet().destroy();$(this).dialog('destroy');},resize:function(ev){dialog.find('.segment-dialog-desc').ckeditor().resize('100%','100%',false);}});};Segment.prototype.cuesheetDialog=function(){var dialog=this.options.map.html['cuesheet-dialog'];var config=this.options.map.getCkeditorConfig();dialog.find('.cuesheet').data({'segment':this});this.options.map.html['cuesheet-dialog'].dialog({autoOpen:true,resizable:true,draggable:true,width:600,modal:false,buttons:{Update:$.proxy(function(){this.cueUpdatePath();},this),Close:$.proxy(function(){dialog.dialog('close');},this)},open:function(){this.isActive=false;dialog.find('.cuesheet').ckeditor(config);},close:$.proxy(function(){this.isActive=true;dialog.find('.cuesheet').ckeditorGet().destroy();dialog.dialog('destroy');if(this.directionsRenderer&&this.directionsRenderer.getMap()){this.directionsRenderer.setMap(null);}
this.cuesheetKill();},this)});};Segment.prototype.show=function(){var dialog=this.options.map.html['segment-show'];dialog.find('.segment-dialog-sid').val(this.options.sid);dialog.find('.segment-dialog-desc').html(this.options.desc);dialog.find('.segment-dialog-name').val(this.options.name).attr({'disabled':true});dialog.find('.segment-dialog-stats').html(' miles='+this.options.map.convertMeters2(this.distance()).toString()+' points: '+this.line.getPath().getLength());dialog.dialog({autoOpen:true,width:600,modal:true,buttons:{Close:function(){$(this).dialog('close');}},close:function(){$(this).dialog('destroy');}});};Placemark.prototype.show=function(){var dialog=this.options.map.html['placemark-show'];dialog.find('.placemark-dialog-pid').val(this.options.pid);dialog.find('.placemark-dialog-desc').html(this.options.desc);dialog.find('.placemark-dialog-name').val(this.options.name).attr({'disabled':true});dialog.dialog({autoOpen:true,width:600,modal:true,buttons:{Close:function(){$(this).dialog('close');}},close:function(){$(this).dialog('destroy');}});};Placemark.prototype.placemarkDialog=function(){var dialog=this.options.map.html['placemark-dialog'];var config=this.options.map.getCkeditorConfig();this.options.map.infowindow.close();if(this.options.symbol==='Waypoint'){dialog=this.options.map.html['waypoint-dialog'];dialog.find('.waypoint-dialog-name').val(this.options.name);dialog.find('.waypoint-dialog-fid').val(this.options.fid);dialog.find('.waypoint-dialog-pid').val(this.options.pid);dialog.find('.waypoint-dialog-desc').val(this.options.desc);dialog.dialog({autoOpen:true,height:'auto',width:600,modal:true,zIndex:100,buttons:{Update:$.proxy(function(){this.setName(dialog.find('.waypoint-dialog-name').val());$(this.placemarkList).find(this.placemarkItem).text(dialog.find('.waypoint-dialog-name').val());this.options.desc=dialog.find('.waypoint-dialog-desc').val();this.marker.setVisible(true);dialog.dialog('close');this.options.file.setDirty(true);},this),Close:function(){$(this).dialog('close');}},close:function(){dialog.find('.waypoint-dialog-desc').ckeditorGet().destroy();$(this).dialog('destroy');},open:function(){dialog.find('.waypoint-dialog-desc').ckeditor(config);dialog.find('.waypoint-dialog-desc').ckeditor().resize('100%','100%',false);},resize:function(ev){dialog.find('.waypoint-dialog-desc').ckeditor().resize('100%','100%',false);}});}else{dialog=this.options.map.html['placemark-dialog'];dialog.find('.placemark-selected-icon').attr('src',this.options.url);dialog.find('.placemark-dialog-name').val(this.options.name);dialog.find('.placemark-dialog-fid').val(this.options.fid);dialog.find('.placemark-dialog-pid').val(this.options.pid);dialog.find('.placemark-dialog-desc').val(this.options.desc);dialog.dialog({autoOpen:true,height:'auto',width:600,modal:true,buttons:{Update:$.proxy(function(){this.setName(dialog.find('.placemark-dialog-name').val());this.options.url=dialog.find('.placemark-selected-icon').attr('src');this.setIcon();$(this.placemarkList).find(this.placemarkItem).text(dialog.find('.placemark-dialog-name').val());$(this.placemarkList).find(this.placemarkItem).parent().find('img').attr('src',this.options.url);this.options.desc=dialog.find('.placemark-dialog-desc').val();this.marker.setVisible(true);dialog.dialog('close');this.options.file.setDirty(true);},this),Close:function(){$(this).dialog('close');}},close:function(){dialog.find('.placemark-dialog-desc').ckeditorGet().destroy();$(this).dialog('destroy');},open:function(){dialog.find('.placemark-dialog-desc').ckeditor(config);dialog.find('.placemark-dialog-desc').ckeditor().resize('100%','100%',false);},resize:function(ev){dialog.find('.placemark-dialog-desc').ckeditor().resize('100%','100%',false);}});}};})(jQuery);
(function($){Map.prototype.elevation=function(segment){this.selectedPoint=null;this.elevationSegment=segment;try{segment.focus();}catch(err){this.elevationSegment=null;return;}
this.sizeHtml();this.elevationService=new google.maps.ElevationService();this.elevationChart=new google.visualization.AreaChart(this.html['data-chart'][0]);this.elevations=[];google.visualization.events.addListener(this.elevationChart,'onmouseout',$.proxy(function(e){if(this.elevationSegment){this.html['distance-info'].addClass('hide');this.elevationSegment.distanceMarker.setVisible(false);}},this));google.visualization.events.addListener(this.elevationChart,'onmouseover',$.proxy(function(e){var nearest=this.elevationSegment.nearestPoint(this.elevations[e.row].location);var _gain=0.0;var beg=this.selectedPoint?this.selectedPoint:0;var end=e.row;var a=beg<end?beg:end;var b=a===beg?end:beg;for(var i=a;i<b;i++){_gain+=parseFloat(this.elevations[i].gain);}
var d=nearest.distance;if(this.selectedPoint){nearest=this.elevationSegment.nearestPoint(this.elevations[this.selectedPoint].location);d=d<nearest.distance?nearest.distance-d:d-nearest.distance;}
var distance=this.convertMeters2(d);distance+=this.measure2();this.html['distance-info'].html(distance+' total gain '+_gain.toFixed(2)+this.measure1());this.setMenuXY(this.html['distance-info'],this.elevations[e.row].location);var top=parseInt($(this.html['distance-info']).css('top').replace(/px/,''));top=top-35;$(this.html['distance-info']).css('top',top+'px');this.html['distance-info'].removeClass('hide');this.elevationSegment.distanceMarker.setPosition(this.elevations[e.row].location);this.elevationSegment.distanceMarker.setVisible(true);},this));google.visualization.events.addListener(this.elevationChart,'select',$.proxy(function(e){var selection=this.elevationChart.getSelection();if(selection.length>0&&selection[0].row){this.selectedPoint=selection[0].row;}},this));this.getElevations(segment);};Map.prototype.getElevations=function(segment){var accDistance=0;var params=[];var path=segment.line.getPath();for(var i=0;i<path.length;i++)
{if(i){accDistance+=distanceFrom(path.getAt(i-1),path.getAt(i));}
params.push({latlng:path.getAt(i),distance:accDistance});}
var chartSteps=750;var step=(accDistance/1609)/5.0;var mag=Math.floor(Math.log(step)/2.302585092994046);var magPow=Math.pow(10,mag);var magMsd=Math.floor(step/magPow);if(magMsd>5.0){magMsd=10.0;}else if(magMsd>2.0){magMsd=5.0;}else{magMsd=2.0;}
step=magMsd*magPow;var decDistance=(step*1609*Math.ceil((accDistance/1609)/step))/chartSteps;var chartVertices=new Array;chartVertices.push(params[0].latlng);var dIndex=1;var pIndex=0;while(chartSteps>dIndex&&dIndex*decDistance<=accDistance){while(dIndex*decDistance>params[pIndex+1].distance)
pIndex++;var deltaDistance=params[pIndex+1].distance-params[pIndex].distance;var deltaFactor=(dIndex*decDistance-params[pIndex].distance)/deltaDistance;try{chartVertices.push(google.maps.geometry.spherical.interpolate(params[pIndex].latlng,params[pIndex+1].latlng,deltaFactor));}catch(e){alert('geometry(?) threw error: '+e+"\n\nArgument to interpolate: "+params[pIndex].latlng+','+params[pIndex+1].latlng+','+deltaFactor+"\npIndex: "+pIndex);var error_line='';for(var eIndex=pIndex-10;pIndex+10>eIndex;eIndex++)
error_line=error_line+eIndex+"-"+params[eIndex].latlng+"| ";alert(error_line);}
dIndex++;}
chartVertices.push(params[params.length-1].latlng);this.getElevationParts(chartVertices,0);};Map.prototype.getElevationParts=function(data,index){var loc=data.length>250?data.slice(0,250):data;data=data.length>250?data.slice(250):[];this.elevationService.getElevationForLocations({locations:loc},$.proxy(function(results,status){if(status!==google.maps.ElevationStatus.OK){alert('received status '+status);return;}
this.elevations=this.elevations.concat(results);index+=results.length;if(data.length>0){this.getElevationParts(data,index);}else{this.showElevationChart();}},this));};Map.prototype.showElevationChart=function(){var data=new google.visualization.DataTable();data.addColumn('string','Sample');data.addColumn('number','Elevation');var gain=0.0;for(i=0;i<this.elevations.length;i++){if(i>0&&this.elevations[i].elevation>this.elevations[i-1].elevation){var ce=parseFloat(this.convertMeters1(this.elevations[i].elevation));var le=parseFloat(this.convertMeters1(this.elevations[i-1].elevation));this.elevations[i].gain=ce-le;gain+=(ce-le);}else{this.elevations[i].gain=0.0;}
data.addRow(['',parseFloat(this.convertMeters1(this.elevations[i].elevation))]);}
var title='Elevation '+this.measure1();this.elevationChart.draw(data,{legend:'none',titleY:title,focusBorderColor:'#00ff00',backgroundColor:'white',colors:['Blue'],tooltipTextStyle:{visibility:"hidden"}});this.elevationChart.setSelection([{row:0,col:1}]);this.html['data'].find('.data-segment').html('<strong>Segment:</strong> '+this.elevationSegment.options.name);this.html['data'].find('.data-distance').html('<strong>Distance:</strong> '+this.convertMeters2(this.elevationSegment.distance())+this.measure2());this.html['data'].find('.data-gain').html('<strong>Climbing:</strong> '+gain.toFixed(2)+this.measure1());this.sizeHtml();};})(jQuery);
function File(arg){this.init(arg);}
(function($){File.prototype.init=function(arg){this.options={filename:'(un-named).kml',name:null,desc:null,map:null,strokeColor:null,strokeWeight:null,strokeOpacity:null,gpx_routes:false,gpx_tracks:true,gpx_waypoints:true,gpx_placemarks:true,};for(var attr in arg){this.options[attr]=arg[attr];}
this.visiblePlacemark=false;this.dir=this.options.map.getUser()+'/';this.filename=this.options.filename;this.options.name=this.filename;this.options.desc=this.filename;this.fileList=this.options.map.html['list'];this.options.map.html['list'].find('.list-filename').text(this.filename);this.placemarkList=this.options.map.html['list'].find('.placemark-list');this.segmentList=this.options.map.html['list'].find('.segment-list');this.segmentList.sortable();this.segmentList.disableSelection();this.placemarkList.sortable();this.placemarkList.disableSelection();this.segments={};this.placemarks={};this.segmentId=1000;this.placemarkId=1000;this.removeFile=false;this.pend=null;this.setDirty=function(bool){this.dirty=bool;if(this.dirty){this.fileList.find('.file-list-name').addClass('dirty');}else{this.fileList.find('.file-list-name').removeClass('dirty');}};};File.prototype.importFile=function(url){spin(true);$.post(ibs_mappro.ajax,{action:'ibs_mappro_CORS',path:url,cache:false},$.proxy(function(data,status){try{if(status==='success'){try{var xml=$.parseXML(data);}catch(err){alert(err);}
if($(xml).find('kml').length>0){this.options.map.kml.reader(xml,this);}else{if($(xml).find('gpx').length>0){this.options.map.gpx.reader(xml,this);}else{alert('invalid file contents');}}}else{alert('server load failed.');}}catch(err){alert('process map failed.');}
var fname=getFilename(url)+'.'+getExtension(url);if(this.filename===this.options.map.options.filename){this.filename=fname;this.options.map.html['list'].find('.list-filename').text(fname);}
this.options.map.html['list'].find('.import-list').append($('<li>').text(fname));this.postLoad();spin(false);},this));};File.prototype.checkMapname=function(filename,default_ext){if(typeof filename==='string'&&filename.length>3){var ext=getExtension(filename);var name=getFilename(filename);if(/^[\w\s-()]{3,50}$/.test(name)){if(ext!=='kml'||ext!=='kmz'||ext!=='gpx'){ext=default_ext;}
return name+'.'+ext;}}
return false;};File.prototype.listSegments=function(){var list=[];var items=this.segmentList.find('li a.segment-item-name');$(items).each(function(index,item){list.push($(item).attr('rel'));});return list;};File.prototype.listPlacemarks=function(){var list=[];var items=this.placemarkList.find('li a.placemark-item-name');$(items).each(function(index,item){list.push($(item).attr('rel'))});return list;};File.prototype.sortSegments=function(event){var latlng=event.latLng;var items=[];for(var ss in this.segments){var item={distance:distanceFrom(latlng,this.segments[ss].marker.getPosition()),sid:ss};items.push(item);}
items.sort(function(a,b){if(a.distance<b.distance){return-1;}
if(a.distance>b.distance){return 1;}
return 0;});var last=null;for(var i in items){if(last){var target='.'+last;var subject='.'+items[i].sid;$(subject).insertAfter(target);}
last=items[i].sid;}};File.prototype.sortPlacemarks=function(event){var latlng=event.latLng;var items=[];for(var pp in this.placemarks){var item={distance:distanceFrom(latlng,this.placemarks[pp].marker.getPosition()),pid:pp};items.push(item);}
items.sort(function(a,b){if(a.distance<b.distance){return-1;}
if(a.distance>b.distance){return 1;}
return 0;});var last=null;for(var i in items){if(last){var target='.'+last;var subject='.'+items[i].pid;$(subject).insertAfter(target);}
last=items[i].pid;}};File.prototype._orderPlacemark=function(pid){var d=null;var p=null;for(var pp in this.placemarks){if(pp===pid){continue;}
var dd=distanceFrom(this.placemarks[pid].marker.getPosition(),this.placemarks[pp].marker.getPosition());if(!d||dd<d){d=dd;p=pp;}}
if(p){var target='#'+p;var subject='#'+pid;$(subject).insertAfter(target);}};File.prototype._undoSegment=function(options){options.path=[];for(var i=0;i<options.latlngs.length;i++){options.path.push(new google.maps.LatLng(options.latlngs[i].lat,options.latlngs[i].lng));}
delete options.latlng;this.segments[options.sid]=new Segment(options);};File.prototype._undoPlacemark=function(options){if(!this.placemarks[options.pid]){this.placemarks[options.pid]=new Placemark(options);}};File.prototype.undo=function(clipboard){spin(true);try{for(var i=0;i<clipboard.length;i++){if(clipboard[i].pid){this._undoPlacemark(clipboard[i]);}else{if(clipboard[i].sid){this._undoSegment(clipboard[i]);}}
this.postLoad(true);this.setDirty(true);}}catch(e){spin(false);}
spin(false);};File.prototype.postLoad=function(){this.dirty=false;this.options.map.setClick(null);this.focus();this.updatePid();};File.prototype.getPids=function(data,index){this.options.map.geocoder.geocode({'address':data[index][1]},$.proxy(function(results,status){if(status===google.maps.GeocoderStatus.OK){var lat=results[0].geometry.location.lat();var lng=results[0].geometry.location.lng();lng=parseFloat(lng);lat=parseFloat(lat);if(typeof lat==='number'&&typeof lng==='number'){var latlng=new google.maps.LatLng(lat,lng);var p=data[index][0];this.placemarks[p].options.position=latlng;this.placemarks[p].options.desc=results[0].formatted_address;this.placemarks[p].marker.setPosition(latlng);this.placemarks[p].marker.setVisible(true);}
index++;if(index<data.length){this.getPids(data,index,bounds);}else{var bounds=new google.maps.LatLngBounds();this.getBounds(bounds)
this.options.map.googlemap.fitBounds(bounds);}}},this));};File.prototype.updatePid=function(){if(this.options.map.options.pid!==''){var results=[];$.post(ibs_mappro.ajax,{action:'ibs_mappro_pid',pid:this.options.map.options.pid,},$.proxy(function(data,status){if(status==='success'){for(var id in data){for(var pid in this.placemarks){if(this.placemarks[pid].options.name===id){results.push([pid,data[id]]);}}}
if(results.length>0){this.getPids(results,0);}}},this),'json');}};File.prototype._add=function(options){options.mid=this.options.mid;options.map=this.options.map;options.file=this;};File.prototype._addSegment=function(options){for(var seg in this.segments){if(this.segments[seg].options.name===options.name){this.segments[seg].line.setPath(options.path);return;}}
this.segmentId++;this._add(options);options.sid="S"+this.segmentId.toString();this.segments[options.sid]=new Segment(options);return options.sid;};File.prototype.addSegment=function(options){this.segments[this._addSegment(options)].extend();this.setDirty(true);};File.prototype._addPlacemark=function(options){this.placemarkId++;this._add(options);options.pid="P"+this.placemarkId.toString();if(options.name==='')
options.name=options.pid;this.placemarks[options.pid]=new Placemark(options);if(this.placemarks[options.pid].options.sysmbol==='Waypoint'){this.placemarks[options.pid].marker.setVisible(this.options.map.html['dd-display'].find('.control-waypoints').is(':checked'));}else{this.placemarks[options.pid].marker.setVisible(this.options.map.html['dd-display'].find('.control-placemarks').is(':checked'));}
return options.pid;};File.prototype.addPlacemark=function(options){var pid=this._addPlacemark(options);this.placemarks[pid].marker.setVisible(true);this.setDirty(true);this._orderPlacemark(pid);return pid;};File.prototype.click=function(event){if(this.pend){switch(this.pend){case'sort':this.sortPlacemarks(event);this.sortSegments(event);break;case'placemark':this.addPlacemark({position:event.latLng});this.pendReset();break;case'segment':this.addSegment({path:[event.latLng],strokeColor:this.options.strokeColor,strokeWeight:this.options.strokeWeight,strokeOpacity:this.options.strokeOpacity});break;}
this.pend=null;}};File.prototype.pendReset=function(){this.options.map.html['map'].find('.pend-info').addClass('hide');for(var sid in this.segments){this.segments[sid].pend==='';}
this.pend=null;};File.prototype.pendSegment=function(){if(this.pend==='segment'){this.options.map.setClick();this.options.map.html['map'].find('.pend-info').addClass('hide');}else{this.options.map.setClick({sid:null,pid:null});this.pend='segment';this.options.map.showPend(this.options.map.googlemap.getCenter());}};File.prototype.pendSort=function(){this.options.map.setClick({sid:null,pid:null});this.pend='sort';this.options.map.showPend(this.map.googlemap.getCenter());};File.prototype.pendPlacemark=function(){if(this.pend==='placemark'){this.options.map.setClick();}else{this.options.map.setClick({sid:null,pid:null});this.pend='placemark';this.options.map.showPend(this.options.map.googlemap.getCenter());}};File.prototype.placemarkVisible=function(visible){for(var pid in this.placemarks){var wp=this.placemarks[pid];if(wp.options.symbol==='Waypoint'){wp.marker.setVisible(this.options.map.html['dd-display'].find('.control-waypoints').is(':checked'));}else{wp.marker.setVisible(visible);}}};File.prototype.waypointVisible=function(visible){for(var pid in this.placemarks){var wp=this.placemarks[pid];if(wp.options.symbol==='Waypoint'){wp.marker.setVisible(visible);}}};File.prototype.placemarkFilter=function(item){var url=$(item).attr('src');for(var i in this.placemarks){var isVisible=this.placemarks[i].marker.getVisible();var visible=this.placemarks[i].marker.icon.url===url&&!isVisible;this.placemarks[i].marker.setVisible(visible);}};File.prototype.flip=function(){for(var sid in this.segments){this.segments[sid].flip();}};File.prototype.distance=function(){var distance=0;for(var sid in this.segments){distance+=this.segments[sid].distance();}
return distance;};File.prototype.removePlacemark=function(pid){if(!this.removeFile){delete this.placemarks[pid];this.placemarkList.find('.'+pid).remove();this.setDirty(true);}};File.prototype.removePlacemarks=function(){for(var pid in this.placemarks){this.placemarks[pid].remove();}};File.prototype.removeSegment=function(sid){if(!this.removeFile){delete this.segments[sid];this.setDirty(true);this.options.map.reset();}};File.prototype.removeSegments=function(){for(var sid in this.segments){this.segments[sid].remove();}};File.prototype.remove=function(){this.removeFile=true;this.removePlacemarks();this.removeSegments();this.options.map.removeFile();};File.prototype.getBounds=function(bounds){for(var sid in this.segments){this.segments[sid].getBounds(bounds);}
for(var pid in this.placemarks){bounds.extend(this.placemarks[pid].marker.getPosition());}};File.prototype.refresh=function(){for(var sid in this.segments){this.segments[sid].refresh();}};File.prototype.isPlacemark=function(latlng){for(var pid in this.placemarks){if(this.placemarks[pid].options.position.equals(latlng))
return pid;}
return false;};File.prototype.append=function(segment){var target=null;var path=segment.line.getPath();var latlng=path.getAt(path.getLength()-1);var d=0;for(var sid in this.segments){if(sid===segment.sid){continue;}
var test_path=this.segments[sid].line.getPath();var test_latlng=test_path.getAt(0);var b=distanceFrom(latlng,test_latlng);if(target===null||d>b){target=this.segments[sid];d=b;}}
if(target){while(path.getLength()>0){var point=path.pop();target.line.getPath().insertAt(0,point);}
segment.remove();target.refresh();}};File.prototype.focus=function(){if(Object.keys(this.segments).length>0){var bounds=new google.maps.LatLngBounds();this.getBounds(bounds);this.options.map.googlemap.fitBounds(bounds);}};File.prototype.getXml=function(){if(getExtension(this.filename)==='gpx'){return this.options.map.gpx.writer(this);}else{return this.options.map.kml.writer(this);}};File.prototype.showXml=function(){this.options.map.kml.kmlWindow(this.getXml());var newWindow=window.open('','XML Export '+(new Date()).getTime(),"width=800,height=1000");newWindow.document.write('<textarea id="xml" style="width: 100%; height: 100%">'+this.getXml()+'</textarea>');};File.prototype.saveAs=function(download){if(typeof download==='undefined')
download=false;var data=this.getXml();if(data){$.post(ibs_mappro.ajax,{action:'ibs_mappro_savexml',data:encodeURIComponent(data),filename:this.dir+this.filename},$.proxy(function(data,status){var map=this.options.map;spin(false);if(status==='success'){this.setDirty(false);if(download){var data_url=decodeURIComponent(data);var file_url=this.options.map.siteUrl()+'lib/download.php?file='+data_url;$.fileDownload(file_url,{successCallback:$.proxy(function(url){this.options.map.notice('Save '+this.filename+' completed.');},this),failCallback:$.proxy(function(html,url){this.options.map.alert('File download failed. '+this.filename);},this)});}else{this.options.map.notice('Save '+this.filename+' completed.');}}else{this.options.map.alert('Save '+this.filename+' failed.');}},this));}else{this.options.map.alert('Error creating XML document.');}};File.prototype.selectPlacemark=function(item,e){var has=$(item).hasClass('selected');this.placemarkList.find('.placemark-item-name').removeClass('selected');if(false===has){$(item).addClass('selected');$(item).parent().ScrollTo({onlyIfOutside:true});}};File.prototype.selectSegmentCheck=function(){if(this.segmentList.find('.segment-item-name.selected').length>0){this.options.map.html['ibs-header'].find('.ibs-route').dropdown('enable');this.options.map.html['ibs-header'].find('.ibs-route').button('option','disabled',false);return true;}else{this.options.map.html['ibs-header'].find('.ibs-route').dropdown('hide');this.options.map.html['ibs-header'].find('.ibs-route').dropdown('disable');$this.options.map.html['ibs-header'].find('.ibs-route').button('option','disabled',true);return false;}};File.prototype.selectSegment=function(item){var has=$(item).hasClass('selected');this.segmentList.find('.segment-item-name').removeClass('selected');this.segmentList.find('.ct-list-div').addClass('hide');if(false===has){$(item).addClass('selected');$(item).parent().find('.ct-list-div').removeClass('hide');this.options.map.html['ibs-header'].find('.ibs-route').dropdown('enable');this.options.map.html['ibs-header'].find('.ibs-route').button('option','disabled',false);$(item).parent().ScrollTo({onlyIfOutside:true});}else{this.options.map.html['ibs-header'].find('.ibs-route').dropdown('hide');this.options.map.html['ibs-header'].find('.ibs-route').dropdown('disable');this.options.map.html['ibs-header'].find('.ibs-route').button('option','disabled',true);}};})(jQuery);
function siteUrl(){var href=jQuery.url(jQuery(location).attr('href'));var file=href.attr('file');return jQuery(location).attr('href').split(file)[0]}
function getUriQuery(){var result={};var url=jQuery.url(jQuery(location).attr('href'));var query=url.attr('query');if(query){var args=query.split('&');for(var i in args){var arg=args[i].split('=');result[arg[0]]=arg[1];}}
return result;}
function removeHtmlStr(s){return jQuery('<div>').html(s).text();}
function padLeftStr(str,max,char){if(typeof str!=='string'){str=str.toString();}
if(typeof max==='undefined')
max=8;if(typeof char==='undefined')
char=' ';return str.length<max?padLeftStr(char+str,max,char):str;};function padRightStr(str,max,char){if(typeof str!=='string'){str=str.toString();}
if(typeof max==='undefined')
max=8;if(typeof char==='undefined')
char=' ';return str.length<max?padRightStr(str+char,max,char):str;}
function hex(x){var hexDigits=new Array("0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f");return isNaN(x)?"00":hexDigits[(x-x%16)/16]+hexDigits[x%16];}
function isUrl(url){return/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(url);
}
function rgb2hex(color) {
    var rgb = color.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);if(rgb){return"#"+hex(rgb[1])+hex(rgb[2])+hex(rgb[3]);}else{return color;}}
function setCurrentColor(dialog){var color=dialog.find('.line-attr').find('.colorpicker-trigger').css('background-color');dialog.find('.colorpicker-picker-span').each(function(index,item){if(color===jQuery(item).css('background-color')){jQuery(item).addClass('active');}else{jQuery(item).removeClass('active');}});}
function getExtension(filename){if(typeof filename==='string'&&filename.length>3){var pos=filename.lastIndexOf('.');if(pos!==-1){return filename.substring(pos+1);}}
return false;}
function getDirname(filename){var pos=filename.lastIndexOf('/');var dir=filename.substring(0,pos);pos=dir.lastIndexOf('/');dir=dir.substring(pos+1);return dir;}
function getFilename(filename){var pos=filename.lastIndexOf('/');if(pos>-1){filename=filename.substring(pos+1);}
pos=filename.lastIndexOf('.');if(pos!==-1){return filename.substring(0,pos);}else{return filename;}}
function spin(bool){if(bool){jQuery("body").addClass('wait');}else{jQuery("body").removeClass('wait');}}
function midPoint(pointA,pointB){return new google.maps.LatLng(pointB.lat()-(0.5*(pointB.lat()-pointA.lat())),pointB.lng()-(0.5*(pointB.lng()-pointA.lng())));}
function distanceFrom(latlngA,latlngB){try{return google.maps.geometry.spherical.computeDistanceBetween(latlngA,latlngB);}catch(err){return 0;}}
function pathLength(path){try{return google.maps.geometry.spherical.computeLength(path);}catch(err){return 0;}}
function cleanDescription(desc){u=desc.replace("<![CDATA[","").replace("]]>","");u=u.replace(/\&amp;/g,"&");u=u.replace(/\&lt;/g,"<");u=u.replace(/\&quot;/g,'"');u=u.replace(/\&apos;/g,"'");u=u.replace(/\&gt;/g,">");return u;}
function getCDATA(data){if(typeof data==='string'){u=data.replace("<![CDATA[","").replace("]]>","");u=u.replace(/\&amp;/g,"&");u=u.replace(/\&lt;/g,"<");u=u.replace(/\&quot;/g,'"');u=u.replace(/\&apos;/g,"'");u=u.replace(/\&gt;/g,">");return u;}
return'';}
function dechex(number){if(number<0){number=0xFFFFFFFF+number+1;}
return parseInt(number,10).toString(16);}
function colorKML(opacity,color){if(color.substr(0,3)==='rgb'){color=rgb2hex(color);}
var aa=Math.ceil(opacity*255);aa=dechex(aa);var rr=color.substr(1,2);var gg=color.substr(3,2);var bb=color.substr(5,2);return aa+bb+gg+rr;}
if(!Date.prototype.toISOString){(function(){function pad(number){var r=String(number);if(r.length===1){r='0'+r;}
return r;}
Date.prototype.toISOString=function(){return this.getUTCFullYear()
+'-'+pad(this.getUTCMonth()+1)
+'-'+pad(this.getUTCDate())
+'T'+pad(this.getUTCHours())
+':'+pad(this.getUTCMinutes())
+':'+pad(this.getUTCSeconds())
+'.'+String((this.getUTCMilliseconds()/1000).toFixed(3)).slice(2,5)
+'Z';};}());}
function utf8_encode(argString){if(argString===null||typeof argString==="undefined"){return"";}
var string=(argString+'');var utftext='',start,end,stringl=0;start=end=0;stringl=string.length;for(var n=0;n<stringl;n++){var c1=string.charCodeAt(n);var enc=null;if(c1<128){end++;}else if(c1>127&&c1<2048){enc=String.fromCharCode((c1>>6)|192,(c1&63)|128);}else if(c1&0xF800!=0xD800){enc=String.fromCharCode((c1>>12)|224,((c1>>6)&63)|128,(c1&63)|128);}else{if(c1&0xFC00!=0xD800){throw new RangeError("Unmatched trail surrogate at "+n);}
var c2=string.charCodeAt(++n);if(c2&0xFC00!=0xDC00){throw new RangeError("Unmatched lead surrogate at "+(n-1));}
c1=((c1&0x3FF)<<10)+(c2&0x3FF)+0x10000;enc=String.fromCharCode((c1>>18)|240,((c1>>12)&63)|128,((c1>>6)&63)|128,(c1&63)|128);}
if(enc!==null){if(end>start){utftext+=string.slice(start,end);}
utftext+=enc;start=end=n+1;}}
if(end>start){utftext+=string.slice(start,stringl);}
return utftext;}
function sha1(str){var rotate_left=function(n,s){var t4=(n<<s)|(n>>>(32-s));return t4;};var cvt_hex=function(val){var str="";var i;var v;for(i=7;i>=0;i--){v=(val>>>(i*4))&0x0f;str+=v.toString(16);}
return str;};var blockstart;var i,j;var W=new Array(80);var H0=0x67452301;var H1=0xEFCDAB89;var H2=0x98BADCFE;var H3=0x10325476;var H4=0xC3D2E1F0;var A,B,C,D,E;var temp;str=this.utf8_encode(str);var str_len=str.length;var word_array=[];for(i=0;i<str_len-3;i+=4){j=str.charCodeAt(i)<<24|str.charCodeAt(i+1)<<16|str.charCodeAt(i+2)<<8|str.charCodeAt(i+3);word_array.push(j);}
switch(str_len%4){case 0:i=0x080000000;break;case 1:i=str.charCodeAt(str_len-1)<<24|0x0800000;break;case 2:i=str.charCodeAt(str_len-2)<<24|str.charCodeAt(str_len-1)<<16|0x08000;break;case 3:i=str.charCodeAt(str_len-3)<<24|str.charCodeAt(str_len-2)<<16|str.charCodeAt(str_len-1)<<8|0x80;break;}
word_array.push(i);while((word_array.length%16)!=14){word_array.push(0);}
word_array.push(str_len>>>29);word_array.push((str_len<<3)&0x0ffffffff);for(blockstart=0;blockstart<word_array.length;blockstart+=16){for(i=0;i<16;i++){W[i]=word_array[blockstart+i];}
for(i=16;i<=79;i++){W[i]=rotate_left(W[i-3]^W[i-8]^W[i-14]^W[i-16],1);}
A=H0;B=H1;C=H2;D=H3;E=H4;for(i=0;i<=19;i++){temp=(rotate_left(A,5)+((B&C)|(~B&D))+E+W[i]+0x5A827999)&0x0ffffffff;E=D;D=C;C=rotate_left(B,30);B=A;A=temp;}
for(i=20;i<=39;i++){temp=(rotate_left(A,5)+(B^C^D)+E+W[i]+0x6ED9EBA1)&0x0ffffffff;E=D;D=C;C=rotate_left(B,30);B=A;A=temp;}
for(i=40;i<=59;i++){temp=(rotate_left(A,5)+((B&C)|(B&D)|(C&D))+E+W[i]+0x8F1BBCDC)&0x0ffffffff;E=D;D=C;C=rotate_left(B,30);B=A;A=temp;}
for(i=60;i<=79;i++){temp=(rotate_left(A,5)+(B^C^D)+E+W[i]+0xCA62C1D6)&0x0ffffffff;E=D;D=C;C=rotate_left(B,30);B=A;A=temp;}
H0=(H0+A)&0x0ffffffff;H1=(H1+B)&0x0ffffffff;H2=(H2+C)&0x0ffffffff;H3=(H3+D)&0x0ffffffff;H4=(H4+E)&0x0ffffffff;}
temp=cvt_hex(H0)+cvt_hex(H1)+cvt_hex(H2)+cvt_hex(H3)+cvt_hex(H4);return temp.toLowerCase();}
function initialCapsX(str){return str.toLowerCase().replace(/\b[a-z]/g,function(letter){return letter.toUpperCase();});}
function initialCaps(str){return str.toLowerCase().replace(/^[\u00C0-\u1FFF\u2C00-\uD7FF\w]|\s[\u00C0-\u1FFF\u2C00-\uD7FF\w]/g,function(letter){return letter.toUpperCase();});}
function GPX(){this.init();}
(function($){GPX.prototype.init=function(){var gpxColors=[{x:0,y:0,z:0,label:'Black'},{x:140,y:0,z:26,label:'DarkRed'},{x:37,y:65,z:23,label:'DarkGreen'},{x:255,y:243,z:128,label:'DarkYellow'},{x:21,y:27,z:84,label:'DarkBlue'},{x:227,y:49,z:157,label:'DarkMagenta'},{x:207,y:236,z:236,label:'DarkCyan'},{x:188,y:198,z:204,label:'LightGray'},{x:80,y:74,z:75,label:'DarkGray'},{x:255,y:0,z:0,label:'Red'},{x:0,y:128,z:0,label:'Green'},{x:255,y:255,z:0,label:'Yellow'},{x:0,y:0,z:255,label:'Blue'},{x:255,y:0,z:255,label:'Magenta'},{x:0,y:255,z:255,label:'Cyan'},{x:255,y:255,z:255,label:'White'}];function gpx_rgb2hex(color){var rgb=color.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);if(rgb){return"#"+hex(rgb[1])+hex(rgb[2])+hex(rgb[3]);}else{return color;}}
gpxColor=function(color){function fdist(a,b){var x=Math.abs(a.x-b.x);var y=Math.abs(a.y-b.y);var z=Math.abs(a.z-b.z);return Math.sqrt(x*x+y*y+z*z);}
color=gpx_rgb2hex($('<div>').css('color',color).css('color'));color=color.replace("#","");var value=parseInt(color,16);var b=Math.floor(value%256);var g=Math.floor((value/256)%256);var r=Math.floor((value/(256*256))%256);var point={'x':r,'y':g,'z':b};var min=Infinity;var colorIndex=-1;var dist=0;for(var i=0;i<gpxColors.length;++i)
{dist=fdist(gpxColors[i],point);if(dist<min)
{min=dist;colorIndex=i;}}
if(colorIndex<0||colorIndex>gpxColors.length-1){colorIndex=0;}
var p=gpxColors[colorIndex];var val=p.x*(256*256)+p.y*256+p.z;var hexstr='#'+padLeftStr(val.toString(16),6,'0');return{name:gpxColors[colorIndex].label,value:hexstr};};};GPX.prototype.writer=function(file){var placemark_list=file.listPlacemarks();var segment_list=file.listSegments();var bounds=new google.maps.LatLngBounds();file.getBounds(bounds);var ne=bounds.getNorthEast();var sw=bounds.getSouthWest();var time=new Date().toISOString();var xml=new XMLWriter('UTF-8','1.0');xml.writeStartDocument();xml.writeStartElement('gpx');xml.writeAttributeString('xmlns','http://www.topografix.com/GPX/1/1');xml.writeAttributeString('creator','Indian Bend Solutions LLC');xml.writeAttributeString('version',"1.0");xml.writeAttributeString('xmlns:xsi',"http://www.w3.org/2001/XMLSchema-instance");xml.writeAttributeString('xsi:schemaLocation',"http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd");xml.writeStartElement('metadata');xml.writeStartElement('link');xml.writeAttributeString('href','http://www.garmin.com');xml.writeElementString('text','Garmin International');xml.writeEndElement();xml.writeElementString('time',time);xml.writeStartElement('bounds');xml.writeAttributeString('maxlat',sw.lat().toString());xml.writeAttributeString('maxlon',sw.lng().toString());xml.writeAttributeString('minlat',ne.lat().toString());xml.writeAttributeString('minlon',ne.lng().toString());xml.writeEndElement();xml.writeEndElement();if(file.options.gpx_waypoints){for(var i=0;i<placemark_list.length;i++){var pm=file.placemarks[placemark_list[i]];if(pm.options.symbol==='Waypoint'){xml.writeStartElement('wpt');xml.writeAttributeString('lat',pm.options.position.lat().toString());xml.writeAttributeString('lon',pm.options.position.lng().toString());xml.writeElementString('time',time);xml.writeStartElement('name');xml.writeCDATA(pm.options.name);xml.writeEndElement();xml.writeStartElement('cmt');xml.writeCDATA(pm.options.desc);xml.writeEndElement();xml.writeStartElement('desc');xml.writeCDATA(pm.options.desc);xml.writeEndElement();xml.writeElementString('sym',pm.options.symbol);xml.writeStartElement('extensions');xml.writeStartElement('gpxx:WaypointExtension');xml.writeAttributeString('xmlns:gpxx','http://www.garmin.com/xmlschemas/GpxExtensions/v3');xml.writeElementString('gpxx:DisplayMode','SymbolAndName');xml.writeEndElement();xml.writeEndElement();xml.writeEndElement();}}}
if(file.options.gpx_placemarks){for(var i=0;i<placemark_list.length;i++){var pm=file.placemarks[placemark_list[i]];if(pm.options.symbol!=='Waypoint'){xml.writeStartElement('wpt');xml.writeAttributeString('lat',pm.options.position.lat().toString());xml.writeAttributeString('lon',pm.options.position.lng().toString());xml.writeElementString('time',time);xml.writeStartElement('name');xml.writeCDATA(pm.options.name);xml.writeEndElement();xml.writeStartElement('cmt');xml.writeCDATA(pm.options.desc);xml.writeEndElement();xml.writeStartElement('desc');xml.writeCDATA(pm.options.desc);xml.writeEndElement();xml.writeElementString('sym',pm.options.symbol);xml.writeStartElement('extensions');xml.writeStartElement('gpxx:WaypointExtension');xml.writeAttributeString('xmlns:gpxx','http://www.garmin.com/xmlschemas/GpxExtensions/v3');xml.writeElementString('gpxx:DisplayMode','SymbolAndName');xml.writeEndElement();xml.writeEndElement();xml.writeEndElement();}}}
if(file.options.gpx_routes){for(i=0;i<segment_list.length;i++){var sg=file.segments[segment_list[i]];xml.writeStartElement('rte');xml.writeStartElement('name');xml.writeCDATA(sg.options.name);xml.writeEndElement();xml.writeStartElement('desc');xml.writeCDATA(sg.options.desc);xml.writeEndElement();xml.writeStartElement('extensions');xml.writeStartElement('gpxx:RouteExtension');xml.writeAttributeString('xmlns:gpxx','http://www.garmin.com/xmlschemas/GpxExtensions/v3');xml.writeElementString('gpxx:IsAutoNamed','false');xml.writeElementString('gpxx:DisplayColor',gpxColor(sg.options.strokeColor).name);xml.writeEndElement();xml.writeEndElement();var points=sg.line.getPath().getArray();var waypoints=sg.findWaypoints();if((waypoints.length===0||waypoints[0].index!==0)&&points.length>0){sg.waypoint(0);waypoints=sg.findWaypoints();}
for(var j=0;j<waypoints.length;j++){var pm=file.placemarks[waypoints[j].pid];xml.writeStartElement('rtept');xml.writeAttributeString('lat',waypoints[j].latlng.lat().toString());xml.writeAttributeString('lon',waypoints[j].latlng.lng().toString());xml.writeStartElement('name');xml.writeCDATA(pm.options.name);xml.writeEndElement();xml.writeStartElement('cmt');xml.writeCDATA(pm.options.desc);xml.writeEndElement();xml.writeStartElement('desc');xml.writeCDATA(pm.options.desc);xml.writeEndElement();xml.writeElementString('sym','Waypoint');xml.writeStartElement('extensions');xml.writeStartElement('gpxx:RoutePointExtension');xml.writeAttributeString('xmlns:gpxx','http://www.garmin.com/xmlschemas/GpxExtensions/v3');xml.writeElementString('gpxx:Subclass','000000000000FFFFFFFFFFFFFFFFFFFFFFFF');var hh=j<waypoints.length-1?waypoints[j+1].index:points.length-1;for(var gg=waypoints[j].index+1;gg<hh;gg++){xml.writeStartElement('gpxx:rpt');xml.writeAttributeString('lat',points[gg].lat().toString());xml.writeAttributeString('lon',points[gg].lng().toString());xml.writeEndElement();}
xml.writeEndElement();xml.writeEndElement();xml.writeEndElement();}
xml.writeEndElement();}}
if(file.options.gpx_waypoints){xml.writeStartElement('trk');for(var sid in file.segments){var sg=file.segments[sid];xml.writeStartElement('trkseg');xml.writeStartElement('extensions');xml.writeStartElement('gpxx:TrackExtension');xml.writeAttributeString('xmlns:gpxx','http://www.garmin.com/xmlschemas/GpxExtensions/v3');xml.writeElementString('gpxx:DisplayColor',gpxColor(sg.options.strokeColor).name);xml.writeEndElement();xml.writeEndElement();xml.writeStartElement('name');xml.writeCDATA(sg.options.name);xml.writeEndElement();xml.writeStartElement('desc');xml.writeCDATA(sg.options.desc);xml.writeEndElement();sg.line.getPath().forEach(function(latlng){xml.writeStartElement('trkpt');xml.writeAttributeString('lat',latlng.lat().toString());xml.writeAttributeString('lon',latlng.lng().toString());xml.writeEndElement();});xml.writeEndElement()};xml.writeEndElement();}
xml.writeEndElement();xml.writeEndDocument();return xml.flush();};GPX.prototype.reader=function(xml,file){$(xml).children('gpx').each($.proxy(function(n,gpx){file.options.desc=$(gpx).attr('creator');$(gpx).children('wpt').each($.proxy(function(n,wpt){var marker_options={url:'',symbol:null,name:null,desc:null,position:null,daraggable:false,visible:false};marker_options.name=getCDATA($(wpt).find('name').text());marker_options.cmt=getCDATA($(wpt).find('cmt').text());marker_options.desc=getCDATA($(wpt).find('desc').text());marker_options.symbol=$(wpt).find('sym').text();marker_options.position=new google.maps.LatLng(parseFloat($(wpt).attr('lat')),parseFloat($(wpt).attr('lon')));file._addPlacemark(marker_options);},this));$(gpx).children('rte').each(function(n,rte){var segment_options={path:[],strokeColor:'#0000ff',strokeOpacity:0.7,strokeWeight:5,name:'',desc:''};segment_options.name=getCDATA($(rte).find('name:first').text());segment_options.cmt=getCDATA($(rte).find('cmt:first').text());segment_options.desc=getCDATA($(rte).find('desc:first').text());$(rte).children('extensions').each(function(n,extension){$(extension).children().each(function(n,x){if(x.nodeName==='gpxx:RouteExtension'){$(x).children().each(function(n,xx){if(xx.nodeName==='gpxx:DisplayColor'){segment_options.strokeColor=$(xx).text();}});}});});$(rte).children('rtept').each(function(n,rtept){var latlng=new google.maps.LatLng(parseFloat($(rtept).attr('lat')),parseFloat($(rtept).attr('lon')));segment_options.path.push(latlng);$(rtept).children('extensions').each(function(n,extension){$(extension).children().each(function(n,routeptextension){if(routeptextension.nodeName==='gpxx:RoutePointExtension'){$(routeptextension).children().each(function(n,rpt){if(rpt.nodeName==='gpxx:rpt'){segment_options.path.push(new google.maps.LatLng(parseFloat($(rpt).attr('lat')),parseFloat($(rpt).attr('lon'))));}});}});});});if(segment_options.path.length>1){file._addSegment(segment_options);}});$(gpx).children('trk').each(function(n,trk){$(trk).children('trkseg').each(function(n,trkseg){var track_options={path:[],strokeColor:'#0000ff',strokeOpacity:0.7,strokeWeight:5,name:'track'+n,desc:''};var a=$(trkseg).find('name:first').text();track_options.name=typeof(a)==='undefined'||a===''?'track-'+(n+1):a;track_options.cmt=getCDATA($(trkseg).find('cmt:first').text());track_options.desc=getCDATA($(trkseg).find('desc:first').text());$(trkseg).children('extensions').each(function(n,extension){$(extension).children().each(function(n,x){if(x.nodeName==='gpxx:TrackExtension'){$(x).children().each(function(n,xx){if(xx.nodeName==='gpxx:DisplayColor'){track_options.strokeColor=$(xx).text();}});}});});$(trkseg).children('trkpt').each(function(n,trkpt){var latlng=new google.maps.LatLng(parseFloat($(trkpt).attr('lat')),parseFloat($(trkpt).attr('lon')));track_options.path.push(latlng);});file._addSegment(track_options);});});},this));};})(jQuery);
(function($){Map.prototype.setHandlers=function(){$.widget("ui.dialog",$.ui.dialog,{_allowInteraction:function(event){return!!$(event.target).closest(".cke_dialog").length||this._super(event);}});$(window).resize($.proxy(function(ev){this.sizeHtml();},this));window.onbeforeunload=$.proxy(function(e){var ans=this.isDirty();if(ans)
return ans;else
return;},this);this.html['ibs-header'].on('click','.ibs-reset',{map:this},function(event){event.data.map.reset();});this.html['dd-display'].on('click','.control-distance-flag',{map:this},function(event){event.data.map.options.distance=event.data.map.html['dd-display'].find('.control-distance-flag').is(':checked');});this.html['dd-display'].on('click','.control-bike-layer',{map:this},function(event){event.data.map.setBikeLayer(event.data.map.html['dd-display'].find('.control-bike-layer').is(':checked'));});this.html['dd-display'].on('click','.control-placemarks',{map:this},function(event){event.data.map.file.placemarkVisible(event.data.map.html['dd-display'].find('.control-placemarks').is(':checked'));});this.html['dd-display'].on('click','.control-waypoints',{map:this},function(event){event.data.map.file.waypointVisible(event.data.map.html['dd-display'].find('.control-waypoints').is(':checked'));});this.html['dd-map'].on('click','.map-action-browse',{map:this},function(event){event.data.map.browseDialog();});this.html['dd-map'].on('click','.map-action-web',{map:this},function(event){event.data.map.webDialog();});this.html['dd-map'].on('click','.map-action-show',{map:this},function(event){event.data.map.file.showXml();});this.html['dd-map'].on('click','.map-action-upload',{map:this},function(event){event.data.map.uploadDialog();});this.html['dd-map'].on('click','.map-action-download',{map:this},function(event){event.data.map.file.saveAs(true);});this.html['dd-map'].on('click','.map-action-save',{map:this},function(event){event.data.map.file.saveDialog();});this.html['dd-map'].on('click','.map-action-focus',{map:this},function(event){event.data.map.file.focus();});this.html['list'].on('click','.list-action-edit',{map:this},function(event){event.data.map.file.fileDialog();});this.html['dd-map'].on('click','.map-action-edit',{map:this},function(event){event.data.map.options.mode==='edit'?event.data.map.file.fileDialog():event.data.map.file.show();});this.html['dd-map'].on('click','.map-action-flip',{map:this},function(event){event.data.map.file.flip();});this.html['dd-map'].on('click','.map-action-sort',{map:this},function(event){event.data.map.file.pendSort();});this.html['dd-map'].on('click','.map-action-clear',{map:this},function(event){event.data.map.clear();});this.html['ibs-header'].on('click','.ibs-find',{map:this},function(event){event.data.map.findDialog();});this.html['list'].on('click','.list-action-route',{map:this},function(event){event.data.map.file.pendSegment();});this.html['list'].on('click','.list-action-placemark',{map:this},function(event){event.data.map.file.pendPlacemark();});if(this.options.mode==='edit'){function getMFS(event){var item=event.data.map.html['list'].find('.segment-item-name.selected');if(item.length>0){var rel=$(item[0]).attr('rel');var segment=event.data.map.file.segments[rel];return{'map':event.data.map,'segment':segment};}else{return null;}}
this.html['dd-route'].on('click','.route-action-append',{map:this},function(event){var obj=getMFS(event);if(obj){obj.map.file.append(obj.segment);}});this.html['dd-route'].on('click','.route-action-focus',{map:this},function(event){var obj=getMFS(event);if(obj){obj.segment.focus();}});this.html['dd-route'].on('click','.route-action-extend',{map:this},function(event){var obj=getMFS(event);if(obj)
obj.segment.extend();});this.html['dd-route'].on('click','.route-action-edit',{map:this},function(event){var obj=getMFS(event);if(obj)
obj.segment.segmentDialog();});this.html['dd-route'].on('click','.route-action-ledit',{map:this},function(event){var obj=getMFS(event);if(obj)
obj.segment.lineEdit();});this.html['dd-route'].on('click','.route-action-flip',{map:this},function(event){var obj=getMFS(event);if(obj)
obj.segment.flip();});this.html['dd-route'].on('click','.route-action-rebuild',{map:this},function(event){var obj=getMFS(event);if(obj)
obj.segment.rebuild();});this.html['dd-route'].on('click','.route-action-remove',{map:this},function(event){var obj=getMFS(event);if(obj)
obj.segment.remove();});this.html['dd-route'].on('click','.route-action-thin',{map:this},function(event){var obj=getMFS(event);if(obj)
obj.segment.thin();});this.html['dd-route'].on('click','.route-action-undo',{map:this},function(event){var obj=getMFS(event);if(obj)
obj.segment.undo();});this.html['dd-route'].on('click','.route-action-cue',{map:this},function(event){var obj=getMFS(event);if(obj)
obj.segment.cuesheetDirections();});this.html['dd-route'].on('click','.route-action-profile',{map:this},function(event){var obj=getMFS(event);if(obj)
obj.map.elevation(obj.segment);});this.html['dd-options'].on('click','.control-followroad',{map:this},function(event){var onoff=event.data.map.html['dd-options'].find('.control-followroad').is(':checked');event.data.map.options.followroad=onoff;});this.html['dd-options'].on('click','.control-avoidhighway',{map:this},function(event){event.data.map.options.avoidhighway=event.data.map.html['dd-options'].find('.control-avoidhighway').is(':checked');});this.html['dd-options'].on('change','input[name=travelmode]',{map:this},function(event){event.data.map.options.travelmode=event.data.map.html['dd-options'].find('input[name=travelmode]:checked').val();});this.html['placemark-dialog'].on('click','.placemark-select-item',{map:this},function(event){event.data.map.html['placemark-dialog'].find('.placemark-selected-icon').attr('src',$(this).find('.icon-option-value').val());});}
this.html['list'].on('click','.list-action-import',{map:this},function(event){event.data.map.html['list'].find('.import-list-div').toggleClass('hide');});this.html['find-dialog'].on('keypress','.find-words',{map:this},function(event){var code=(event.keyCode?event.keyCode:event.which);if(code===13){event.preventDefault();var dialog=event.data.map.html['find-dialog'];var buttons=dialog.dialog('option','buttons');buttons['Find'].apply(dialog);}});this.html['page'].on('click','.info-footer a',{map:this},function(event){var map=event.data.map;var rel=$(this).attr('rel')
var action=$(this).attr('action');var file=map.file;var obj=rel.substr(0,1)=='S'?file.segments[rel]:file.placemarks[rel];map.infowindow.close();switch(action){case'elevation':obj.options.map.elevation(obj);break;case'show':obj.show();break;case'edit':obj.edit();break;case'remove':obj.remove();break;}})
this.html['list'].on('click','img.segment-elevation',{map:this},function(event){var segment=event.data.map.file.segments[$(this).attr('rel')];if(segment){event.preventDefault();event.stopPropagation();event.data.map.elevation(segment);}});this.html['list'].on('click','img.segment-focus',{map:this},function(event){var segment=event.data.map.file.segments[$(this).attr('rel')];if(segment){event.preventDefault();event.stopPropagation();segment.focus();}});this.html['list'].on('click','img.segment-cuesheet',{map:this},function(event){var segment=event.data.map.file.segments[$(this).attr('rel')];if(segment){event.preventDefault();event.stopPropagation();segment.cuesheetDirections();}});this.html['list'].on('click','.placemark-item-image',{map:this},function(event){event.data.map.file.placemarkFilter(this);});this.html['list'].on('click','.placemark-item-name',{map:this},function(event){var placemark=event.data.map.file.placemarks[$(this).attr('rel')];if(placemark){$(event.data.map.placemarkInfo).addClass('hide');event.data.map.html['placemark-cm-info'].addClass('hide');event.data.map.infowindow.close();event.data.map.file.selectPlacemark(this,event);if(1==1||$(this).hasClass('selected')){placemark.open();}else{event.data.map.infowindow.close();}}});this.html['list'].on('mouseover','.placemark-item-name',{map:this},function(event){var rel=$(this).attr('rel');var placemark=event.data.map.file.placemarks[rel];if(placemark){placemark.marker.setVisible(true);var pm=event.data.map.html['placemark-cm-info'];$(pm).find('.placemark-cm-desc').text($('<div>').html(placemark.options.desc).text());$(pm).find('.placemark-cm-name').text(placemark.options.name);event.data.map.setMenuXY($(pm),placemark.marker.getPosition());$(pm).removeClass('hide');}});this.html['list'].on('mouseout','.placemark-item-name',{map:this},function(event){var placemark=event.data.map.file.placemarks[$(this).attr('rel')];if(placemark){var visible=event.data.map.file.visiblePlacemark||$(this).hasClass('selected')?true:false;visible=event.data.map.html['dd-display'].find('.control-placemarks').is(':checked')?true:visible;placemark.marker.setVisible(visible);$(event.data.map.file.options.map.placemarkInfo).addClass('hide');event.data.map.html['placemark-cm-info'].addClass('hide');}});this.html['list'].on('click','a.segment-item-name',{map:this},function(event){event.stopPropagation();var segment=event.data.map.file.segments[$(this).attr('rel')];if(segment){$(event.data.map.placemarkInfo).addClass('hide');event.data.map.html['placemark-cm-info'].addClass('hide');event.data.map.infowindow.close();event.data.map.file.selectSegment(this,event);if($(this).hasClass('selected')){segment.open();}else{event.data.map.infowindow.close();}}});this.html['list'].on('mouseover','a.segment-item-name',{map:this},function(event){var map=event.data.map;var rel=$(this).attr('rel');var file=map.file;var segment=file.segments[rel];if(segment){var pm=map.html['placemark-cm-info'];pm.find('.placemark-cm-desc').html('');pm.find('.placemark-cm-name').html(segment.options.name);map.setMenuXY(pm,segment.marker.getPosition());pm.removeClass('hide');google.maps.event.trigger(segment.marker,'mouseover');}});this.html['list'].on('mouseout','a.segment-item-name',{map:this},function(event){var map=event.data.map;var rel=$(this).attr('rel');var file=map.file;var segment=file.segments[rel];if(segment){map.html['ibs-container'].find('.placemark-cm-info').addClass('hide');google.maps.event.trigger(segment.marker,'mouseout');}});$(this.html['list']).mousedown(function(e){e.stopPropagation();});this.html['segment-cm-edit'].on('click','.cm-edit-action',{map:this},function(event){var segment=$(this).data().segment;event.data.map.html['segment-cm-edit'].addClass('hide');var action=$(this).attr('rel');switch(action){case'clear':if(segment){segment.stopEditing();}
break;case'delete':var point=parseInt($(this).data('index'));if(segment){segment.removePoint(point);}
break;case'split':if(segment){var index=parseInt($(this).data('index'));segment.split(index);}
break;}});this.html['segment-cm-line'].on('click','.cm-line-action',{map:this},function(event){var segment=$(this).data().segment;event.data.map.html['segment-cm-line'].addClass('hide');var action=$(this).attr('rel');switch(action){case'line-edit':segment.lineEdit();break;case'waypoint':if(segment){var index=parseInt($(this).data('point'));segment.waypoint(index);}
break;case'split':if(segment){var index=parseInt($(this).data('point'));segment.split(index);}
break;}});this.html['segment-dialog'].find('.opacity-val').spinner({'spin':$.proxy(function(event,ui){var val=ui.value;this.html['segment-dialog'].find('.colorpicker-trigger').css('opacity',val);},this)});this.html['segment-dialog'].find('.width-val').spinner({'spin':$.proxy(function(event,ui){var val=ui.value;var pad=parseInt((30-val)/2);this.html['segment-dialog'].find('.colorpicker-trigger').css('height',val+'px');this.html['segment-dialog'].find('.colorpicker-trigger').css('margin-top',pad+'px');},this)});this.html['segment-dialog'].on('change','.segment-color-select',{map:this},function(event){$(event.data.map.html['segment-dialog'].find('.segment-color')).css('background-color',$(event.data.map.mids('segment-color-select')).val());$(event.data.map.html['segment-dialog'].find('.segment-color')).css('color','#FFFFFF');$(event.data.map.html['segment-dialog'].find('.segment-color')).val($(event.data.map.html['segment-dialog'].find('.segment-color-select')).val());});this.html['file-dialog'].find('.opacity-val').spinner({'spin':$.proxy(function(event,ui){var val=ui.value;this.html['file-dialog'].find('.colorpicker-trigger').css('opacity',val);},this)});this.html['file-dialog'].find('.width-val').spinner({'spin':$.proxy(function(event,ui){var val=ui.value;var pad=parseInt((30-val)/2);this.html['file-dialog'].find('.colorpicker-trigger').css('height',val+'px');this.html['file-dialog'].find('.colorpicker-trigger').css('margin-top',pad+'px');},this)});this.html['file-dialog'].on('change','.file-color-select',{map:this},function(event){event.data.map.html['file-dialog'].find('.file-color').css('background-color',event.data.map.html['file-dialog'].find('.file-color-select').val());event.data.map.html['file-dialog'].find('.file-color').css('color','#FFFFFF');event.data.map.html['file-dialog'].find('.file-color').val(event.data.map.html['file-dialog'].find('.file-color-select').val());});this.html['file-dialog'].on('keypress','.file-settings-name',{map:this},function(event){var code=(event.keyCode?event.keyCode:event.which);if(code===13){event.preventDefault();var dialog=event.data.map.html['file-dialog'];var buttons=dialog.dialog('option','buttons');buttons['Update'].apply(dialog);}});this.html['file-dialog'].on('change','.file-name',{map:this},function(event){event.data.map.html['file-dialog'].find('input[name=file_settings_ext]:radio').trigger('change');});this.html['file-dialog'].on('change','input[name=file_ext]:radio',{map:this},function(event){var ext=event.data.map.html['file-dialog'].find('input[name=file_ext]:checked').val();var name=event.data.map.html['file-dialog'].find('.file-name').val();if(name.length<3){name+='*';}
name=getFilename(name)+'.'+ext;event.data.map.html['file-dialog'].find('.file-name').val(name);});this.html['file-dialog'].on('click','.reset-lines',{map:this},function(event){var map=event.data.map;var file=map.file;var obj=map.html['file-dialog'].find('.colorpicker-trigger');var options={strokeColor:rgb2hex($(obj).css('background-color')),strokeOpacity:parseFloat($(obj).css('opacity')).toFixed(3),strokeWeight:parseInt($(obj).css('height').replace(/px/,''))};for(var sid in file.segments){file.segments[sid].setOptions(options);file.segments[sid].line.setOptions(options);file.setDirty(true);}});this.html['save-dialog'].on('keypress','.save-name',{map:this},function(event){var code=(event.keyCode?event.keyCode:event.which);if(code===13){event.preventDefault();var dialog=event.data.html['save-dialog'];var buttons=dialog.dialog('option','buttons');buttons['Save'].apply(dialog);}});this.html['save-dialog'].on('change','.save-name',{map:this},function(event){event.data.map.html['save-dialog'].find('input[name="file_ext"]:radio').trigger('change');});this.html['save-dialog'].on('change','.save-dir',{map:this},function(event){var dir=event.data.map.html['save-dialog'].find('.save-dir').val();var dir=dir+'/';dir=dir.replace('//','/');event.data.map.html['save-dialog'].find('.save-dir').val(dir);});this.html['save-dialog'].on('change','input[name="file_ext"]:radio',{map:this},function(event){var ext=event.data.map.html['save-dialog'].find('input[name="file_ext"]:checked').val();var name=event.data.map.html['save-dialog'].find('.save-name').val();if(name.length<3){name+='*';}
name=getFilename(name)+'.'+ext;event.data.map.html['save-dialog'].find('.save-name').val(name);});this.uploader.on('submit','',{},$.proxy(function(){this.uploadCount++;},this));this.uploader.on('complete','',{map:this},function(event,id,fileName,responseJSON){var map=event.data.map;map.uploadCount--;if(map.uploadCount===0){map.html['upload-dialog'].dialog('close');}
var ext=getExtension(fileName).toLowerCase();if(ext==='kml'||ext==='kmz'||ext==='gpx'){var dir=map.html['upload-dialog'].find('.upload-target-directory').val();dir=ibs_mappro.maps_url+dir;map.file.importFile(dir+fileName);}});this.html['data'].on('click','.chart-close',{map:this},function(event){event.data.map.elevationSegment=null;event.data.map.sizeHtml();})
this.html['file-dialog'].find('.reset-lines').button({text:true,label:'Set Lines',icons:{primary:'ui-icon-arrowreturnthick-1-e'}});this.html['upload-dialog'].on('change','.upload-target-directory',{map:this},function(event){var map=event.data.map;var newdir=map.html['upload-dialog'].find('.upload-target-directory').val();newdir=newdir+"/";newdir=newdir.replace('//','/');map.html['upload-dialog'].find('.upload-target-directory').val(newdir.replace(ibs_mappro.maps_path,''));map.uploader.fineUploader('setParams',{'dir':newdir});});var init_height=this.options.height==='100%'?$(window).height():this.options.height;var init_width=this.options.width==='100%'?$(window).width():this.options.width;this.html['ibs-container'].width(init_width);this.html['ibs-container'].height(init_height);this.html['ibs-container'].on('resizestop','',{map:this},function(event){event.data.map.sizeHtml();});this.html['list'].on('resizestop','',{map:this},function(event){event.data.map.sizeHtml();});this.html['ibs-header'].on('click','.ibs-size',{map:this},function(event){event.data.map.resetSize();});this.resetSize();};Map.prototype.resetSize=function(){var init_height=this.options.height==='100%'?$(window).height():this.options.height;var init_width=this.options.width==='100%'?$(window).width():this.options.width;this.html['ibs-container'].css({'top':this.options.top,'left':this.options.left})
this.html['ibs-container'].width(init_width);this.html['ibs-container'].height(init_height);this.sizeHtml();}
Map.prototype.sizeHtml=function(){if(this.elevationSegment){this.html['data'].height(200)}else{this.html['data'].height(0);}
var height=$(window).height()<this.html['ibs-container'].height()?$(window).height():this.html['ibs-container'].height();var width=$(window).width()<this.html['ibs-container'].width()?$(window).width():this.html['ibs-container'].width();height-=this.options.top;width-=this.options.left;this.html['ibs-container'].width(width);this.html['ibs-container'].height(height);var v=this.html['ibs-container'].height();var x=this.html['ibs-header'].find('div').height();var y=this.html['ibs-footer'].height();var h=v-x-y-4;$(this.html['ibs-main']).css('height',h-10+'px');var hh=0;x=$(this.html['ibs-container']).width();y=this.options.mode!=='edit'?0:$(this.html['list']).width();var w=x-y-5;this.html['app'].width(w);x=$(this.html['data']).height();this.html['map'].width(w);this.html['map'].height(h-x);this.html['data-chart'].height(this.html['data'].height()-$(this.html['data']).find('span:first').height())
this.html['data-chart'].width(this.html['data'].width());if(this.googlemap)
google.maps.event.trigger(this.googlemap,'resize');};})(jQuery);
(function($){Map.prototype.setHtml=function(){$(this.options.div).append($('<div>').attr('id',this.options.mid).append($('<div>').addClass('ibs-container').resizable().append($('<div>').addClass('ibs-header')).append($('<div>').addClass('ibs-main')).append($('<div>').addClass('ibs-footer'))));this.html['page']=$('#'+this.options.mid);this.html['ibs-container']=this.html['page'].find('.ibs-container');this.html['ibs-header']=this.html['ibs-container'].find('.ibs-header');if(this.options.user_type!=='admin'){$('#content').css('font-size','13px')}
if(this.options.mode==='edit'){this.html['ibs-header'].append($('<div>').append($('<button>').addClass('ibs-map').attr({title:'map action menu',href:"#",'data-dropdown':'#'+this.options.mid+'-dropdown-map'})).append($('<button>').addClass('ibs-route').attr({title:'route action menu',href:"#",'data-dropdown':'#'+this.options.mid+'-dropdown-route'})).append($('<button>').addClass('ibs-draw').attr({title:'drawing settings',href:"#",'data-dropdown':'#'+this.options.mid+'-dropdown-options'})).append($('<button>').addClass('ibs-display').attr({title:'display settings',href:"#",'data-dropdown':'#'+this.options.mid+'-dropdown-display'})).append($('<button>').addClass('ibs-settings').attr({title:'edit settings',href:"#"})).append($('<button>').addClass('ibs-find').attr({title:'find address',href:"#"})).append($('<button>').addClass('ibs-reset').attr({title:'reset map',href:"#"})).append($('<a>').addClass('ibs-size size-up').attr({title:'restore size and position',href:"#"}).text('X')));}else{this.html['ibs-header'].append($('<div>').append($('<button>').addClass('ibs-map').attr({title:'map action menu',href:"#",'data-dropdown':'#'+this.options.mid+'-dropdown-map'})).append($('<button>').addClass('ibs-display').attr({title:'display settings',href:"#",'data-dropdown':'#'+this.options.mid+'-dropdown-display'})).append($('<a>').addClass('ibs-size size-up').attr({title:'restore size and position',href:"#"}).text('X')));}
this.html['ibs-main']=this.html['ibs-container'].find('.ibs-main');this.html['ibs-footer']=this.html['ibs-container'].find('.ibs-footer');this.html['ibs-main'].append($('<div>').addClass('list').css({'display':this.options.mode==='edit'?'block':'none'}).resizable().append($('<div>').addClass('file-list-name list-hdr img-kml').append('<a class="list-action-edit list-filename" href="#" title="edit file attributes"></a>')).append($('<div>').addClass('import-list-name list-hdr img-upload').append('<a class="list-action-import" href="#" title="imported maps files">Imported maps</a>')).append($('<div>').addClass('import-list-div hide').resizable({containment:"parent"}).append($('<ul>').addClass('import-list'))).append($('<div>').addClass('placemark-list-name list-hdr img-marker').append('<a class="list-action-placemark" href="#" title="add new placemarker">Marker</a>')).append($('<div>').addClass('placemark-list-div').resizable({containment:"parent"}).append($('<ul>').addClass("placemark-list controls"))).append($('<div>').addClass('segment-list-name list-hdr img-line').append('<a class="list-action-route" href="#" title="start new route">Route</a>')).append($('<div>').addClass('segment-list-div').resizable({containment:"parent"}).append($('<ul>').addClass("segment-list controls")))).append($('<div>').addClass('app').append($('<div>').addClass('map').append($('<div>').addClass('map-div'))).append($('<div>').addClass('data')));this.html['list']=$(this.html['ibs-main']).find('.list');this.html['app']=$(this.html['ibs-main']).find('.app');this.html['map']=$(this.html['app']).find('.map');this.html['map-div']=$(this.html['map']).find('.map-div');this.html['data']=$(this.html['app']).find('.data');$(this.html['data']).append($('<span>').addClass('box-span').append($('<span>').addClass('data-segment')).append($('<span>').addClass('data-distance')).append($('<span>').addClass('data-gain')).append($('<img>').addClass('chart-close').css('float','right').attr('src',ibs_mappro.site+'image/minus.png'))).append($('<div>').addClass('data-chart'));this.html['data-chart']=$(this.html['data']).find('.data-chart');this.html['map'].append($('<div>').addClass('distance-info hide')).append($('<div>').addClass('pend-info hide'));this.html['ibs-footer'].append($('<div>').addClass('ibs-message'));this.setDialogs();if(this.options.mode==='edit'){$(document).find('body').append('<div id="'+this.options.mid+'-dropdown-map" class="dropdown dropdown-tip has-icons">'
+'<ul class="dropdown-menu dropdown-list">'
+'<li class="dropdown-divider"></li>'
+'<li class="img-browse"><a class="map-action-browse user-hide"  href="#">Browse server</a></li>'
+'<li class="img-save"><a class="map-action-save user-hide" href="#">Save to server</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-upload"><a class="map-action-upload"  href="#">Desktop upload</a></li>'
+'<li class="img-download"><a class="map-action-download" href="#">Desktop download</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-web"><a class="map-action-web"  href="#">Web import</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-document"><a class="map-action-show" href="#">Show xml</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-focus"><a class="map-action-focus" href="#">Focus map</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-edit"><a class="map-action-edit" href="#">Edit map info</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-delete"><a class="map-action-clear"  href="#">Clear</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-sort"><a class="map-action-sort"  href="#">Sort placemarkers</a></li>'
+'<li class="img-flip"><a class="map-action-flip" href="#">Reverse travel direction</a></li>'
+'<li class="dropdown-divider"></li>'
+'</ul>'
+'</div>'
+'<div id="'+this.options.mid+'-dropdown-route" class="dropdown dropdown-tip has-icons">'
+'<ul class="dropdown-menu dropdown-list">'
+'<li class="dropdown-divider"></li>'
+'<li class="img-extend"><a class="route-action-extend" href="#">Extend route</a></li>'
+'<li class="img-undo"><a class="route-action-undo" href="#">Undo</a></li>'
+'<li class="img-refresh"><a class="route-action-rebuild" href="#">Rebuild</a></li>'
+'<li class="img-focus"><a class="route-action-focus" href="#">Focus</a></li>'
+'<li class="img-cue"><a class="route-action-cue" href="#">Google directions</a></li>'
+'<li class="img-cue"><a class="route-action-profile" href="#">Elevation profile</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-edit"><a class="route-action-edit" href="#">Edit</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-delete"><a class="route-action-remove" href="#">Remove</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-append"><a class="route-action-append" href="#">Append to next line</a></li>'
+'<li class="img-line-edit"><a class="route-action-ledit" href="#">Line edit</a></li>'
+'<li class="img-flip"><a class="route-action-flip" href="#">Reverse direction</a></li>'
+'<li class="img-thin"><a class="route-action-thin" href="#">Minimize points</a></li>'
+'<li class="dropdown-divider"></li>'
+'</ul>'
+'</div>'
+'<div id="'+this.options.mid+'-dropdown-display" class="dropdown dropdown-tip">'
+'<ul class="dropdown-menu">'
+'<li class="dropdown-divider"></li>'
+'<li><label><input class="control-distance-flag" type="checkbox" /> Distance flag</label></li>'
+'<li><label><input class="control-bike-layer" type="checkbox" /> Bike layer</label></li>'
+'<li><label><input class="control-placemarks" type="checkbox" /> Show placemarks</label></li>'
+'<li><label><input class="control-waypoints" type="checkbox" /> Show waypoints</label></li>'
+'<li class="dropdown-divider"></li>'
+'</ul>'
+'</div>'
+'<div id="'+this.options.mid+'-dropdown-options" class="dropdown dropdown-tip">'
+'<ul class="dropdown-menu">'
+'<li class="dropdown-divider"></li>'
+'<li><label><input class="control-followroad" type="checkbox"  /> Follow road</label></li>'
+'<li><label><input class="control-avoidhighways" type="checkbox"  /> Avoid highways</label></li>'
+'<li class="dropdown-divider"></li>'
+'<li><label><input class="control-rb-drive" type="radio" name="travelmode" value="DRIVING" /> Driving</label></li>'
+'<li><label><input class="control-rb-bike" type="radio" name="travelmode" value="BICYCLING"/> Bicycling </label></li>'
+'<li><label><input class="control-rb-walk" type="radio" name="travelmode" value="WALKING"/> Walking</label></li>'
+'<li class="dropdown-divider"></li>'
+'</ul>'
+'</div>');this.html['dd-route']=$('#'+this.options.mid+'-dropdown-route');this.html['dd-map']=$('#'+this.options.mid+'-dropdown-map');this.html['dd-options']=$('#'+this.options.mid+'-dropdown-options');this.html['dd-display']=$('#'+this.options.mid+'-dropdown-display');this.html['dd-options'].find('.control-followroad').prop('checked',this.options.followroad);this.html['dd-options'].find('.control-avoidhighways').prop('checked',this.options.avoidhighways);this.html['dd-options'].find('.control-rb-drive').prop('checked',this.options.travelmode==='DRIVING');this.html['dd-options'].find('.control-rb-bike').prop('checked',this.options.travelmode==='BICYCLING');this.html['dd-options'].find('.control-rb-walk').prop('checked',this.options.travelmode==='WALKING');}else{if(this.options.url===''){$(document).find('body').append('<div id="'+this.options.mid+'-dropdown-map" class="dropdown dropdown-tip has-icons">'
+'<ul class="dropdown-menu dropdown-list">'
+'<li class="dropdown-divider"></li>'
+'<li class="img-browse"><a class="map-action-browse"  href="#">Browse</a></li>'
+'<li class="img-upload"><a class="map-action-upload"  href="#">Upload</a></li>'
+'<li class="img-download"><a class="map-action-download" href="#">Download</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-web"><a class="map-action-web"  href="#">Web import</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-document"><a class="map-action-show" href="#">Show xml</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-focus"><a class="map-action-focus" href="#">Focus map</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-edit"><a class="map-action-edit" href="#">Statistics</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-delete"><a class="map-action-clear"  href="#">Clear</a></li>'
+'<li class="dropdown-divider"></li>'
+'</ul>'
+'</div>'
+'<div id="'+this.options.mid+'-dropdown-display" class="dropdown dropdown-tip">'
+'<ul class="dropdown-menu">'
+'<li class="dropdown-divider"></li>'
+'<li><label><input class="control-distance-flag" type="checkbox" /> Distance flag</label></li>'
+'<li><label><input class="control-bike-layer" type="checkbox" /> Bike layer</label></li>'
+'<li><label><input class="control-placemarks" type="checkbox" /> Show placemarks</label></li>'
+'<li><label><input class="control-waypoints" type="checkbox" /> Show waypoints</label></li>'
+'<li class="dropdown-divider"></li>'
+'</ul>'
+'</div>');}else{$(document).find('body').append('<div id="'+this.options.mid+'-dropdown-map" class="dropdown dropdown-tip has-icons">'
+'<ul class="dropdown-menu dropdown-list">'
+'<li class="dropdown-divider"></li>'
+'<li class="img-download"><a class="map-action-download" href="#">Download</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-document"><a class="map-action-show" href="#">Show xml</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-focus"><a class="map-action-focus" href="#">Focus map</a></li>'
+'<li class="dropdown-divider"></li>'
+'<li class="img-edit"><a class="map-action-edit" href="#">Statistics</a></li>'
+'<li class="dropdown-divider"></li>'
+'</ul>'
+'</div>'
+'<div id="'+this.options.mid+'-dropdown-display" class="dropdown dropdown-tip">'
+'<ul class="dropdown-menu">'
+'<li class="dropdown-divider"></li>'
+'<li><label><input class="control-distance-flag" type="checkbox" /> Distance flag</label></li>'
+'<li><label><input class="control-bike-layer" type="checkbox" /> Bike layer</label></li>'
+'<li><label><input class="control-placemarks" type="checkbox" /> Show placemarks</label></li>'
+'<li><label><input class="control-waypoints" type="checkbox" /> Show waypoints</label></li>'
+'<li class="dropdown-divider"></li>'
+'</ul>'
+'</div>');}
this.html['dd-map']=$('#'+this.options.mid+'-dropdown-map');this.html['dd-display']=$('#'+this.options.mid+'-dropdown-display');}
this.getIconOptions(this.html['placemark-dialog'].find('.placemark-dialog-select'));this.html['file-dialog'].find('.file-dialog-color-select').colorpicker({size:20,label:'Color ',hide:true});this.html['segment-dialog'].find('.segment-dialog-color-select').colorpicker({size:20,label:'Color ',hide:true});this.html['dialogs'].find('.cp-cancel').attr('src',ibs_mappro.site+'image/cancel.png');this.html['cuesheet-dialog'].find('input[name=cue_source][value='+this.options.cuesheet_source+']').attr('checked',true);$(this.html['file-dialog']).find('.reset-lines').button({text:true,label:'Set Lines',icons:{primary:'ui-icon-arrowreturnthick-1-e'}});this.uploader=this.html['upload-dialog'].find('.upload-button').fineUploader({listElement:this.html['upload-dialog'].find('.upload-list'),request:{endpoint:this.siteUrl()+'js/jquery.fineuploader/server/endpoint.php',params:{'dir':ibs_mappro.maps_path+'upload/'}},debug:false});this.html['ibs-header'].find('.ibs-reset').button({text:true,label:'Reset',icons:{primary:'ui-icon-stop'}});this.html['ibs-header'].find('.ibs-find').button({text:true,label:'Find address',icons:{primary:'ui-icon-search'}});this.html['ibs-header'].find('.ibs-map').button({text:true,label:'Map tools',icons:{secondary:' ui-icon-triangle-1-s'}});this.html['ibs-header'].find('.ibs-route').button({text:true,label:'Route tools',icons:{secondary:' ui-icon-triangle-1-s'}});this.html['ibs-header'].find('.ibs-display').button({text:true,label:'Display options',icons:{secondary:' ui-icon-triangle-1-s'}});this.html['ibs-header'].find('.ibs-draw').button({text:true,label:'Route options',icons:{secondary:' ui-icon-triangle-1-s'}});if(this.options.user_type!=='admin'){this.html['ibs-header'].find('.ui-button').css('font-size','10px');}
if(this.options.user_type!=='admin'){this.html['dd-map'].find('.user-hide').hide();}
this.html['ibs-header'].find('.ibs-route').button('option','disabled',true);this.html['ibs-container'].css({'width':this.options.width,'height':this.options.height});this.uploadCount=0;this.setHandlers();this.sizeHtml();$('.colorpicker-trigger').attr({'title':'click to change color'});};File.prototype.openInfo=function(obj){var info='';if(typeof obj.options.sid==='undefined'){var rel=obj.options.pid;}else{rel=obj.options.sid;}
if(this.options.map.options.mode==='edit'){info=$('<div>').addClass('info-node').append($('<div>').append($('<div>').addClass('info-name').append($('<span>').text(obj.options.name))).append($('<div>').addClass('info-desc').html(obj.options.desc))).append($('<div>').addClass('info-footer').append($('<a>').text('edit').attr({'rel':rel,'action':'edit'})).append($('<a>').text('remove').attr({'rel':rel,'action':'remove'})).append($('<a>').text('close').attr({'rel':rel,'action':'close'})));}else{if(typeof obj.options.sid==='undefined'){info=$('<div>').addClass('info-node').append($('<div>').append($('<div>').addClass('info-name').append($('<span>').text(obj.options.name))).append($('<div>').addClass('info-desc').html(obj.options.desc))).append($('<div>').addClass('info-footer').append($('<a>').text('more').attr({'rel':rel,'action':'show'})).append($('<a>').text('close').attr({'rel':rel,'action':'close'})));}else{info=$('<div>').addClass('info-node').append($('<div>').append($('<div>').addClass('info-name').append($('<span>').text(obj.options.name))).append($('<div>').addClass('info-desc').html(' miles='+this.options.map.convertMeters2(obj.distance()).toString()))).append($('<div>').addClass('info-footer').append($('<a>').text('more').attr({'rel':rel,'action':'show'})).append($('<a>').text('profile').attr({'rel':rel,'action':'elevation'})).append($('<a>').text('close').attr({'rel':rel,'action':'close'})));}}
this.options.map.infowindow.setContent(info[0]);this.options.map.infowindow.open(this.options.map.googlemap,obj.marker);};Segment.prototype.setSegmentItem=function(){var rel=this.options.sid;this.segmentList.append($('<li>').addClass("segment-item").attr({'rel':rel}).append($('<div>').addClass("ct-list-div hide").append($('<a>').attr({'href':"#",'title':"focus segment"}).append($('<img>').addClass("segment-focus").attr({'rel':rel,'src':this.options.map.siteUrl()+'image/zoom.png'}))).append($('<a>').attr({'href':"#",'title':"elevation profile"}).append($('<img>').addClass("segment-elevation").attr({'rel':rel,'src':this.options.map.siteUrl()+'image/chart.png'}))).append($('<span>').append($('<a>').attr({'href':"#",'title':"generate cue sheet"}).append($('<img>').addClass("segment-cuesheet").attr({'rel':rel,'src':this.options.map.siteUrl()+'image/cue.png'}).data({segment:this}))))).append($('<a>').addClass('segment-item-name').attr({'rel':rel,'href':"#",'title':""}).text(this.options.name)));};Placemark.prototype.setPlacemarkItem=function(){var rel=this.options.pid;var item=$('<li>').addClass('placemark-item '+rel).append($('<div>').addClass("ct-list-div").append($('<img>').addClass("placemark-item-image").css({height:'20px'}).attr({'rel':rel,'alt':"image",'src':this.marker.icon.url}))).append($('<a>').addClass(this.options.map.options.mid+' placemark-item-name name').attr({'rel':rel,'href':"#",'title':""}).text(this.options.name));$(this.placemarkList).append($(item));};})(jQuery);
(function($){Map.prototype.setIcons=function(){this.imageDistancePointer=new google.maps.MarkerImage(this.siteUrl()+'image/crosshair-black.png',new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8));this.imageBlueMarker=new google.maps.MarkerImage(this.siteUrl()+'image/blue.png',new google.maps.Size(20,34),new google.maps.Point(0,0),new google.maps.Point(10,34));this.imageRedMarker=new google.maps.MarkerImage(this.siteUrl()+'image/red.png',new google.maps.Size(20,34),new google.maps.Point(0,0),new google.maps.Point(10,34));this.imageLineActive=new google.maps.MarkerImage(this.siteUrl()+"image/redCircle.png",new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8));this.imageLineNormal=new google.maps.MarkerImage(this.siteUrl()+"image/blue_box.png",new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8));this.imageWaypointNormal=new google.maps.MarkerImage(this.siteUrl()+"image/waypoint.png",new google.maps.Size(32,32),new google.maps.Point(0,0),new google.maps.Point(15,25));this.imageNormal=new google.maps.MarkerImage(this.siteUrl()+"image/square.png",new google.maps.Size(11,11),new google.maps.Point(0,0),new google.maps.Point(6,6));this.imageHover=new google.maps.MarkerImage(this.siteUrl()+"image/square_over.png",new google.maps.Size(11,11),new google.maps.Point(0,0),new google.maps.Point(6,6));this.imageNormalMidpoint=new google.maps.MarkerImage(this.siteUrl()+"image/square_transparent.png",new google.maps.Size(11,11),new google.maps.Point(0,0),new google.maps.Point(6,6));var me=this;$.get(ibs_mappro.ajax,{'action':'ibs_mappro_garmin'},function(data,status){me.garmin_symbols=data;},'json');};Map.prototype.getIcon=function(url){if(url.indexOf('-lv')!==-1){return new google.maps.MarkerImage(url,new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8),new google.maps.Size(16,16));}else{return new google.maps.MarkerImage(url,new google.maps.Size(32,32),new google.maps.Point(0,0),new google.maps.Point(16,33),new google.maps.Size(32,32));}};Map.prototype.getSymbol=function(url){for(var i=0;i<this.garmin_symbols.length;i++){if(url===this.garmin_symbols[i].url){return this.garmin_symbols[i].name;}}
if(getFilename(url)==='icon61'){return'Waypoint';}
return initialCaps(getFilename(url).replace('-',' ').replace('_',' '));};Map.prototype.getUrlFromSymbol=function(symbol){if(symbol==='Waypoint'){return this.siteUrl()+"image/waypoint.png";}
var result=this.siteUrl()+"image/picture.png";if(symbol!==''){for(var i=0;i<this.garmin_symbols.length;i++){if(symbol===this.garmin_symbols[i].name){result=this.garmin_symbols[i].url;break;}}}
return result;};Map.prototype.getIconOptions=function(list){$.get(ibs_mappro.ajax,{'action':'ibs_mappro_icon_palette'},function(data,status){$(list).empty();for(var i in data){var bg="background:url(xxx) left top no-repeat; vertical-align:middle;".replace(/xxx/,data[i].url);$(list).append($('<li class="placemark-select-item" >').attr('style',bg).append($('<input>').addClass('icon-option-name').attr({disabled:true,'type':'text','value':data[i].name})).append($('<input>').addClass('icon-option-value').attr({'type':'hidden','value':data[i].url})))}},'json');};})(jQuery);
function KML(){this.options={name:null,desc:null,url:null,position:null,draggable:false,visible:false,strokeColor:'#0000ff',strokeWeight:3,strokeOpacity:0.5,path:[]};this.kml=null;this.file=null;}
(function($){KML.prototype.writer=function(file){var line_styles=[];var icon_styles=[];var segment_list=file.listSegments();var placemark_list=file.listPlacemarks();function setLineStyle(style){for(var i=0;i<line_styles.length;i++){if(style.color===line_styles[i].color&&style.width===line_styles[i].width){return'#'+line_styles[i].id;}}
style.id='LineStyle-'+padLeftStr(line_styles.length+1,3,'0');line_styles.push(style);return'#'+style.id;}
function setIconStyle(style){for(var i=0;i<icon_styles.length;i++){if(style.icon===icon_styles[i].icon){return'#'+icon_styles[i].id;}}
style.id='IconStyle-'+padLeftStr(icon_styles.length+1,3,'0');icon_styles.push(style);return'#'+style.id;}
for(var sid in file.segments){var sg=file.segments[sid];var color=colorKML(sg.options.strokeOpacity,sg.options.strokeColor);sg.options.style=setLineStyle({'color':color,'width':sg.options.strokeWeight.toString()});}
for(var pid in file.placemarks){var pm=file.placemarks[pid];pm.options.style=setIconStyle({'icon':pm.marker.icon.url});}
var xml=new XMLWriter('UTF-8','1.0');xml.writeStartDocument();xml.writeStartElement('kml');xml.writeAttributeString('xmlns','http://www.opengis.net/kml/2.2');xml.writeStartElement('Document');xml.writeStartElement('name');xml.writeCDATA(file.options.name);xml.writeEndElement();xml.writeElementString('open','1');xml.writeStartElement('description');xml.writeCDATA(file.options.desc);xml.writeEndElement();for(var i=0;i<icon_styles.length;i++){xml.writeStartElement('Style');xml.writeAttributeString('id',icon_styles[i].id);xml.writeStartElement('IconStyle');xml.writeStartElement('Icon');xml.writeElementString('href',icon_styles[i].icon);xml.writeEndElement();xml.writeEndElement();xml.writeEndElement();}
for(var i=0;i<line_styles.length;i++){xml.writeStartElement('Style');xml.writeAttributeString('id',line_styles[i].id);xml.writeStartElement('LineStyle');xml.writeElementString('color',line_styles[i].color);xml.writeElementString('width',line_styles[i].width);xml.writeEndElement();xml.writeStartElement('PolyStyle');xml.writeElementString('color',line_styles[i].color);xml.writeEndElement();xml.writeEndElement();}
xml.writeStartElement('Folder');xml.writeElementString('name','Placemarks');xml.writeElementString('description','placemarks');for(var i=0;i<placemark_list.length;i++){var pm=file.placemarks[placemark_list[i]];var lat=pm.options.position.lat().toString();var lng=pm.options.position.lng().toString();xml.writeStartElement('Placemark');xml.writeStartElement('name');xml.writeCDATA(pm.options.name);xml.writeEndElement();xml.writeStartElement('description');xml.writeCDATA(pm.options.desc);xml.writeEndElement();xml.writeElementString('styleUrl',pm.options.style);xml.writeStartElement('Point');xml.writeElementString('coordinates',lng+','+lat+',0');xml.writeEndElement();xml.writeEndElement();}
xml.writeEndElement();xml.writeStartElement('Folder');xml.writeElementString('name','segments');xml.writeElementString('description','segment lines');for(i=0;i<segment_list.length;i++){var sg=file.segments[segment_list[i]];var coordinates='';sg.line.getPath().forEach(function(latlng){coordinates+=latlng.lng().toString()+','+latlng.lat().toString()+',0.00000 \n';});xml.writeStartElement('Placemark');xml.writeStartElement('name');xml.writeCDATA(sg.options.name);xml.writeEndElement();xml.writeStartElement('description');xml.writeCDATA(sg.options.desc);xml.writeEndElement();xml.writeElementString('styleUrl',sg.options.style);xml.writeStartElement('LineString');xml.writeElementString('altitudeMode','clampToGround');xml.writeElementString('coordinates',coordinates);xml.writeEndElement();xml.writeEndElement();}
xml.writeEndElement();xml.writeEndElement();xml.writeEndElement();xml.writeEndDocument();return xml.flush();};KML.prototype.getLineStyle=function(lineStyle){var color=$(lineStyle).find('color').text();var width=$(lineStyle).find('width').text();var aa=color.substr(0,2);var bb=color.substr(2,2);var gg=color.substr(4,2);var rr=color.substr(6,2);this.options.strokeColor="#"+rr+gg+bb;this.options.strokeOpacity=parseInt(aa,16)/256;this.options.strokeWeight=parseInt(width);};KML.prototype.getStyle=function(placemark){$(placemark).find('styleUrl').each($.proxy(function(n,styleUrl){var styleId=$(styleUrl).text().substr(1);$(this.kml).find('Style[id='+styleId+']').each($.proxy(function(n,style){$(style).find('LineStyle').each($.proxy(function(n,lineStyle){this.getLineStyle(lineStyle);},this));$(style).find('IconStyle').each($.proxy(function(n,iconStyle){this.options.url=$(iconStyle).find('href:first').text();},this));},this));},this));$(placemark).children('Style').each($.proxy(function(n,style){$(style).children('LineStyle').each($.proxy(function(n,lineStyle){this.getLineStyle(lineStyle);},this));$(style).children('IconStyle').each($.proxy(function(n,iconStyle){this.options.url=$(iconStyle).find('href:first').text();},this));},this));};KML.prototype.getLineString=function(placemark){$(placemark).children('LineString').each($.proxy(function(n,lineString){this.options.path=[];var coordinates=$(lineString).children('coordinates').text();coordinates=coordinates.replace(/\n/g,' ');coordinates=$.trim(coordinates);while(coordinates.indexOf('  ')>0){coordinates=coordinates.replace(/  /g,' ');}
var coordinatesArray=coordinates.split(' ');for(var i=0;i<coordinatesArray.length;i++){var strArray=coordinatesArray[i].split(',');var lng=parseFloat(strArray[0]);var lat=parseFloat(strArray[1]);this.options.path.push(new google.maps.LatLng(lat,lng));}
if(this.options.path.length>0)
this.file._addSegment(this.options);},this));};KML.prototype.getPoint=function(placemark){$(placemark).children('Point').each($.proxy(function(n,point){var coordinates=$(point).children('coordinates').text();coordinates=$.trim(coordinates);var strArray=coordinates.split(',');var lng=parseFloat(strArray[0]);var lat=parseFloat(strArray[1]);this.options.position=new google.maps.LatLng(lat,lng);if(this.options.name)
this.file._addPlacemark(this.options);},this));};KML.prototype.getDocument=function(document){if(getCDATA($(document).contents('name').text())==='Track Points')
return;this.file.options.name=getCDATA($(document).contents('name').text());this.file.options.desc=getCDATA($(document).contents('description').text());$(document).children('Placemark').each($.proxy(function(n,placemark){this.options.name=getCDATA($(placemark).children('name').text());this.options.desc=getCDATA($(placemark).children('description').text());this.getStyle(placemark);this.getLineString(placemark);this.getPoint(placemark);},this));$(document).children('Folder').each($.proxy(function(n,folder){this.getDocument(folder);},this));};KML.prototype.reader=function(xml,file){this.file=file;$(xml).children('kml').each($.proxy(function(n,kml){this.kml=kml;$(this.kml).children('Document').each($.proxy(function(n,document){this.getDocument(document);},this));$(this.kml).children('Folder').each($.proxy(function(n,folder){this.getDocument(folder);},this));},this));};KML.prototype.kmlWindow=function(kml){var newWindow=window.open('','KML Export '+(new Date()).getTime(),"width=800,height=1000");newWindow.document.write('<textarea id="kml" style="width: 100%; height: 100%">'+kml+'</textarea>');};})(jQuery);
function Map(arg){this.init(arg);}
(function($){Map.prototype.init=function(arg){this.options={address:'',div:'body',top:0,left:0,height:'100%',width:'100%',url:'',mid:'M1001',metric:false,filename:'',location:new google.maps.LatLng(37.09024,-95.712891),strokeColor:'#000fff',strokeWeight:5,strokeOpacity:0.3,distance:false,followroad:true,travelmode:"DRIVING",avoidhighways:true,user_type:'guest',user_name:'unknown',pid:'',gpx_routes:false,gpx_tracks:true,gpx_waypoints:true,gpx_placemarks:true,mode:'edit'};for(var attr in arg){this.options[attr]=arg[attr];}
this.siteRoot=function(){return ibs_mappro.root;};this.siteUrl=function(){return ibs_mappro.site;};this.html=[];this.garmin_symbols=null;this.files={};this.fileId=1000;this.googlemap=null;if(typeof window.maps==='undefined'){window.maps={};}
this.options.mid='M1'+padLeftStr(Object.keys(window.maps).length+1,3,'0');window.maps[this.options.mid]=this;this.click=function(event){var sid=click_target.sid;var pid=click_target.pid;click_target={pid:null,sid:null};this.setCursor('pointer');if(sid){var segment=this.file.segments[sid];segment.pend='extend';segment.click(event);}
if(pid){var placemark=this.file.placemarks[pid];placemark.click(event);}
this.file.click(event);};var click_target={pid:null,sid:null};this.setClick=function(target){this.file.pendReset();if(!target){click_target={pid:null,sid:null};this.setCursor('pointer');return false;}else{click_target=target;this.setCursor('crosshair');return true;}};this.getClick=function(){return click_target;};this.setCursor=function(cursor){this.googlemap.setOptions({draggableCursor:cursor});};this.fitBounds=function(){var bounds=new google.maps.LatLngBounds();this.file.getBounds(bounds);this.googlemap.fitBounds(bounds);this.file.refresh();};this.setBikeLayer=function(bool){if(bool){this.bicycleLayer.setMap(this.googlemap);}else{this.bicycleLayer.setMap(null);}};this.setMenuXY=function(item,latlng){var mapWidth=this.html['map-div'].width();var mapHeight=this.html['map-div'].height();var menuWidth=item.width();var menuHeight=item.height();var clickedPosition=this.getCanvasXY(latlng);var left=clickedPosition.x;var top=clickedPosition.y;left=mapWidth-left<menuWidth?left-menuWidth:left;top=mapHeight-top<menuHeight?top-menuHeight:top;item.css({'left':left,'top':top,'position':'absolute'});};this.getCanvasXY=function(latlng){var scale=Math.pow(2,this.googlemap.getZoom());var nw=new google.maps.LatLng(this.googlemap.getBounds().getNorthEast().lat(),this.googlemap.getBounds().getSouthWest().lng());var worldCoordinateNW=this.googlemap.getProjection().fromLatLngToPoint(nw);var worldCoordinate=this.googlemap.getProjection().fromLatLngToPoint(latlng);var latlngOffset=new google.maps.Point(Math.floor((worldCoordinate.x-worldCoordinateNW.x)*scale),Math.floor((worldCoordinate.y-worldCoordinateNW.y)*scale));return latlngOffset;};this.measure1=function(){return this.options.metric?'(m)':'(f)';};this.measure2=function(){return this.options.metric?' km':' mi';};this.convertMeters1=function(meters){return this.options.metric?meters.toFixed(2):(meters*3.2808399).toFixed(2);};this.convertMeters2=function(meters){return this.options.metric?(meters/1000).toFixed(2):(meters/1609.344).toFixed(2);};this.isGuest=function(){return this.options.user_type==='guest'||this.options.mode!=='edit';};this.isAdmin=function(){return this.options.user_type==='admin'&&this.options.mode==='edit';};this.getUser=function(){return this.options.user_type;};this.getPath=function(){var folder=this.isAdmin()?'':'share/';return this.options.maps_path+folder;};this.getUserFolder=function(){if(this.options.user_name!=='unknown'&&this.options.user_name!==''&&/^[a-z0-9_-]{3,16}$/.test(this.options.user_name))
return this.options.user_name+'/'
else
return'';;}
this.getCkeditorConfig=function(){return{toolbarStartupExpanded:true,extraPlugins:'print,table',disableNativeSpellChecker:false,browserContextMenuOnCtrl:true,removePlugins:'scayt',height:200,contentsCss:this.options.site+'/css/map.css',resize_enabled:true,toolbar:[['Source','Undo','Redo','-','SelectAll','RemoveFormat'],['Bold','Italic','Underline','Strike'],['Link','Unlink','Image'],['TextColor','BGColor','Print','Table']]};};this.kml=new KML();this.gpx=new GPX();this.setIcons();this.setHtml();this.setMap();this.setFile();if(isUrl(this.options.url)){this.file.importFile(this.options.url);}else{if(this.options.address!==''){this.geocoder.geocode({'address':this.options.address},$.proxy(function(results,status){if(status===google.maps.GeocoderStatus.OK){var lat=results[0].geometry.location.lat();var lng=results[0].geometry.location.lng();lng=parseFloat(lng);lat=parseFloat(lat);if(typeof lat==='number'&&typeof lng==='number'){var latlng=new google.maps.LatLng(lat,lng);this.googlemap.setCenter(latlng);}}},this));}}};Map.prototype.setFile=function(){this.file=new File({map:this,url:'',strokeColor:this.options.strokeColor,strokeWeight:this.options.strokeWeight,strokeOpacity:this.options.strokeOpacity,filename:this.options.filename,gpx_routes:this.options.gpx_routes,gpx_tracks:this.options.gpx_tracks,gpx_waypoints:this.options.gpx_waypoints,gpx_placemarks:this.options.gpx_placemarks});};Map.prototype.removeFile=function(){this.setClick();delete this.file;this.html['list'].find('.placemark-list').empty();this.html['list'].find('.segment-list').empty();this.html['list'].find('.import-list').empty();this.setFile();};Map.prototype.clear=function(options){this.file.remove();};Map.prototype.isDirty=function(){if(this.file.dirty){return'Changes have not been saved.';}
return null;};Map.prototype.findLocation=function(){var address=this.html['find-dialog'].find('.find-words').val();if(address!==''){this.geocoder.geocode({'address':address},$.proxy(function(results,status){if(status===google.maps.GeocoderStatus.OK){this.html['find-dialog'].find('.find-list').html('');for(var i in results){var lat=results[i].geometry.location.lat();var lng=results[i].geometry.location.lng();this.html['find-dialog'].find('.find-list').append($('<li>').append($('<a>').addClass('find-item').attr({'href':"#",'lat':lat,'lng':lng}).html(results[i].formatted_address)));}
this.googlemap.setCenter(results[0].geometry.location);this.searchmarker.setPosition(results[0].geometry.location);this.searchmarker.setTitle(results[0].formatted_address);this.searchmarker.setVisible(true);this.html['find-dialog'].find('.find-item').on('click',null,{map:this},function(ev){var lat=parseFloat($(this).attr('lat'));var lng=parseFloat($(this).attr('lng'));var latlng=new google.maps.LatLng(lat,lng);ev.data.map.searchmarker.setPosition(latlng);ev.data.map.searchmarker.setTitle($(this).text());ev.data.map.searchmarker.setVisible(true);ev.data.map.googlemap.setCenter(latlng);});this.html['find-dialog'].on('mouseover','.find-item',{map:this},function(ev){var lat=parseFloat($(this).attr('lat'));var lng=parseFloat($(this).attr('lng'));var latlng=new google.maps.LatLng(lat,lng);ev.data.map.searchmarker.setPosition(latlng);ev.data.map.searchmarker.setTitle($(this).text());ev.data.map.searchmarker.setVisible(true);});}else{this.alert(status);}},this));}};Map.prototype.setMap=function(){if(this.googlemap===null){var mapTypeIds=[];for(var type in google.maps.MapTypeId){mapTypeIds.push(google.maps.MapTypeId[type]);}
mapTypeIds.push("OSM");mapTypeIds.push("OSMCYCLE");mapTypeIds.push("OSMPUBLIC");mapTypeIds.push("OSMLANDSCAPE");mapTypeIds.push("OSMOUTDOORS");var styles=[{featureType:'poi.business',stylers:[{visibility:'on'}]}];var map_options={backgroundColor:null,center:this.options.location,disableDefaultUI:false,disableDoubleClickZoom:false,draggable:true,draggingCursor:'auto',heading:0,keyboardShortcuts:true,mapMaker:false,mapTypeControl:true,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{mapTypeIds:mapTypeIds,position:google.maps.ControlPosition.TOP_RIGHT,style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},maxZoom:null,noClear:false,overviewMapControl:true,overviewMapControlOptions:{opened:false},panControl:false,panControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},rotateControl:false,rotateControlOptions:{position:google.maps.ControlPosition.BOTTOM_RIGHT},scaleControl:true,scaleControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER,style:'DEFAULT'},scrollwheel:true,streetViewControl:this.options.mode==='edit'?true:false,streetViewControlOptions:{position:google.maps.ControlPosition.TOP_LEFT},styles:styles,tilt:0,zoom:7,zoomControl:this.options.mode==='edit'?true:false,zoomControlOptions:{position:google.maps.ControlPosition.TOP_LEFT,style:google.maps.ZoomControlStyle.SMALL}};this.googlemap=new google.maps.Map(this.html['map-div'][0],map_options);this.googlemap.mapTypes.set("OSM",new google.maps.ImageMapType({getTileUrl:function(coord,zoom){return"http://tile.openstreetmap.org/"+zoom+"/"+coord.x+"/"+coord.y+".png";},tileSize:new google.maps.Size(256,256),name:'OSM-Street',maxZoom:18}));this.googlemap.mapTypes.set("OSMCYCLE",new google.maps.ImageMapType({getTileUrl:function(coord,zoom){return'http://tile.thunderforest.com/cycle/'+zoom+'/'+coord.x+'/'+coord.y+'.png';},tileSize:new google.maps.Size(256,256),name:'OSM-Cycle',maxZoom:18}));this.googlemap.mapTypes.set("OSMPUBLIC",new google.maps.ImageMapType({getTileUrl:function(coord,zoom){return'http://tile.thunderforest.com/transport/'+zoom+'/'+coord.x+'/'+coord.y+'.png';},tileSize:new google.maps.Size(256,256),name:'OSM-Public',maxZoom:18}));this.googlemap.mapTypes.set("OSMPUBLIC",new google.maps.ImageMapType({getTileUrl:function(coord,zoom){return'http://tile.thunderforest.com/transport/'+zoom+'/'+coord.x+'/'+coord.y+'.png';},tileSize:new google.maps.Size(256,256),name:'OSM-Public',maxZoom:18}));this.googlemap.mapTypes.set("OSMLANDSCAPE",new google.maps.ImageMapType({getTileUrl:function(coord,zoom){return'http://tile.thunderforest.com/landscape/'+zoom+'/'+coord.x+'/'+coord.y+'.png';},tileSize:new google.maps.Size(256,256),name:'OSM-Landscape',maxZoom:18}));this.googlemap.mapTypes.set("OSMOUTDOORS",new google.maps.ImageMapType({getTileUrl:function(coord,zoom){return'http://tile.thunderforest.com/outdoors/'+zoom+'/'+coord.x+'/'+coord.y+'.png';},tileSize:new google.maps.Size(256,256),name:'OSM-Outdoors',maxZoom:18}));this.bicycleLayer=new google.maps.BicyclingLayer(this.googlemap);this.bicycleLayer.setMap(null);this.directionsService=new google.maps.DirectionsService();this.geocoder=new google.maps.Geocoder();this.infowindow=new google.maps.InfoWindow({content:''});this.searchmarker=new google.maps.Marker({position:this.options.location,map:this.googlemap,visible:false,title:'search marker',icon:this.imageRedMarker});google.maps.event.addListener(this.searchmarker,'click',function(event){this.setVisible(false);});google.maps.event.addListener(this.googlemap,"click",$.proxy(function(event){this.click(event);},this));google.maps.event.addListener(this.googlemap,"rightclick",$.proxy(function(event){this.setClick();},this));google.maps.event.addListener(this.googlemap,"mousemove",$.proxy(function(event){this.showPend(event.latLng)},this));return this.googlemap;}};Map.prototype.showPend=function(latlng){var pend_info=this.html['map'].find('.pend-info');pend_info.addClass('hide');var target=this.getClick();var ppend=this.file.pend;if(target.sid){ppend=this.file.segments[target.sid].pend;}
this.html['ibs-footer'].find('.ibs-message').text('right click cancels action');switch(ppend){case'placemark':pend_info.text('Set marker');this.html['list'].find('.placemark-list-name').removeClass('img-marker').addClass('img-marker-hot');break;case'segment':pend_info.text('Start route');this.html['list'].find('.segment-list-name').removeClass('img-line').addClass('img-line-hot');break;case'sort':pend_info.text('Set sort origin');break;case'extend':pend_info.text('Extend route');break;default:this.html['list'].find('.placemark-list-name').removeClass('img-marker-hot').addClass('img-marker');this.html['list'].find('.segment-list-name').removeClass('img-line-hot').addClass('img-line');this.html['ibs-footer'].find('.ibs-message').text('');return;}
this.setMenuXY(pend_info,latlng);var top=parseInt(pend_info.css('top').replace(/px/,''));top=top-50;pend_info.css('top',top+'px');pend_info.removeClass('hide');}
Map.prototype.reset=function(){this.setClick();spin(false);for(var sid in this.file.segments){this.file.segments[sid].stopEditing();this.file.segments[sid].cuesheetKill();}
this.elevationSegment=null;this.sizeHtml();};Map.prototype.stats=function(list,distance,segments,placemarks){var pm=padLeftStr(placemarks.toString(),3,' ')+' placemarks.';var sm=padLeftStr(segments.toString(),3,' ')+' segments.';$(list).html('').append($('<div>').addClass('stats').append($('<img>').attr('src',this.siteUrl()+'image/gears.png')).append($('<span>').html(this.convertMeters2(distance)+this.measure2()))).append($('<div>').addClass('stats').addClass(segments?'':'hide').append($('<img>').attr('src',this.siteUrl()+'image/line.png')).append($('<span>').html(sm))).append($('<div>').addClass('stats').addClass(placemarks?'':'hide').append($('<img>').attr('src',this.siteUrl()+'image/marker.png')).append($('<span>').html(pm)));}
Map.prototype.alert=function(message){var dd=jQuery('<div>').attr({'id':'alert-dialog','title':'Alert'}).css({'background-color':'Tomato','color':'white'}).append(jQuery('<p>').append(jQuery('<img>').attr('src',this.siteUrl()+'image/alert-white.png').css({'float':'left','margin-right':'5px'})).append(jQuery('<span>').html(message)));jQuery(dd).dialog({autoOpen:true,modal:true,buttons:{Ok:function(){jQuery(this).dialog("close");}},close:function(){jQuery(this).dialog('destroy');}});};Map.prototype.confirm=function(message,callback){var dd=jQuery('<div>').attr({'id':'alert-dialog','title':'Confirm'}).css({'background-color':'Tomato','color':'white'}).append(jQuery('<p>').append(jQuery('<img>').attr('src',this.siteUrl()+'image/alert-white.png').css({'float':'left','margin-right':'5px'})).append(jQuery('<span>').html(message)));jQuery(dd).dialog({autoOpen:true,modal:true,buttons:{Ok:function(){jQuery(this).dialog("close");callback(true);},Cancel:function(){jQuery(this).dialog("close");callback(false);}},close:function(){jQuery(this).dialog('destroy');}});}
Map.prototype.prompt=function(message,callback){var dd=jQuery('<div>').attr({'id':'alert-dialog','title':'Alert'}).css({'background-color':'AliceBlue','color':'blue'}).append(jQuery('<p>').append(jQuery('<img>').attr('src',this.siteUrl()+'image/question.png').css({'float':'left','margin-right':'5px'})).append(jQuery('<span>').css({'float':'left','margin-right':'5px'}).html(message)).append(jQuery('<input>').attr({'id':'answer','type':'text','size':'30','value':''})));jQuery(dd).dialog({autoOpen:true,modal:true,buttons:{Ok:function(){jQuery(this).dialog("close");if(typeof callback==='function'){callback(jQuery(dd).find('#answer').val());}},Cancel:function(){jQuery(this).dialog("close");if(typeof callback==='function'){callback(null);}},},close:function(){jQuery(this).dialog('destroy');}});}
Map.prototype.notice=function(message){var dd=jQuery('<div>').attr({'id':'notice-dialog','title':'Notice'}).css({'background-color':'AliceBlue','color':'blue'}).append(jQuery('<p>').append(jQuery('<img>').attr('src',this.siteUrl()+'image/notice.png').css({'float':'left','margin-right':'5px'})).append(jQuery('<span>').html(message)));jQuery(dd).dialog({autoOpen:true,modal:false,show:{effect:"blind",duration:1000},hide:{effect:"blind",duration:1000},open:function(){var noticeInterval=setInterval(function(){jQuery(dd).dialog('close');clearInterval(noticeInterval);},2500);},close:function(){jQuery(this).dialog('destroy');}});}})(jQuery);
function MarkerClusterer(map,opt_markers,opt_options){this.extend(MarkerClusterer,google.maps.OverlayView);this.map_=map;this.markers_=[];this.clusters_=[];this.sizes=[53,56,66,78,90];this.styles_=[];this.ready_=false;var options=opt_options||{};this.gridSize_=options['gridSize']||60;this.minClusterSize_=options['minimumClusterSize']||2;this.maxZoom_=options['maxZoom']||null;this.styles_=options['styles']||[];this.imagePath_=options['imagePath']||this.MARKER_CLUSTER_IMAGE_PATH_;this.imageExtension_=options['imageExtension']||this.MARKER_CLUSTER_IMAGE_EXTENSION_;this.zoomOnClick_=true;if(options['zoomOnClick']!=undefined){this.zoomOnClick_=options['zoomOnClick'];}
this.averageCenter_=false;if(options['averageCenter']!=undefined){this.averageCenter_=options['averageCenter'];}
this.setupStyles_();this.setMap(map);this.prevZoom_=this.map_.getZoom();var that=this;google.maps.event.addListener(this.map_,'zoom_changed',function(){var zoom=that.map_.getZoom();var minZoom=that.map_.minZoom||0;var maxZoom=Math.min(that.map_.maxZoom||100,that.map_.mapTypes[that.map_.getMapTypeId()].maxZoom);zoom=Math.min(Math.max(zoom,minZoom),maxZoom);if(that.prevZoom_!=zoom){that.prevZoom_=zoom;that.resetViewport();}});google.maps.event.addListener(this.map_,'idle',function(){that.redraw();});if(opt_markers&&(opt_markers.length||Object.keys(opt_markers).length)){this.addMarkers(opt_markers,false);}}
MarkerClusterer.prototype.MARKER_CLUSTER_IMAGE_PATH_='http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/'+'images/m';MarkerClusterer.prototype.MARKER_CLUSTER_IMAGE_EXTENSION_='png';MarkerClusterer.prototype.extend=function(obj1,obj2){return(function(object){for(var property in object.prototype){this.prototype[property]=object.prototype[property];}
return this;}).apply(obj1,[obj2]);};MarkerClusterer.prototype.onAdd=function(){this.setReady_(true);};MarkerClusterer.prototype.draw=function(){};MarkerClusterer.prototype.setupStyles_=function(){if(this.styles_.length){return;}
for(var i=0,size;size=this.sizes[i];i++){this.styles_.push({url:this.imagePath_+(i+1)+'.'+this.imageExtension_,height:size,width:size});}};MarkerClusterer.prototype.fitMapToMarkers=function(){var markers=this.getMarkers();var bounds=new google.maps.LatLngBounds();for(var i=0,marker;marker=markers[i];i++){bounds.extend(marker.getPosition());}
this.map_.fitBounds(bounds);};MarkerClusterer.prototype.setStyles=function(styles){this.styles_=styles;};MarkerClusterer.prototype.getStyles=function(){return this.styles_;};MarkerClusterer.prototype.isZoomOnClick=function(){return this.zoomOnClick_;};MarkerClusterer.prototype.isAverageCenter=function(){return this.averageCenter_;};MarkerClusterer.prototype.getMarkers=function(){return this.markers_;};MarkerClusterer.prototype.getTotalMarkers=function(){return this.markers_.length;};MarkerClusterer.prototype.setMaxZoom=function(maxZoom){this.maxZoom_=maxZoom;};MarkerClusterer.prototype.getMaxZoom=function(){return this.maxZoom_;};MarkerClusterer.prototype.calculator_=function(markers,numStyles){var index=0;var count=markers.length;var dv=count;while(dv!==0){dv=parseInt(dv/10,10);index++;}
index=Math.min(index,numStyles);return{text:count,index:index};};MarkerClusterer.prototype.setCalculator=function(calculator){this.calculator_=calculator;};MarkerClusterer.prototype.getCalculator=function(){return this.calculator_;};MarkerClusterer.prototype.addMarkers=function(markers,opt_nodraw){if(markers.length){for(var i=0,marker;marker=markers[i];i++){this.pushMarkerTo_(marker);}}else if(Object.keys(markers).length){for(var marker in markers){this.pushMarkerTo_(markers[marker]);}}
if(!opt_nodraw){this.redraw();}};MarkerClusterer.prototype.pushMarkerTo_=function(marker){marker.isAdded=false;if(marker['draggable']){var that=this;google.maps.event.addListener(marker,'dragend',function(){marker.isAdded=false;that.repaint();});}
this.markers_.push(marker);};MarkerClusterer.prototype.addMarker=function(marker,opt_nodraw){this.pushMarkerTo_(marker);if(!opt_nodraw){this.redraw();}};MarkerClusterer.prototype.removeMarker_=function(marker){var index=-1;if(this.markers_.indexOf){index=this.markers_.indexOf(marker);}else{for(var i=0,m;m=this.markers_[i];i++){if(m==marker){index=i;break;}}}
if(index==-1){return false;}
marker.setMap(null);this.markers_.splice(index,1);return true;};MarkerClusterer.prototype.removeMarker=function(marker,opt_nodraw){var removed=this.removeMarker_(marker);if(!opt_nodraw&&removed){this.resetViewport();this.redraw();return true;}else{return false;}};MarkerClusterer.prototype.removeMarkers=function(markers,opt_nodraw){var removed=false;for(var i=0,marker;marker=markers[i];i++){var r=this.removeMarker_(marker);removed=removed||r;}
if(!opt_nodraw&&removed){this.resetViewport();this.redraw();return true;}};MarkerClusterer.prototype.setReady_=function(ready){if(!this.ready_){this.ready_=ready;this.createClusters_();}};MarkerClusterer.prototype.getTotalClusters=function(){return this.clusters_.length;};MarkerClusterer.prototype.getMap=function(){return this.map_;};MarkerClusterer.prototype.setMap=function(map){this.map_=map;};MarkerClusterer.prototype.getGridSize=function(){return this.gridSize_;};MarkerClusterer.prototype.setGridSize=function(size){this.gridSize_=size;};MarkerClusterer.prototype.getMinClusterSize=function(){return this.minClusterSize_;};MarkerClusterer.prototype.setMinClusterSize=function(size){this.minClusterSize_=size;};MarkerClusterer.prototype.getExtendedBounds=function(bounds){var projection=this.getProjection();var tr=new google.maps.LatLng(bounds.getNorthEast().lat(),bounds.getNorthEast().lng());var bl=new google.maps.LatLng(bounds.getSouthWest().lat(),bounds.getSouthWest().lng());var trPix=projection.fromLatLngToDivPixel(tr);trPix.x+=this.gridSize_;trPix.y-=this.gridSize_;var blPix=projection.fromLatLngToDivPixel(bl);blPix.x-=this.gridSize_;blPix.y+=this.gridSize_;var ne=projection.fromDivPixelToLatLng(trPix);var sw=projection.fromDivPixelToLatLng(blPix);bounds.extend(ne);bounds.extend(sw);return bounds;};MarkerClusterer.prototype.isMarkerInBounds_=function(marker,bounds){return bounds.contains(marker.getPosition());};MarkerClusterer.prototype.clearMarkers=function(){this.resetViewport(true);this.markers_=[];};MarkerClusterer.prototype.resetViewport=function(opt_hide){for(var i=0,cluster;cluster=this.clusters_[i];i++){cluster.remove();}
for(var i=0,marker;marker=this.markers_[i];i++){marker.isAdded=false;if(opt_hide){marker.setMap(null);}}
this.clusters_=[];};MarkerClusterer.prototype.repaint=function(){var oldClusters=this.clusters_.slice();this.clusters_.length=0;this.resetViewport();this.redraw();window.setTimeout(function(){for(var i=0,cluster;cluster=oldClusters[i];i++){cluster.remove();}},0);};MarkerClusterer.prototype.redraw=function(){this.createClusters_();};MarkerClusterer.prototype.distanceBetweenPoints_=function(p1,p2){if(!p1||!p2){return 0;}
var R=6371;var dLat=(p2.lat()-p1.lat())*Math.PI/180;var dLon=(p2.lng()-p1.lng())*Math.PI/180;var a=Math.sin(dLat/2)*Math.sin(dLat/2)+
Math.cos(p1.lat()*Math.PI/180)*Math.cos(p2.lat()*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var d=R*c;return d;};MarkerClusterer.prototype.addToClosestCluster_=function(marker){var distance=40000;var clusterToAddTo=null;var pos=marker.getPosition();for(var i=0,cluster;cluster=this.clusters_[i];i++){var center=cluster.getCenter();if(center){var d=this.distanceBetweenPoints_(center,marker.getPosition());if(d<distance){distance=d;clusterToAddTo=cluster;}}}
if(clusterToAddTo&&clusterToAddTo.isMarkerInClusterBounds(marker)){clusterToAddTo.addMarker(marker);}else{var cluster=new Cluster(this);cluster.addMarker(marker);this.clusters_.push(cluster);}};MarkerClusterer.prototype.createClusters_=function(){if(!this.ready_){return;}
var mapBounds=new google.maps.LatLngBounds(this.map_.getBounds().getSouthWest(),this.map_.getBounds().getNorthEast());var bounds=this.getExtendedBounds(mapBounds);for(var i=0,marker;marker=this.markers_[i];i++){if(!marker.isAdded&&this.isMarkerInBounds_(marker,bounds)){this.addToClosestCluster_(marker);}}};function Cluster(markerClusterer){this.markerClusterer_=markerClusterer;this.map_=markerClusterer.getMap();this.gridSize_=markerClusterer.getGridSize();this.minClusterSize_=markerClusterer.getMinClusterSize();this.averageCenter_=markerClusterer.isAverageCenter();this.center_=null;this.markers_=[];this.bounds_=null;this.clusterIcon_=new ClusterIcon(this,markerClusterer.getStyles(),markerClusterer.getGridSize());}
Cluster.prototype.isMarkerAlreadyAdded=function(marker){if(this.markers_.indexOf){return this.markers_.indexOf(marker)!=-1;}else{for(var i=0,m;m=this.markers_[i];i++){if(m==marker){return true;}}}
return false;};Cluster.prototype.addMarker=function(marker){if(this.isMarkerAlreadyAdded(marker)){return false;}
if(!this.center_){this.center_=marker.getPosition();this.calculateBounds_();}else{if(this.averageCenter_){var l=this.markers_.length+1;var lat=(this.center_.lat()*(l-1)+marker.getPosition().lat())/l;var lng=(this.center_.lng()*(l-1)+marker.getPosition().lng())/l;this.center_=new google.maps.LatLng(lat,lng);this.calculateBounds_();}}
marker.isAdded=true;this.markers_.push(marker);var len=this.markers_.length;if(len<this.minClusterSize_&&marker.getMap()!=this.map_){marker.setMap(this.map_);}
if(len==this.minClusterSize_){for(var i=0;i<len;i++){this.markers_[i].setMap(null);}}
if(len>=this.minClusterSize_){marker.setMap(null);}
this.updateIcon();return true;};Cluster.prototype.getMarkerClusterer=function(){return this.markerClusterer_;};Cluster.prototype.getBounds=function(){var bounds=new google.maps.LatLngBounds(this.center_,this.center_);var markers=this.getMarkers();for(var i=0,marker;marker=markers[i];i++){bounds.extend(marker.getPosition());}
return bounds;};Cluster.prototype.remove=function(){this.clusterIcon_.remove();this.markers_.length=0;delete this.markers_;};Cluster.prototype.getSize=function(){return this.markers_.length;};Cluster.prototype.getMarkers=function(){return this.markers_;};Cluster.prototype.getCenter=function(){return this.center_;};Cluster.prototype.calculateBounds_=function(){var bounds=new google.maps.LatLngBounds(this.center_,this.center_);this.bounds_=this.markerClusterer_.getExtendedBounds(bounds);};Cluster.prototype.isMarkerInClusterBounds=function(marker){return this.bounds_.contains(marker.getPosition());};Cluster.prototype.getMap=function(){return this.map_;};Cluster.prototype.updateIcon=function(){var zoom=this.map_.getZoom();var mz=this.markerClusterer_.getMaxZoom();if(mz&&zoom>mz){for(var i=0,marker;marker=this.markers_[i];i++){marker.setMap(this.map_);}
return;}
if(this.markers_.length<this.minClusterSize_){this.clusterIcon_.hide();return;}
var numStyles=this.markerClusterer_.getStyles().length;var sums=this.markerClusterer_.getCalculator()(this.markers_,numStyles);this.clusterIcon_.setCenter(this.center_);this.clusterIcon_.setSums(sums);this.clusterIcon_.show();};function ClusterIcon(cluster,styles,opt_padding){cluster.getMarkerClusterer().extend(ClusterIcon,google.maps.OverlayView);this.styles_=styles;this.padding_=opt_padding||0;this.cluster_=cluster;this.center_=null;this.map_=cluster.getMap();this.div_=null;this.sums_=null;this.visible_=false;this.setMap(this.map_);}
ClusterIcon.prototype.triggerClusterClick=function(){var markerClusterer=this.cluster_.getMarkerClusterer();google.maps.event.trigger(markerClusterer,'clusterclick',this.cluster_);if(markerClusterer.isZoomOnClick()){this.map_.fitBounds(this.cluster_.getBounds());}};ClusterIcon.prototype.onAdd=function(){this.div_=document.createElement('DIV');if(this.visible_){var pos=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(pos);this.div_.innerHTML=this.sums_.text;}
var panes=this.getPanes();panes.overlayMouseTarget.appendChild(this.div_);var that=this;google.maps.event.addDomListener(this.div_,'click',function(){that.triggerClusterClick();});};ClusterIcon.prototype.getPosFromLatLng_=function(latlng){var pos=this.getProjection().fromLatLngToDivPixel(latlng);pos.x-=parseInt(this.width_/2,10);pos.y-=parseInt(this.height_/2,10);return pos;};ClusterIcon.prototype.draw=function(){if(this.visible_){var pos=this.getPosFromLatLng_(this.center_);this.div_.style.top=pos.y+'px';this.div_.style.left=pos.x+'px';}};ClusterIcon.prototype.hide=function(){if(this.div_){this.div_.style.display='none';}
this.visible_=false;};ClusterIcon.prototype.show=function(){if(this.div_){var pos=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(pos);this.div_.style.display='';}
this.visible_=true;};ClusterIcon.prototype.remove=function(){this.setMap(null);};ClusterIcon.prototype.onRemove=function(){if(this.div_&&this.div_.parentNode){this.hide();this.div_.parentNode.removeChild(this.div_);this.div_=null;}};ClusterIcon.prototype.setSums=function(sums){this.sums_=sums;this.text_=sums.text;this.index_=sums.index;if(this.div_){this.div_.innerHTML=sums.text;}
this.useStyle();};ClusterIcon.prototype.useStyle=function(){var index=Math.max(0,this.sums_.index-1);index=Math.min(this.styles_.length-1,index);var style=this.styles_[index];this.url_=style['url'];this.height_=style['height'];this.width_=style['width'];this.textColor_=style['textColor'];this.anchor_=style['anchor'];this.textSize_=style['textSize'];this.backgroundPosition_=style['backgroundPosition'];};ClusterIcon.prototype.setCenter=function(center){this.center_=center;};ClusterIcon.prototype.createCss=function(pos){var style=[];style.push('background-image:url('+this.url_+');');var backgroundPosition=this.backgroundPosition_?this.backgroundPosition_:'0 0';style.push('background-position:'+backgroundPosition+';');if(typeof this.anchor_==='object'){if(typeof this.anchor_[0]==='number'&&this.anchor_[0]>0&&this.anchor_[0]<this.height_){style.push('height:'+(this.height_-this.anchor_[0])+'px; padding-top:'+this.anchor_[0]+'px;');}else{style.push('height:'+this.height_+'px; line-height:'+this.height_+'px;');}
if(typeof this.anchor_[1]==='number'&&this.anchor_[1]>0&&this.anchor_[1]<this.width_){style.push('width:'+(this.width_-this.anchor_[1])+'px; padding-left:'+this.anchor_[1]+'px;');}else{style.push('width:'+this.width_+'px; text-align:center;');}}else{style.push('height:'+this.height_+'px; line-height:'+
this.height_+'px; width:'+this.width_+'px; text-align:center;');}
var txtColor=this.textColor_?this.textColor_:'black';var txtSize=this.textSize_?this.textSize_:11;style.push('cursor:pointer; top:'+pos.y+'px; left:'+
pos.x+'px; color:'+txtColor+'; position:absolute; font-size:'+
txtSize+'px; font-family:Arial,sans-serif; font-weight:bold');return style.join('');};
function Placemark(arg){this.init(arg);}
(function($){Placemark.prototype.init=function(arg){this.options={map:null,file:null,pid:'P1001',name:null,desc:null,url:null,symbol:null,position:null,visible:true};for(attr in arg){this.options[attr]=arg[attr];}
if(this.options.name===null)
this.options.name=this.options.pid;if(this.options.desc===null)
this.options.desc=this.options.pid;this.placemarkList=this.options.file.placemarkList;this.placemarkItem='.placemark-item-name[rel="'+this.options.pid+'"]';this.marker=new google.maps.Marker({position:this.options.position,map:this.options.map.googlemap,title:this.options.name,draggable:true,placemark:this,visible:this.options.visible});this.setName=function(name){this.options.name=name;this.marker.setTitle(name);this.placemarkList.find(this.placemarkItem).text(name);};this.setIcon=function(){this.marker.setMap(null);if(/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(this.options.url)){this.options.symbol=this.options.map.getSymbol(this.options.url);}else{this.options.url=this.options.map.getUrlFromSymbol(this.options.symbol);}
this.marker.setIcon(this.options.map.getIcon(this.options.url));this.marker.setMap(this.options.map.googlemap);this.placemarkList.find('.placemark-item-image[pid='+this.options.pid+']').attr('src',this.marker.icon.url);};this.setIcon();google.maps.event.addListener(this.marker,'click',$.proxy(function(event){$(this.placemarkItem).trigger('click');},this));google.maps.event.addListener(this.marker,'dragend',$.proxy(function(event){this.options.position=this.marker.getPosition();},this));this.setPlacemarkItem();}
Placemark.prototype.setOptions=function(options){for(var attr in options){this.options[attr]=options[attr];}};Placemark.prototype.copy=function(){var copy={};for(var attr in this.options){copy[attr]=this.options[attr]}
copy.position=this.marker.getPosition();copy.url=this.marker.icon.url;return copy;};Placemark.prototype.remove=function(){this.marker.unbind();this.marker.setMap(null);this.options.file.removePlacemark(this.options.pid);};Placemark.prototype.open=function(){this.options.file.openInfo(this);};Placemark.prototype.edit=function(){this.placemarkDialog();}})(jQuery);
(function(factory){if(typeof define==='function'&&define.amd){define(factory);}else{window.purl=factory();}})(function(){var tag2attr={a:'href',img:'src',form:'action',base:'href',script:'src',iframe:'src',link:'href',embed:'src',object:'data'},key=['source','protocol','authority','userInfo','user','password','host','port','relative','path','directory','file','query','fragment'],aliases={'anchor':'fragment'},parser={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},isint=/^[0-9]+$/;function parseUri(url,strictMode){var str=decodeURI(url),res=parser[strictMode||false?'strict':'loose'].exec(str),uri={attr:{},param:{},seg:{}},i=14;while(i--){uri.attr[key[i]]=res[i]||'';}
uri.param['query']=parseString(uri.attr['query']);uri.param['fragment']=parseString(uri.attr['fragment']);uri.seg['path']=uri.attr.path.replace(/^\/+|\/+$/g,'').split('/');uri.seg['fragment']=uri.attr.fragment.replace(/^\/+|\/+$/g,'').split('/');uri.attr['base']=uri.attr.host?(uri.attr.protocol?uri.attr.protocol+'://'+uri.attr.host:uri.attr.host)+(uri.attr.port?':'+uri.attr.port:''):'';return uri;}
function getAttrName(elm){var tn=elm.tagName;if(typeof tn!=='undefined')
return tag2attr[tn.toLowerCase()];return tn;}
function promote(parent,key){if(parent[key].length===0)
return parent[key]={};var t={};for(var i in parent[key])
t[i]=parent[key][i];parent[key]=t;return t;}
function parse(parts,parent,key,val){var part=parts.shift();if(!part){if(isArray(parent[key])){parent[key].push(val);}else if('object'==typeof parent[key]){parent[key]=val;}else if('undefined'==typeof parent[key]){parent[key]=val;}else{parent[key]=[parent[key],val];}}else{var obj=parent[key]=parent[key]||[];if(']'==part){if(isArray(obj)){if(''!==val)
obj.push(val);}else if('object'==typeof obj){obj[keys(obj).length]=val;}else{obj=parent[key]=[parent[key],val];}}else if(~part.indexOf(']')){part=part.substr(0,part.length-1);if(!isint.test(part)&&isArray(obj))
obj=promote(parent,key);parse(parts,obj,part,val);}else{if(!isint.test(part)&&isArray(obj))
obj=promote(parent,key);parse(parts,obj,part,val);}}}
function merge(parent,key,val){if(~key.indexOf(']')){var parts=key.split('[');parse(parts,parent,'base',val);}else{if(!isint.test(key)&&isArray(parent.base)){var t={};for(var k in parent.base)
t[k]=parent.base[k];parent.base=t;}
if(key!==''){set(parent.base,key,val);}}
return parent;}
function parseString(str){return reduce(String(str).split(/&|;/),function(ret,pair){try{pair=decodeURIComponent(pair.replace(/\+/g,' '));}catch(e){}
var eql=pair.indexOf('='),brace=lastBraceInKey(pair),key=pair.substr(0,brace||eql),val=pair.substr(brace||eql,pair.length);val=val.substr(val.indexOf('=')+1,val.length);if(key===''){key=pair;val='';}
return merge(ret,key,val);},{base:{}}).base;}
function set(obj,key,val){var v=obj[key];if(typeof v==='undefined'){obj[key]=val;}else if(isArray(v)){v.push(val);}else{obj[key]=[v,val];}}
function lastBraceInKey(str){var len=str.length,brace,c;for(var i=0;i<len;++i){c=str[i];if(']'==c)
brace=false;if('['==c)
brace=true;if('='==c&&!brace)
return i;}}
function reduce(obj,accumulator){var i=0,l=obj.length>>0,curr=arguments[2];while(i<l){if(i in obj)
curr=accumulator.call(undefined,curr,obj[i],i,obj);++i;}
return curr;}
function isArray(vArg){return Object.prototype.toString.call(vArg)==="[object Array]";}
function keys(obj){var key_array=[];for(var prop in obj){if(obj.hasOwnProperty(prop))
key_array.push(prop);}
return key_array;}
function purl(url,strictMode){if(arguments.length===1&&url===true){strictMode=true;url=undefined;}
strictMode=strictMode||false;url=url||window.location.toString();return{data:parseUri(url,strictMode),attr:function(attr){attr=aliases[attr]||attr;return typeof attr!=='undefined'?this.data.attr[attr]:this.data.attr;},param:function(param){return typeof param!=='undefined'?this.data.param.query[param]:this.data.param.query;},fparam:function(param){return typeof param!=='undefined'?this.data.param.fragment[param]:this.data.param.fragment;},segment:function(seg){if(typeof seg==='undefined'){return this.data.seg.path;}else{seg=seg<0?this.data.seg.path.length+seg:seg-1;return this.data.seg.path[seg];}},fsegment:function(seg){if(typeof seg==='undefined'){return this.data.seg.fragment;}else{seg=seg<0?this.data.seg.fragment.length+seg:seg-1;return this.data.seg.fragment[seg];}}};}
purl.jQuery=function($){if($!=null){$.fn.url=function(strictMode){var url='';if(this.length){url=$(this).attr(getAttrName(this[0]))||'';}
return purl(url,strictMode);};$.url=purl;}};purl.jQuery(window.jQuery);return purl;});
function Segment(arg){this.init(arg);}
(function($){Segment.prototype.init=function(arg){this.options={map:null,sid:'S1001',path:[],strokeColor:'#000fff',strokeOpacity:0.35,strokeWeight:5,name:null,desc:null};for(var attr in arg){this.options[attr]=arg[attr];}
if(this.options.name===null)
this.options.name=this.options.sid;if(this.options.desc===null)
this.options.desc=this.options.sid;this.setMethods();this.segmentList=this.options.map.file.segmentList;this.segmentItem='.segment-item-name[rel="'+this.options.sid+'"]';this.setSegmentItem();this.selected=false;this.line=new google.maps.Polyline(this.lineOptions());this.line.setMap(this.options.map.googlemap);this.line.segment=this;this.undoStack=[];this.points=[];this.markerManager=null;this.editing=false;this.isActive=true;this.marker=new google.maps.Marker({position:this.options.path[0],map:this.options.map.googlemap,title:this.options.name,icon:this.options.map.imageLineNormal,segment:this});this.distanceMarker=new google.maps.Marker({position:this.options.path[0],map:this.options.map.googlemap,visible:false,icon:this.options.map.imageDistancePointer});google.maps.event.addListener(this.marker,'click',$.proxy(function(event){if(this.isActive){$(this.segmentItem).trigger('click');}},this));this.directionsRenderer=null;this.directionsService=null;this.refresh();google.maps.event.addListener(this.line,'mouseover',$.proxy(function(event){var distance_info=this.options.map.html['distance-info'];if(!this.editing&&this.isActive&&this.options.map.options.distance){if(distance_info.hasClass('hide')){var nearest=this.nearestPoint(event.latLng);var d=nearest.distance;var distance=this.options.map.convertMeters2(d)+this.options.map.measure2();this.distanceMarker.setPosition(nearest.latLng);this.distanceMarker.index=nearest.index;this.distanceMarker.setVisible(true);this.distanceMarker.setTitle('');distance_info.text(distance);this.options.map.setMenuXY(distance_info,event.latLng);var top=parseInt(distance_info.css('top').replace(/px/,''));top=top-35;distance_info.css('top',top+'px');distance_info.removeClass('hide');}}},this));google.maps.event.addListener(this.line,'mouseout',$.proxy(function(event){var distance_info=this.options.map.html['distance-info'];if(this.isActive){var iid=setInterval($.proxy(function(){clearInterval(iid);distance_info.addClass('hide');this.distanceMarker.setVisible(false);},this),1000)}},this));google.maps.event.addListener(this.marker,'mouseover',$.proxy(function(event){if(this.isActive)
this.line.setOptions({strokeWeight:this.options.strokeWeight+4});},this));google.maps.event.addListener(this.marker,'mouseout',$.proxy(function(event){if(this.isActive){this.line.setOptions({strokeWeight:this.options.strokeWeight});}},this));google.maps.event.addListener(this.marker,'rightclick',$.proxy(function(event){if(this.isActive){this.options.map.setClick();}},this));google.maps.event.addListener(this.line,"click",$.proxy(function(event){if(this.isActive){var nearest=this.nearestPoint(event.latLng);this.distanceMarker.setPosition(nearest.latLng);if(this.options.map.options.mode=='edit'){this.contextMenuLine(nearest);}else{$(this.segmentItem).trigger('click');}}},this));}
Segment.prototype.setOptions=function(options){for(var attr in options){this.options[attr]=options[attr];}};Segment.prototype.setMethods=function(){this.pend=null;this.click=function(event){switch(this.pend){case'extend':this.addPoint(event.latLng);if(false===$(this.segmentItem).hasClass('selected')){this.options.file.selectSegment($(this.segmentItem)[0]);}
this.options.map.setClick({sid:this.options.sid});break;}};this.extend=function(){this.options.map.setClick({sid:this.options.sid,pid:null});this.pend='extend';};this.lineOptions=function(){return{'path':this.options.path,'strokeWeight':this.options.strokeWeight,'strokeColor':this.options.strokeColor,'strokeOpacity':this.options.strokeOpacity};};};Segment.prototype.setSegmentItem=function(){var rel=this.options.sid;this.segmentList.append($('<li>').attr({'id':this.options.sid}).addClass("segment-item").append($('<div>').addClass("ct-list-div hide").append($('<a>').attr({'href':"#",'title':"focus segment"}).append($('<img>').addClass("segment-focus").attr({'rel':rel,'src':this.options.map.siteUrl()+'image/zoom.png'}))).append($('<a>').attr({'href':"#",'title':"elevation profile"}).append($('<img>').addClass("segment-elevation").attr({'rel':rel,'src':this.options.map.siteUrl()+'image/chart.png'}))).append($('<span>').append($('<a>').attr({'href':"#",'title':"generate cue sheet"}).append($('<img>').addClass("segment-cuesheet").attr({'rel':rel,'src':this.options.map.siteUrl()+'image/cue.png'}).data({segment:this}))))).append($('<a>').addClass('segment-item-name').attr({'rel':rel,'href':"#",'title':""}).text(this.options.name)));};Segment.prototype.copy=function(){var result={};for(var attr in this.options){if(attr!=='path'){result[attr]=this.options[attr];}}
result.latlngs=[];this.line.getPath().forEach(function(latlng){result.latlngs.push({lat:latlng.lat(0),lng:latlng.lng()});});result.sid=this.options.sid;return result;};Segment.prototype.distanceTo=function(marker){var d=0;var target=marker.getPosition();var previous=this.points[0].getPosition();if(previous.equals(target)){return 0.0;}
for(var i=1;i<this.points.length;i++){var current=this.points[i].getPosition();d+=distanceFrom(previous,current);previous=current;if(target.equals(current)){break;}}
return(d);};Segment.prototype.nearestPoint=function(latlng){var d=0;var dd=null;var nearest=null;var index=0;var total=0;var path=this.line.getPath();path.forEach($.proxy(function(p,i){d=distanceFrom(p,latlng);if(dd===null||d<dd){nearest=p;index=i;dd=d;}},this));var previous=null;var current=null;for(var i=0;i<path.getLength();i++){current=path.getAt(i);if(i>0){total+=distanceFrom(previous,current);}
previous=current;if(current.equals(nearest)){total+=dd;break;}}
return{latLng:nearest,index:index,distance:total};};Segment.prototype.distance=function(){return pathLength(this.line.getPath());};Segment.prototype.refresh=function(){var latlng=this.line.getPath().getAt(this.line.getPath().length-1);this.marker.setPosition(latlng);};Segment.prototype.remove=function(){this.stopEditing();this.line.setMap(null);this.marker.setMap(null);this.distanceMarker.setMap(null);this.removeWaypoints();this.options.map.html['list'].find('.segment-item[rel="'+this.options.sid+'"]').remove();this.options.map.file.removeSegment(this.options.sid);};Segment.prototype._midPoint=function(pointA,pointB){return new google.maps.LatLng(pointB.lat()-(0.5*(pointB.lat()-pointA.lat())),pointB.lng()-(0.5*(pointB.lng()-pointA.lng())));};Segment.prototype.midPoint=function(point,index){var path=this.line.getPath();var pointA=path.getAt(point.index-1);var pointB=path.getAt(point.index);var latlng=this._midPoint(pointA,pointB);var midpoint=new google.maps.Marker({position:latlng,map:this.options.map.googlemap,icon:this.options.map.imageNormalMidpoint,draggable:true,segment:this,index:index,point:point});google.maps.event.addListener(midpoint,"mouseover",function(){this.setIcon(this.segment.options.map.imageNormal);var d=this.segment.distanceTo(this.point)-distanceFrom(this.getPosition(),this.point.getPosition());this.title=this.segment.options.map.convertMeters2(Math.round(100*d)/100)+this.segment.options.map.measure2();});google.maps.event.addListener(midpoint,"mouseout",function(){this.setIcon(this.segment.options.map.imageNormalMidpoint);});google.maps.event.addListener(midpoint,"dragend",function(){var latlng=this.getPosition();var index=this.point.index;var path=this.segment.line.getPath();path.insertAt(index,latlng);var point=this.segment.point(latlng,index);this.segment.points.splice(index,0,point);for(var i in this.segment.points){this.segment.points[i].index=parseInt(i);}
var pointA=latlng;var pointB=this.point.getPosition();this.setPosition(this.segment._midPoint(pointA,pointB));});return midpoint;};Segment.prototype.point=function(latlng,index){var point=new google.maps.Marker({position:latlng,map:this.options.map.googlemap,icon:this.options.map.imageNormal,draggable:true,index:index,segment:this,midpoint:null});if(index>0){point.midpoint=this.midPoint(point,index);}else{point.midpoint=null;}
google.maps.event.addListener(point,"mouseover",function(event){this.setIcon(this.segment.options.map.imageHover);var d=this.segment.distanceTo(this);this.setTitle(this.segment.options.map.convertMeters2(Math.round(100*d)/100)+this.segment.options.map.measure2());});google.maps.event.addListener(point,"mouseout",function(){this.setIcon(this.segment.options.map.imageNormal);});google.maps.event.addListener(point,"drag",function(){var path=this.segment.line.getPath();path.setAt(this.index,this.getPosition());this.segment.refresh();});google.maps.event.addListener(point,"dragend",function(){var path=this.segment.line.getPath();path.setAt(this.index,this.getPosition());if(this.midpoint===null||this.index===0){var left=this.segment.points[1];}else{left=this;}
if(this.segment.points.length>=2){var pointA=path.getAt(left.index-1);var pointB=path.getAt(left.index);left.midpoint.setPosition(midPoint(pointA,pointB));var pos=parseInt(left.index)+1;if(pos<this.segment.points.length){var right=this.segment.points[pos];pointA=path.getAt(right.index-1);pointB=path.getAt(right.index);right.midpoint.setPosition(midPoint(pointA,pointB));}}
this.segment.refresh();});google.maps.event.addListener(point,"click",function(event){this.segment.contextMenuLineEdit(this.index);});return point;};Segment.prototype.followRoad=function(latlng){var segment=this;var request={avoidHighways:this.options.map.options.avoidhighways,origin:this.line.getPath().getAt(this.line.getPath().getLength()-1),destination:latlng,travelMode:google.maps.DirectionsTravelMode[this.options.map.options.travelmode]};this.options.map.directionsService.route(request,function(response,status){if(status===google.maps.DirectionsStatus.OK){for(var route in response.routes){for(latlng in response.routes[route].overview_path){segment.line.getPath().push(response.routes[route].overview_path[latlng]);}}}
segment.refresh();});};Segment.prototype.addPoint=function(latlng){this.save();this.stopEditing();if(this.options.map.options.followroad){this.followRoad(latlng);}else{this.line.getPath().push(latlng);}
this.refresh();this.options.file.setDirty(true);};Segment.prototype.rebuild=function(){var path=this.line.getPath();this.save();var j=path.getLength();var first=path.getAt(0);var last=path.getAt(j-1);this.stopEditing();this.line.setPath([first]);this.addPoint(last);this.undoStack.pop();this.options.map.infowindow.close();};Segment.prototype.waypoint=function(index){var path=this.line.getPath();if(index>=0&&path.getLength()){options={'waypoint':true,'position':path.getAt(index),'draggable':false,'symbol':'Waypoint','url':'','visible':true,'pid':null};this.options.map.file.addPlacemark(options);}};Segment.prototype.split=function(index){var options={path:[],strokeColor:this.line.strokeColor,strokeOpacity:this.line.strokeOpacity,strokeWeight:this.line.strokeWeight,name:this.options.name+'.',desc:this.options.desc};var path=this.line.getPath();if(index>0&&path.getLength()>1){this.stopEditing();while(index<=path.getLength()-1){options.path.push(path.getAt(index));path.removeAt(index);}
this.options.file.addSegment(options);this.refresh();this.options.file.setDirty(true);this.options.map.setClick(null);}};Segment.prototype.thin=function(){var path=this.line.getPath();this.save();var newline=[];var prev=null;path.forEach($.proxy(function(latlng,index){if(prev){var d=distanceFrom(prev,latlng);if(d>300.0){newline.push(latlng);prev=latlng;}}else{prev=latlng;}},this));var dropped=path.getLength();dropped-=newline.length;this.line.setPath(newline);this.options.map.notice('dropped '+dropped+' points.');this.options.map.file.setDirty(true);};Segment.prototype.save=function(){var savepath=[];var path=this.line.getPath();path.forEach(function(latlng,index){savepath.push(latlng);});this.undoStack.push(savepath);};Segment.prototype.undo=function(){if(this.undoStack.length){this.stopEditing();var path=this.undoStack.pop();this.line.setPath(path);this.refresh();}};Segment.prototype.flip=function(){var path=this.line.getPath();this.save();var newpath=[];for(var j=path.getLength();j>0;j--){newpath.push(path.pop());}
this.line.setPath(newpath);this.refresh();};Segment.prototype.getBounds=function(bounds){var path=this.line.getPath();path.forEach(function(point,index){bounds.extend(point);});};Segment.prototype.focus=function(){var bounds=new google.maps.LatLngBounds();this.getBounds(bounds);this.options.map.googlemap.fitBounds(bounds);};Segment.prototype.manageMarkers=function(){if(this.markerManager){this.markerManager.clearMarkers();}
this.marker_cluster=[];for(var i in this.points){this.marker_cluster.push(this.points[i]);if(this.points[i].midpoint){this.marker_cluster.push(this.points[i].midpoint);}}
this.markerManager=new MarkerClusterer(this.options.map.googlemap,this.marker_cluster,{gridSize:50});};Segment.prototype.stopEditing=function(){if(this.markerManager)
this.markerManager.clearMarkers();for(var i in this.points){this.points[i].setMap(null);if(this.points[i].midpoint!==null){this.points[i].midpoint.setMap(null);}}
this.points.length=0;this.editing=false;};Segment.prototype.lineEdit=function(){var segment=this;if(this.editing){this.stopEditing();}else{if(this.points.length===0){var path=this.line.getPath();path.forEach(function(point,index){var marker=segment.point(point,index);segment.points.push(marker);});this.manageMarkers();}else{for(var i in this.points){this.points[i].setVisible(true);if(this.points[i].midpoint!==null){this.points[i].midpoint.setVisible(true);}}}
this.editing=true;}};Segment.prototype.open=function(){this.options.map.file.openInfo(this);};Segment.prototype.contextMenuLine=function(point){var div=this.options.map.html['segment-cm-line'];div.find('.cm-line-action').data({segment:this,point:point.index});this.options.map.setMenuXY(div,point.latLng);div.removeClass('hide');};Segment.prototype.contextMenuLineEdit=function(index){var div=this.options.map.html['segment-cm-edit'];div.find('.cm-edit-action').data({'segment':this,'index':index});this.options.map.setMenuXY(div,this.line.getPath().getAt(index));div.removeClass('hide');};Segment.prototype.contextMenuMarker=function(latlng){var div=this.options.map.html['segment-cm-marker'];div.find('.cm-marker-action').data({segment:this});this.options.map.setMenuXY(div,latlng);div.removeClass('hide');};Segment.prototype.removePoint=function(index){if(this.points.length){var marker=this.points[index];var path=this.line.getPath();if(path.getLength()>1){this.save();marker.setMap(null);if(marker.midpoint!==null){marker.midpoint.setMap(null);}
path.removeAt(index);this.points.splice(index,1);for(var i in this.points){this.points[i].index=parseInt(i);}
if(index<this.points.length&&index>0){var pointA=this.points[index-1].getPosition();var pointB=this.points[index].getPosition();this.points[index].midmarker.setPosition(midPoint(pointA,pointB));}
this.refresh();this.parent.setDirty(true);}}};Segment.prototype.getDirRequestOptions=function(options){var opt={avoidHighways:false,avoidTolls:true,destination:null,durationInTraffic:false,optimizeWaypoints:true,origin:null,provideRouteAlternatives:false,region:null,transitOptions:{},travelMode:'BICYCLING',unitSystem:null,waypoints:null};for(var attr in options){opt[attr]=options[attr];}
return opt;};Segment.prototype.getDirRenderOptions=function(options){var opt={draggable:true,map:null,markerOptions:{},polylineOptions:{strokeColor:'#ff0000',strokeWeight:3,strokeOpacity:1.0},preserveViewport:false,suppressBicyclingLayer:false,suppressInfoWindows:true,suppressMarkers:false,suppressPolylines:false};for(var attr in options){opt[attr]=options[attr];}
return opt;};Segment.prototype.cuesheetKill=function(){this.options.map.html['list'].find('img.segment-cuesheet').attr({'src':this.options.map.siteUrl()+'image/cue.png'}).css({'visibility':'visible'});try{this.options.map.html['cuesheet-dialog'].dialog('close');}catch(err){if(err==='');}
if(this.directionsRenderer&&this.directionsRenderer.getMap()){this.directionsRenderer.setMap(null);}};Segment.prototype.metersToStr=function(meters,metric){if(meters<10){return{'d':metric?meters.toFixed(2):(meters*3.2808399).toFixed(2),'m':metric?'m':'ft',};}else{return{'d':metric?(meters/1000).toFixed(2):(meters/1609.344).toFixed(2),'m':metric?'km':'mi',};}}
Segment.prototype.cueLine=function(params){var step=this.metersToStr(params.step,params.metric);var acc=this.metersToStr(params.distance,params.metric);var lines=params.instructions.split('<div');if(lines.length>1){lines[1]=removeHtmlStr('<div'+lines[1]);lines[0]+=' - '+lines[1];params.instructions=lines[0];}
var table='<table>';var th='<tr><th>&nbsp;Step&nbsp;</th><th></th><th>&nbsp;Trip&nbsp;</th><th></th><th>Instructions</th></tr>';var row='<tr><td style="text-align:right; padding-right:5px;">&nbsp;'+step.d+'&nbsp;</td><td style="text-align:center;">&nbsp;'+step.m+'&nbsp;</td>'+'<td style="text-align:right; padding-right:5px;">&nbsp;'+acc.d+'&nbsp;</td><td style="text-align:center;">&nbsp;'+acc.m+'&nbsp;</td>'+'<td>&nbsp;%1&nbsp;</td></tr>';switch(params.type){case'header':return'<p>'+params.instructions+'</p>';break;case'start':return table+th+row.replace(/%1/,params.instructions);break;case'step':return row.replace(/%1/,params.instructions);break;case'end':return row.replace(/%1/,params.instructions)+'</table>';break;case'waypoint':return table+th+row.replace(/%1/,params.instructions)+'</table>';default:return;}};Segment.prototype.cuesheetOut=function(){var list='';var acc_distance=0;var route=this.directionsRenderer.getDirections().routes[0];var leg=null;var step=null;var step_next=0;var params={metric:this.options.map.options.metric,header:this.options.map.options.cuesheet_header,type:'header',index:0,distance:0,step:0,instructions:''};params.instructions=route.copyrights;list=this.cueLine(params);for(var i=0;i<route.warnings.length;i++){params.instructions=route.warnings[i];list+=this.cueLine(params);}
for(var leg_index=0;leg_index<route.legs.length;leg_index++){leg=route.legs[leg_index];params.type='start';params.distance=0;params.step=0;params.instructions=leg.start_address;list+=this.cueLine(params);params.type='step';for(var step_index=0;step_index<leg.steps.length;step_index++){step=leg.steps[step_index];params.index=step_index+1;params.distance=acc_distance;params.step=step_next;params.instructions=step.instructions;list+=this.cueLine(params);if(step.distance){step_next=step.distance.value;acc_distance+=step.distance.value}}
params.type='end';params.distance=acc_distance;params.step=step_next;params.instructions=leg.end_address;list+=this.cueLine(params);}
try{this.options.map.html['cuesheet-dialog'].dialog('isOpen');}catch(err){this.cuesheetDialog();}
this.options.map.html['cuesheet-dialog'].find('.cuesheet').val(list);};Segment.prototype.cuesheetDirections=function(){var segment=this;if(this.directionsRenderer&&this.directionsRenderer.getMap()){this.cuesheetKill();return;}
if(!this.directionsService){this.directionsService=new google.maps.DirectionsService();}
if(!this.directionsRenderer){this.directionsRenderer=new google.maps.DirectionsRenderer(this.getDirRenderOptions({}));google.maps.event.addListener(this.directionsRenderer,"directions_changed",function(){segment.cuesheetOut();});}
var waypoints=[];var path=this.line.getPath();var first=path.getAt(0);var last=path.getAt(path.getLength()-1);options={'waypoints':waypoints.length>0?waypoints:null,'destination':last,'origin':first};this.directionsService.route(this.getDirRequestOptions(options),function(response,status){if(status===google.maps.DirectionsStatus.OK){segment.directionsRenderer.setMap(segment.options.map.googlemap);segment.directionsRenderer.setDirections(response);}else{segment.options.map.alert(status);}});};Segment.prototype.findWaypoints=function(){var waypoints=[];for(var pid in this.options.file.placemarks){var wp=this.options.file.placemarks[pid];if(wp.options.symbol==='Waypoint'){var pos=wp.options.position;var points=this.line.getPath().getArray();for(var i=0;i<points.length;i++){if(pos.equals(points[i])){waypoints.push({'pid':pid,'latlng':pos,'index':i});break;}}}}
waypoints.sort(function(a,b){return a.index-b.index;});return waypoints;};Segment.prototype.copyWaypoints=function(clipboard){var waypoints=this.findWaypoints();for(var i=0;i<waypoints.length;i++){clipboard.push(this.options.file.placemarks[waypoints[i].pid].copy());}};Segment.prototype.removeWaypoints=function(){var waypoints=this.findWaypoints();for(var i=0;i<waypoints.length;i++){this.options.file.placemarks[waypoints[i].pid].remove();}};Segment.prototype.cueUpdateWaypoints=function(route){var options={url:'',symbol:'Waypoint',name:null,desc:null,position:null,visible:true};var acc_distance=0;var leg=null;var step_next=0;for(var leg_index=0;leg_index<route.legs.length;leg_index++){leg=route.legs[leg_index];options.position=this.nearestPoint(leg.start_location).latLng;options.desc='Start - '+leg.start_address;options.name=this.options.sid+' 1000';this.options.file.addPlacemark(options);var params={type:'waypoint'};for(var step_index=0;step_index<leg.steps.length;step_index++){var step=leg.steps[step_index];params.distance=acc_distance;params.step=step_next;params.instructions=step.instructions;options.desc=this.cueLine(params);options.position=this.nearestPoint(step.start_location).latLng;options.name=this.options.sid+' '+(step_index+1001);this.options.file.addPlacemark(options);if(step.distance){step_next=step.distance.value;acc_distance+=step.distance.value;}}
params.distance=acc_distance;params.step=step_next;params.instructions=leg.end_address;options.desc=this.cueLine(params);options.position=this.nearestPoint(leg.end_location).latLng;options.name=this.options.sid+' '+(step_index+1002);this.options.file.addPlacemark(options);}};Segment.prototype.cueUpdatePath=function(){if(this.directionsRenderer&&this.directionsRenderer.getMap()){this.removeWaypoints();var route=this.directionsRenderer.getDirections().routes[0];this.line.setPath(route.overview_path);this.cueUpdateWaypoints(route);this.options.desc=this.options.map.html['cuesheet-dialog'].find('.cuesheet').val()
this.options.file.setDirty(true);this.refresh();}
this.options.desc=this.options.map.html['cuesheet-dialog'].find('.cuesheet').val();};Segment.prototype.cuesheetWaypoints=function(){var waypoints=this.findWaypoints();var list='<table>';list+='<tr><th>&nbsp;Step&nbsp;</th><th></th><th>&nbsp;Trip&nbsp;</th><th></th><th>Instructions</th></tr>';for(var i=0;i<waypoints.length;i++){var line=this.options.file.placemarks[waypoints[i].pid].options.desc;var lines=line.split('</tr>');if(lines.length>1){var start=lines[1].indexOf('<tr>');if(start>-1){var end=line.indexOf('</table>')-1;line=lines[1].substr(start,end-start);list+=line+'</tr>';}else{list+=line;}}else{list+=line;}}
list+='</table>';this.options.map.html['cuesheet-dialog'].find('.cuesheet').val(list);try{this.options.map.html['cuesheet-dialog'].dialog('isOpen');}catch(err){this.cuesheetDialog();}};Segment.prototype.edit=function(){this.segmentDialog();};})(jQuery);
function XMLWriter(encoding,version){if(encoding)
this.encoding=encoding;if(version)
this.version=version;};(function(){function clean(node){var l=node.c.length;while(l--){if(typeof node.c[l]=='object')
clean(node.c[l]);}
node.n=node.a=node.c=null;};function format(node,indent,chr,buffer){var
xml=indent+'<'+node.n,nc=node.c.length,attr,child,i=0;for(attr in node.a)
xml+=' '+attr+'="'+node.a[attr]+'"';xml+=nc?'>':' />';buffer.push(xml);if(nc){do{child=node.c[i++];if(typeof child=='string'){if(nc==1)
return buffer.push(buffer.pop()+child+'</'+node.n+'>');else
buffer.push(indent+chr+child);}else if(typeof child=='object')
format(child,indent+chr,chr,buffer);}while(i<nc);buffer.push(indent+'</'+node.n+'>');}}
XMLWriter.prototype={encoding:'ISO-8859-1',version:'1.0',formatting:'indented',indentChar:' ',indentation:2,newLine:'\n',writeStartDocument:function(standalone){this.close();this.stack=[];this.standalone=standalone;},writeEndDocument:function(){this.active=this.root;this.stack=[];},writeDocType:function(dt){this.doctype=dt;},writeStartElement:function(name,ns){if(ns)
name=ns+':'+name;var node={n:name,a:{},c:[]};if(this.active){this.active.c.push(node);this.stack.push(this.active);}else
this.root=node;this.active=node;},writeEndElement:function(){this.active=this.stack.pop()||this.root;},writeAttributeString:function(name,value){if(this.active)
this.active.a[name]=value;},writeString:function(text){if(this.active)
this.active.c.push(text);},writeElementString:function(name,text,ns){this.writeStartElement(name,ns);this.writeString(text);this.writeEndElement();},writeCDATA:function(text){this.writeString('<![CDATA['+text+']]>');},writeComment:function(text){this.writeString('<!-- '+text+' -->');},flush:function(){if(this.stack&&this.stack[0])
this.writeEndDocument();var
chr='',indent='',num=this.indentation,formatting=this.formatting.toLowerCase()=='indented',buffer='<?xml version="'+this.version+'" encoding="'+this.encoding+'"';if(this.standalone!==undefined)
buffer+=' standalone="'+!!this.standalone+'"';buffer+=' ?>';buffer=[buffer];if(this.doctype&&this.root)
buffer.push('<!DOCTYPE '+this.root.n+' '+this.doctype+'>');if(formatting){while(num--)
chr+=this.indentChar;}
if(this.root)
format(this.root,indent,chr,buffer);return buffer.join(formatting?this.newLine:'');},close:function(){if(this.root)
clean(this.root);this.active=this.root=this.stack=null;},getDocument:window.ActiveXObject?function(){var doc=new ActiveXObject('Microsoft.XMLDOM');doc.async=false;doc.loadXML(this.flush());return doc;}:function(){return(new DOMParser()).parseFromString(this.flush(),'text/xml');}};})();